<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enbreak | Test Diagn√≥stico</title>
    <link rel="icon" type="image/x-icon" href="../../favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="../../favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../favicon/apple-touch-icon.png">
    <link rel="manifest" href="../../favicon/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/css/flag-icons.min.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Rubik:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .page-header {
    position: relative;
    width: 100%;
    background: #ffffff;
    border-bottom: 1px solid #d2d2d2;
}

.page-header::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 55%;
    height: 100%;
    background: url('../../assets/banners/banner4.jpeg') left 40% / cover no-repeat;
    filter: contrast(1.05) brightness(1.15);
    opacity: 0.45;
    pointer-events: none;
    mask-image: linear-gradient(to left,
        rgba(0,0,0,1) 0%,
        rgba(0,0,0,0.9) 70%,
        rgba(0,0,0,0) 100%);
    -webkit-mask-image: linear-gradient(to left,
        rgba(0,0,0,1) 0%,
        rgba(0,0,0,0.9) 70%,
        rgba(0,0,0,0) 100%);
    animation: bannerImageSlideIn 1s ease-out;
}

.page-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 60%;
    height: 100%;
    background: linear-gradient(to left,
        transparent 0%,
        rgba(255, 255, 255, 0.05) 50%,
        rgba(255, 255, 255, 0.2) 100%);
    pointer-events: none;
    z-index: 1;
}

.page-header-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    min-height: 140px;
    position: relative;
    display: flex;
    align-items: center;
}

.page-header-content {
    padding: 30px 40px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 8px;
    position: relative;
    z-index: 1;
    max-width: 520px;
    animation: bannerTextSlideIn 1s ease-out;
}

.page-header-image {
    display: none;
}

.page-header-accent {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 60px;
    background: #ff6600;
    z-index: 2;
}

.page-header .breadcrumb {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
}

.page-header .breadcrumb a {
    color: #6b7280;
    text-decoration: none;
    transition: color 0.2s ease;
}

.page-header .breadcrumb a:hover {
    color: #ff6600;
}

.page-header .breadcrumb-separator {
    color: #d1d5db;
    font-size: 9px;
}

.page-header .breadcrumb-current {
    color: #374151;
    font-weight: 500;
}

.page-header h1 {
    font-family: 'Rubik', sans-serif;
    font-size: 32px;
    font-weight: 700;
    color: #0a1e42;
    margin: 0;
    line-height: 1.2;
}

/* Responsive */
@media (max-width: 768px) {
    .page-header {
        background: #ffffff;
    }

    .page-header::after {
        display: none;
    }

    .page-header-wrapper {
        min-height: auto;
    }

    .page-header-content {
        padding: 24px 20px;
    }

    .page-header h1 {
        font-size: 24px;
    }
}

/* Banner animations */
@keyframes bannerTextSlideIn {
    from {
        opacity: 0;
        transform: translateX(-60px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes bannerImageSlideIn {
    from {
        opacity: 0;
        transform: translateX(40px);
    }
    to {
        opacity: 0.45;
        transform: translateX(0);
    }
}

.test-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

.test-card {
    max-width: 850px;
    margin: 0 auto;
    padding: 40px;
    background: #ffffff;
    border-radius: 24px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
}

.test-screen {
    display: none;
    animation: fadeIn 0.3s ease;
}

.test-screen.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.intro-content {
    text-align: center;
    max-width: 100%;
    margin: 0 auto;
}

.intro-layout {
    display: flex;
    gap: 40px;
    align-items: center;
    margin-bottom: 40px;
}

.cefr-graphic {
    flex: 0 0 350px;
}

.cefr-graphic img {
    width: 100%;
    height: auto;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.intro-text {
    flex: 1;
    text-align: justify;
}

.intro-text p {
    font-size: 16px;
    color: #4b5563;
    margin-bottom: 16px;
    line-height: 1.7;
    text-align: justify;
}

.intro-text p:last-child {
    margin-bottom: 0;
}

.intro-section {
    text-align: left;
    background: #ffffff;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.intro-section h3 {
    font-family: 'Rubik', sans-serif;
    font-size: 18px;
    color: #0a1e42;
    margin-bottom: 12px;
}

.intro-section ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.intro-section li {
    padding: 8px 0 8px 28px;
    position: relative;
    color: #4b5563;
    line-height: 1.6;
}

.intro-section li::before {
    content: '‚úì';
    position: absolute;
    left: 0;
    color: #10b981;
    font-weight: 700;
}

.intro-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.intro-grid .intro-section {
    margin-bottom: 0;
}

@media (max-width: 768px) {
    .intro-grid {
        grid-template-columns: 1fr;
    }

    .test-card {
        padding: 24px 20px;
    }
}

.intro-footer {
    font-size: 16px;
    color: #6b7280;
    font-style: italic;
    margin: 30px 0;
}

.btn-start {
    background: #ff6600;
    color: white;
    border: none;
    padding: 16px 48px;
    font-size: 18px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-start:hover {
    background: #e55b00;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3);
}

.test-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e5e7eb;
}

.level-badge {
    background: #ff6600;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 14px;
}

.progress-bar {
    flex: 1;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #059669);
    transition: width 0.3s ease;
    width: 0%;
}

.question-counter {
    font-weight: 600;
    color: #6b7280;
}

.question-content {
    margin-bottom: 30px;
}

.question-text {
    font-family: 'Rubik', sans-serif;
    font-size: 20px; 
    color: #0a1e42;
    margin-bottom: 24px;
    line-height: 1.5;
}

.question-blank {
    display: inline-block;
    min-width: 80px;
    border-bottom: 2px solid #0a1e42;
    margin: 0 8px;
    height: 1.1em;
    vertical-align: baseline;
    text-align: center;
}

.options-container {
    display: grid;
    gap: 12px;
}

.option-btn {
    background: white;
    border: 2px solid #e5e7eb;
    padding: 16px 20px;
    text-align: left;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 16px;
    color: #374151;
}

.option-btn:hover {
    border-color: #ff6600;
    background: #fff7ed;
}

.option-btn.selected {
    border-color: #ff6600;
    background: #fff7ed;
    font-weight: 600;
}

.option-btn.correct {
    border-color: #10b981;
    background: #ecfdf5;
}

.option-btn.incorrect {
    border-color: #ef4444;
    background: #fef2f2;
}

.test-actions {
    display: flex;
    justify-content: flex-end;
}

.btn-next {
    background: #ff6600;
    color: white;
    border: none;
    padding: 12px 32px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-next:hover:not(:disabled) {
    background: #e55b00;
}

.btn-next:disabled {
    background: #d1d5db;
    cursor: not-allowed;
}

.result-content {
    text-align: center;
    max-width: 600px;
    margin: 0 auto;
}

.result-icon {
    font-size: 64px;
    margin-bottom: 16px;
}

.result-content h2 {
    font-family: 'Rubik', sans-serif;
    font-size: 26px;
    color: #0a1e42;
    margin-bottom: 24px;
}

.score-display {
    margin: 32px 0;
}

.score-circle {
    width: 140px;
    height: 140px;
    margin: 0 auto;
    position: relative;
}

.score-circle svg {
    width: 100%;
    height: 100%;
}

.score-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 36px;
    font-weight: 700;
    color: #0a1e42;
}

.result-message {
    font-size: 18px;
    color: #4b5563;
    margin-bottom: 30px;
    line-height: 1.6;
}

.result-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
}

.btn-continue {
    background: #10b981;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-continue:hover {
    background: #059669;
}

.btn-primary {
    background: #ff6600;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary:hover {
    background: #e55b00;
}

.btn-secondary {
    background: white;
    color: #374151;
    border: 2px solid #e5e7eb;
    padding: 12px 24px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-secondary:hover {
    border-color: #9ca3af;
}

.btn-certificate {
    background: linear-gradient(135deg, #0a1e42, #1a3a6e);
    color: white;
    border: none;
    padding: 14px 28px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 10px;
}

.btn-certificate:hover {
    background: linear-gradient(135deg, #1a3a6e, #0a1e42);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(10, 30, 66, 0.3);
}

.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    background: white;
    padding: 40px;
    border-radius: 16px;
    max-width: 450px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-content h3 {
    font-family: 'Rubik', sans-serif;
    font-size: 24px;
    color: #0a1e42;
    margin-bottom: 10px;
    text-align: center;
}

.modal-content p {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 24px;
    text-align: center;
}

.modal-content input {
    width: 100%;
    padding: 12px 16px;
    font-size: 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 24px;
    font-family: 'Inter', sans-serif;
    transition: border-color 0.2s ease;
}

.modal-content input:focus {
    outline: none;
    border-color: #ff6600;
}

.modal-actions {
    display: flex;
    gap: 12px;
}

.modal-actions button {
    flex: 1;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-modal-confirm {
    background: #ff6600;
    color: white;
    border: none;
}

.btn-modal-confirm:hover {
    background: #e55b00;
}

.btn-modal-cancel {
    background: white;
    color: #374151;
    border: 2px solid #e5e7eb;
}

.btn-modal-cancel:hover {
    border-color: #9ca3af;
}


.no-certificate-message {
    color: #6b7280;
    font-style: italic;
    font-size: 14px;
    margin: 0;
    padding: 12px 20px;
    background: #f3f4f6;
    border-radius: 8px;
}

.btn-abandon {
    background: #ef4444;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-abandon:hover {
    background: #dc2626;
}

.final-content {
    max-width: 700px;
    margin: 0 auto;
    text-align: center;
}

.final-content h2 {
    font-family: 'Rubik', sans-serif;
    font-size: 32px;
    color: #0a1e42;
    margin-bottom: 30px;
}

.final-level {
    margin-bottom: 40px;
}

.level-badge-large {
    display: inline-block;
    background: linear-gradient(135deg, #ff6600, #ff8c00);
    color: white;
    padding: 20px 40px;
    border-radius: 16px;
    font-size: 48px;
    font-weight: 700;
    margin-bottom: 16px;
}

#final-level-description {
    font-size: 18px;
    color: #4b5563;
    line-height: 1.6;
}

.scores-summary {
    background: #f8f9fa;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    border: 1px solid #e5e7eb;
}

.scores-summary h3 {
    font-family: 'Rubik', sans-serif;
    font-size: 20px;
    color: #0a1e42;
    margin-bottom: 20px;
}

#scores-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.score-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: white;
    border-radius: 8px;
}

.score-item-level {
    font-weight: 600;
    color: #0a1e42;
}

.score-item-score {
    font-weight: 700;
    color: #10b981;
}

.final-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
}

.review-content {
    max-width: 800px;
    margin: 0 auto;
}

.review-content h2 {
    font-family: 'Rubik', sans-serif;
    font-size: 32px;
    color: #0a1e42;
    margin-bottom: 30px;
    text-align: center;
}

.review-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    flex-wrap: wrap;
    justify-content: center;
}

.review-tab {
    background: white;
    border: 2px solid #e5e7eb;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    color: #6b7280;
    transition: all 0.2s ease;
}

.review-tab:hover {
    border-color: #ff6600;
    color: #ff6600;
}

.review-tab.active {
    background: #ff6600;
    border-color: #ff6600;
    color: white;
}

#review-container {
    margin-bottom: 30px;
}

.review-question {
    background: #f8f9fa;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 20px;
    border: 1px solid #e5e7eb;
}

.review-question-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
}

.review-level-badge {
    background: #ff6600;
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
}

.review-question-number {
    font-weight: 600;
    color: #6b7280;
}

.review-question-text {
    font-size: 18px;
    color: #0a1e42;
    margin-bottom: 16px;
    font-weight: 600;
}

.review-option {
    padding: 12px 16px;
    margin: 8px 0;
    border-radius: 8px;
    background: white;
    border: 2px solid #e5e7eb;
}

.review-option.user-answer {
    border-color: #ff6600;
    background: #fff7ed;
}

.review-option.correct-answer {
    border-color: #10b981;
    background: #ecfdf5;
}

.review-option.wrong {
    border-color: #ef4444;
    background: #fef2f2;
}

@media (max-width: 768px) {
    .intro-layout {
        flex-direction: column;
        gap: 24px;
    }

    .cefr-graphic {
        flex: 0 0 auto;
        width: 100%;
    }

    .intro-text {
        text-align: center;
    }

    .question-text {
        font-size: 18px;
    }

    .test-header {
        flex-wrap: wrap;
    }

    .level-badge-large {
        font-size: 36px;
        padding: 16px 32px;
    }

    .result-actions,
    .final-actions {
        flex-direction: column;
    }

    .btn-continue,
    .btn-primary,
    .btn-secondary {
        width: 100%;
    }

    .review-tabs {
        gap: 6px;
    }

    .review-tab {
        flex: 1 1 auto;
        min-width: 80px;
        padding: 8px 12px;
        font-size: 14px;
    }
}
    </style>
</head>
<body>

    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Banner Section -->
    <main style="padding: 0; margin: 0;">
        <section class="page-header">
            <div class="page-header-wrapper">
                <div class="page-header-content">
                    <div class="page-header-accent"></div>
                    <nav class="breadcrumb">
                        <a href="/">Inicio</a>
                        <span class="breadcrumb-separator">‚Ä∫</span>
                        <span class="breadcrumb-current">Test</span>
                    </nav>
                    <h1>Test Di√°gnostico</h1>
                </div>
            </div>
        </section>

        <section style="padding: 80px 0; background: #f8f9fa;">
            <div class="test-container">
            <div id="intro-screen" class="test-screen active">
                <div class="intro-content">
                    <div class="intro-layout">
                        <div class="cefr-graphic">
                            <img src="../../assets/panels/CEFR.png" alt="Niveles CEFR" />
                        </div>
                        <div class="intro-text">
                            <p>Antes de comenzar, es importante que conozcas c√≥mo se mide tu nivel de ingl√©s en este test.</p>
                            <p>Esta evaluaci√≥n est√° basada en el <strong>Marco Com√∫n Europeo de Referencia para las Lenguas (CEFR)</strong>, un est√°ndar internacional que clasifica el dominio del idioma en niveles que van desde <strong>A1</strong> (principiante) hasta <strong>C2</strong> (avanzado).</p>
                            <p>El objetivo de este test es identificar en qu√© nivel te encuentras actualmente.</p>
                        </div>
                    </div>

                    <div class="intro-grid">
                        <div class="intro-section">
                            <h3>¬øC√≥mo funciona el test diagn√≥stico?</h3>
                            <ul>
                                <li>Responder√°s 12 preguntas por nivel, empezando por A1 y terminando en C1.</li>
                                <li>Necesitas 9 respuestas correctas (75%) para avanzar al siguiente nivel.</li>
                                <li>Si no obtienes 75%, el test termina y tu nivel de ingl√©s es identificado.</li>
                                <li>El nivel m√°ximo a obtener en este test es C1.</li>
                            </ul>
                        </div>

                        <div class="intro-section">
                            <h3>Consejos antes de empezar:</h3>
                            <ul>
                                <li>Busca un lugar tranquilo y sin distracciones</li>
                                <li>Responde con honestidad, sin buscar ayuda externa</li>
                                <li>Si no sabes una respuesta, ve con tu instinto</li>
                                <li>El test toma aproximadamente 5 minutos por nivel</li>
                            </ul>
                        </div>
                    </div>

                    <p class="intro-footer">¬øListo para conocer tu nivel?</p>

                    <button class="btn-start" onclick="startTest()">Comenzar Test</button>
                </div>
            </div>

            <div id="question-screen" class="test-screen">
                <div class="test-card">
                <div class="test-header">
                    <div class="level-badge">
                        <span id="current-level-badge">A1</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <div class="question-counter">
                        <span id="question-number">1</span>/<span id="total-questions">10</span>
                    </div>
                </div>

                <div class="question-content">
                    <h3 id="question-text" class="question-text"></h3>
                    <div id="options-container" class="options-container"></div>
                </div>

                <div class="test-actions">
                    <button id="next-btn" class="btn-next" onclick="nextQuestion()" disabled>Siguiente</button>
                </div>
                </div>
            </div>

            <div id="level-result-screen" class="test-screen">
                <div class="test-card">
                    <div class="result-content">
                    <div id="result-icon" class="result-icon"></div>
                    <h2 id="result-title"></h2>
                    <div class="score-display">
                        <div class="score-circle">
                            <svg viewBox="0 0 120 120">
                                <circle cx="60" cy="60" r="54" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                                <circle id="score-progress" cx="60" cy="60" r="54" fill="none" stroke="#10b981" stroke-width="8" stroke-dasharray="339.292" stroke-dashoffset="339.292" transform="rotate(-90 60 60)"/>
                            </svg>
                            <div class="score-text">
                                <span id="score-percentage">0</span>%
                            </div>
                        </div>
                    </div>
                    <p id="result-message" class="result-message"></p>
                    <div class="result-actions">
                        <button class="btn-secondary" onclick="showLevelReview()">Revisar Respuestas</button>
                        <button id="continue-btn" class="btn-continue" onclick="continueToNextLevel()"></button>
                        <button id="abandon-btn" class="btn-abandon" onclick="abandonTest()" style="display: none;">Abandonar Test</button>
                    </div>
                    </div>
                </div>
            </div>

            <div id="final-result-screen" class="test-screen">
                <div class="test-card">
                <div class="final-content">
                    <h2>Evaluaci√≥n de tu Nivel de Ingl√©s</h2>
                    <div class="final-level">
                        <div class="level-badge-large">
                            <span id="final-level-text">A1</span>
                        </div>
                        <p id="final-level-description"></p>
                    </div>

                    <div class="scores-summary">
                        <h3>Desglose de Puntuaciones</h3>
                        <div id="scores-list"></div>
                    </div>

                    <div class="final-actions">
                        <button id="certificate-btn" class="btn-certificate" onclick="showNameModal()"><i class="fas fa-download"></i> Descargar Certificado</button>
                        <p id="no-certificate-msg" class="no-certificate-message" style="display: none;">El certificado est√° disponible a partir del nivel A1. ¬°Sigue practicando!</p>
                        <button class="btn-secondary" onclick="showReview()">Revisar Respuestas</button>
                    </div>
                </div>
                </div>
            </div>

            <div id="review-screen" class="test-screen">
                <div class="test-card">
                <div class="review-content">
                    <h2>Revisi√≥n de Respuestas</h2>
                    <div id="review-tabs" class="review-tabs"></div>
                    <div id="review-container"></div>
                    <div style="text-align: center;">
                        <button class="btn-secondary" onclick="backFromReview()">Volver</button>
                    </div>
                </div>
                </div>
            </div>
            </div>
        </section>
    </main>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Name Modal -->
    <div id="name-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Descargar Certificado</h3>
            <p>Por favor, ingresa tu nombre completo tal como deseas que aparezca en el certificado.</p>
            <input type="text" id="student-name-input" placeholder="Ej: Mar√≠a Garc√≠a L√≥pez" maxlength="50">
            <div class="modal-actions">
                <button class="btn-modal-cancel" onclick="closeNameModal()">Cancelar</button>
                <button class="btn-modal-confirm" onclick="confirmDownload()">Descargar</button>
            </div>
        </div>
    </div>


<script src="../../js/layout.js"></script>
<script src="../../js/script.js" defer></script>
<script>
const LEVELS = ['A1', 'A2', 'B1', 'B2', 'C1'];
const PASS_THRESHOLD = 75;
const LEVEL_ZERO = 'A0';

const questionBank = {
  A1: [
    { q: "How do you go to work?", options: ["By bus.", "In a train station.", "Five days a week."], correct: 0 },
    { q: "What time does the class start?", options: ["For two hours.", "At nine o'clock.", "On Monday."], correct: 1 },
    { q: "Can I borrow your pen?", options: ["Yes, I have.", "Yes, I can.", "Yes, here you are."], correct: 2 },
    { q: "How often do you visit your family?", options: ["Every month.", "In my hometown.", "Last weekend."], correct: 0 },
    { q: "How much is this shirt?", options: ["It's very nice.", "It's fifteen dollars.", "It's medium size."], correct: 1 },
    { q: "When do you study?", options: ["In my room.", "Half an hour.", "At noon."], correct: 2 },
    { q: "Choose the correct sentence:", options: ["She goes to school every day.", "She go to school every day.", "She going to school every day."], correct: 0 },
    { q: "Choose the correct sentence:", options: ["There is three cats in the garden.", "There are three cats in the garden.", "There have three cats in the garden."], correct: 1 },
    { q: "Choose the correct sentence:", options: ["I can to swim very well.", "I can swimming very well.", "I can swim very well."], correct: 2 },
    { q: "My sister <blank></blank> a doctor.", options: ["am", "is", "are"], correct: 1 },
    { q: "I <blank></blank> like coffee.", options: ["do not", "does not", "am not"], correct: 0 },
    { q: "<blank></blank> do you live?", options: ["What", "Who", "Where"], correct: 2 }
  ],
  A2: [
    { q: "What did you do last weekend?", options: ["I went to the museum.", "I go to the mountain.", "I've been to the beach."], correct: 0 },
    { q: "How was your vacation?", options: ["I traveled to Brazil.", "It was amazing.", "I stayed for three weeks."], correct: 1 },
    { q: "Can you come to my party on Saturday?", options: ["Sorry, I can work.", "Sorry, I may work.", "Sorry, I have to work."], correct: 2 },
    { q: "Have you ever been to Italy?", options: ["Yes, twice.", "Yes, I went.", "Yes, I will."], correct: 0 },
    { q: "What are your plans for the summer?", options: ["I went to London.", "I don't have any.", "I've visited my friends."], correct: 1 },
    { q: "How long have you lived in this city?", options: ["By 2020.", "In 2020.", "Since 2020."], correct: 2 },
    { q: "Choose the correct sentence:", options: ["She is taller than her sister.", "She is more tall than her sister.", "She is more taller than her sister."], correct: 0 },
    { q: "Choose the correct sentence:", options: ["Employees must washing their hands.", "Employees must wash their hands.", "Employees must to wash their hands."], correct: 1 },
    { q: "Choose the correct sentence:", options: ["We going to travel next month.", "We go to travel next month.", "We are going to travel next month."], correct: 2 },
    { q: "I <blank></blank> this course twice this year.", options: ["have taken", "took", "have take"], correct: 0 },
    { q: "There isn't <blank></blank> milk in the fridge.", options: ["some", "any", "many"], correct: 1 },
    { q: "She is the <blank></blank> person I know.", options: ["fast", "faster", "fastest"], correct: 2 }
  ],
  B1: [
    { q: "What did the doctor tell you?", options: ["She said I should rest for a few days.", "She said I shall rest for a few days.", "She said I have to resting for a few days."], correct: 0 },
    { q: "What would you do if you found a wallet on the street?", options: ["I will take it to the police.", "I would take it to the police.", "I took it to the police."], correct: 1 },
    { q: "Why didn't you answer my call last night?", options: ["Sorry, I already went to bed.", "Sorry, I have already gone to bed.", "Sorry, I had already gone to bed."], correct: 2 },
    { q: "How was the exam?", options: ["Difficult. I didn't have enough time to finish.", "Difficult. I didn't have time enough to finish.", "Difficult. I didn't have too time to finish."], correct: 0 },
    { q: "Do you know what happened to the old factory?", options: ["It demolished last year.", "It was demolished last year.", "It has been demolished last year."], correct: 1 },
    { q: "Will you come to the party on Saturday?", options: ["Yes, if I won't have to work.", "Yes, if I didn't have to work.", "Yes, if I don't have to work."], correct: 2 },
    { q: "Choose the correct sentence:", options: ["He drives more carefully than his brother.", "He drives more careful than his brother.", "He drives carefuller than his brother."], correct: 0 },
    { q: "Choose the correct sentence:", options: ["By the time we arrived, the concert already finished.", "By the time we arrived, the concert had already finished.", "By the time we arrived, the concert has already finished."], correct: 1 },
    { q: "Choose the correct sentence:", options: ["If I would know the answer, I would tell you.", "If I know the answer, I would tell you.", "If I knew the answer, I would tell you."], correct: 2 },
    { q: "The documents <blank></blank> to all employees yesterday.", options: ["were sent", "are sent", "have been sent"], correct: 0 },
    { q: "We had to <blank></blank> the meeting until next week.", options: ["put off", "turn down", "carry out"], correct: 0 },
    { q: "I couldn't concentrate. There was <blank></blank> noise.", options: ["too many", "too much", "enough"], correct: 1 }
  ],
  B2: [
    { q: "What would you have done if you'd missed your flight?", options: ["I would have taken the next available one.", "I will take the next available one.", "I would take the next available one."], correct: 0 },
    { q: "Why do you think James didn't reply to your email?", options: ["He should have been too busy.", "He must have been too busy.", "He would have been too busy."], correct: 1 },
    { q: "What did the lawyer advise you to do?", options: ["He recommended that I will contest the decision.", "He recommended me to contest the decision.", "He recommended that I contest the decision."], correct: 2 },
    { q: "How did you manage to finish the report so quickly?", options: ["Having worked on similar projects before, I knew exactly what to do.", "To work on similar projects before, I knew exactly what to do.", "Working on similar projects before, I know exactly what to do."], correct: 0 },
    { q: "Your computer is working perfectly now. What happened?", options: ["I repaired it at the shop.", "I had it repaired at the shop.", "I have repaired it at the shop."], correct: 1 },
    { q: "Tell me about the conference you attended last week.", options: ["It was an event which I learned a great deal from it.", "It was an event what I learned a great deal from.", "It was an event from which I learned a great deal."], correct: 2 },
    { q: "She looks so exhausted. She <blank></blank> slept well.", options: ["can't have", "must have", "might not have"], correct: 0 },
    { q: "I'm so sorry I missed your call. I <blank></blank> my phone on silent.", options: ["would have left", "must have left", "should have left"], correct: 1 },
    { q: "I wish I <blank></blank> to her advice. Now I regret it.", options: ["would have listened", "could have listened", "had listened"], correct: 2 },
    { q: "Choose the correct sentence:", options: ["The manuscript is believed to have been written in the 15th century.", "The manuscript is believed to be written in the 15th century.", "The manuscript is believed to been written in the 15th century."], correct: 0 },
    { q: "Choose the correct sentence:", options: ["Seldom I have encountered such rudeness.", "Seldom have I encountered such rudeness.", "Seldom have encountered I such rudeness."], correct: 1 },
    { q: "Choose the correct sentence:", options: ["If I would have studied harder, I would have passed the exam.", "If I had studied harder, I will have passed the exam.", "If I had studied harder, I would have passed the exam."], correct: 2 }
  ],
  C1: [
    { q: "I can't believe you managed to finish the entire project in just two days!", options: ["Had I known how demanding it would be, I wouldn't have accepted it.", "The deadline has been extended until next Friday.", "I haven't actually begun the research phase yet."], correct: 0 },
    { q: "The merger talks have collapsed. What went wrong?", options: ["The stock price has recovered surprisingly quickly.", "What caused the breakdown was disagreement over management control.", "We should schedule a meeting with the legal team."], correct: 1 },
    { q: "Sarah hasn't been herself lately. Have you noticed anything?", options: ["She's scheduled to lead the next quarterly review.", "Her presentation at the conference was excellent.", "She may well be dealing with some family issues."], correct: 2 },
    { q: "Why did the committee reject your proposal outright?", options: ["Not having consulted them earlier, I misjudged their priorities.", "I'll be submitting a revised version next month.", "The budget allocation was approved unanimously."], correct: 0 },
    { q: "What's your assessment of the political pressure facing the minister?", options: ["The opposition has tabled a motion of no confidence.", "Rarely have I seen a politician under such intense scrutiny.", "The prime minister has publicly reaffirmed her support."], correct: 1 },
    { q: "What's your view on the government's climate strategy?", options: ["The legislation was passed with cross-party support.", "Renewable energy investment has doubled this year.", "The measures would appear to be rather insufficient."], correct: 2 },
    { q: "The contract will be renewed next year, <blank></blank> any unforeseen circumstances.", options: ["notwithstanding", "regarding", "concerning"], correct: 0 },
    { q: "Given his experience in the field, he <blank></blank> be the best candidate for the position.", options: ["may good", "may well", "may much"], correct: 1 },
    { q: "It is imperative that every employee <blank></blank> the new safety protocols.", options: ["follows", "will follow", "follow"], correct: 2 },
    { q: "Choose the correct sentence:", options: ["It was the lack of preparation that caused the project to fail.", "It was the lack of preparation what caused the project to fail.", "It was the lack of preparation which it caused the project to fail."], correct: 0 },
    { q: "Choose the correct sentence:", options: ["Should you will need assistance, please contact our support team.", "Should you need assistance, please contact our support team.", "Should you to need assistance, please contact our support team."], correct: 1 },
    { q: "Choose the correct sentence:", options: ["The theory is considering to be one of the most influential.", "The theory is considered being one of the most influential.", "The theory is considered to be one of the most influential."], correct: 2 }
  ]
};

let state = {
  currentLevel: 0,
  currentQuestion: 0,
  answers: [],
  scores: {},
  finalLevel: null,
  shuffledQuestions: {},
  allAnswers: {},
  returnScreen: null,
  testCompleted: false
};

// Prevent page abandon warning
window.addEventListener('beforeunload', function (e) {
  if (!state.testCompleted && (state.currentLevel > 0 || state.currentQuestion > 0)) {
    e.preventDefault();
    e.returnValue = '¬øEst√°s seguro de que quieres salir? Perder√°s todo tu progreso.';
    return e.returnValue;
  }
});

function shuffleArray(array) {
  const newArray = [...array];
  for (let i = newArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  return newArray;
}

function getShuffledQuestions(level) {
  if (!state.shuffledQuestions[level]) {
    state.shuffledQuestions[level] = shuffleArray(questionBank[level]);
  }
  return state.shuffledQuestions[level];
}

function showScreen(screenId) {
  document.querySelectorAll('.test-screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
  window.scrollTo(0, 0);
}

function startTest() {
  state.currentLevel = 0;
  state.currentQuestion = 0;
  state.answers = [];
  state.scores = {};
  state.finalLevel = null;
  state.shuffledQuestions = {};
  state.allAnswers = {};
  state.testCompleted = false;
  loadQuestion();
  showScreen('question-screen');
}

function loadQuestion() {
  const level = LEVELS[state.currentLevel];
  const questions = getShuffledQuestions(level);
  const question = questions[state.currentQuestion];

  document.getElementById('current-level-badge').textContent = level;
  document.getElementById('question-number').textContent = state.currentQuestion + 1;
  document.getElementById('total-questions').textContent = questions.length;
  
  // Process question text to replace <blank> tags with styled spans
  const questionHTML = question.q.replace(/<blank><\/blank>/g, '<span class="question-blank"></span>');
  document.getElementById('question-text').innerHTML = questionHTML;

  const progress = ((state.currentQuestion + 1) / questions.length) * 100;
  document.getElementById('progress-fill').style.width = progress + '%';

  const container = document.getElementById('options-container');
  container.innerHTML = '';

  question.options.forEach((opt, idx) => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.textContent = opt;
    btn.onclick = () => selectOption(idx);
    container.appendChild(btn);
  });

  document.getElementById('next-btn').disabled = true;
}

function selectOption(idx) {
  document.querySelectorAll('.option-btn').forEach((btn, i) => {
    btn.classList.toggle('selected', i === idx);
  });

  state.answers[state.currentQuestion] = idx;
  document.getElementById('next-btn').disabled = false;
}

function nextQuestion() {
  const level = LEVELS[state.currentLevel];
  const questions = getShuffledQuestions(level);

  state.currentQuestion++;

  if (state.currentQuestion >= questions.length) {
    showLevelResult();
  } else {
    loadQuestion();
  }
}

function showLevelResult() {
  const level = LEVELS[state.currentLevel];
  const questions = getShuffledQuestions(level);
  const correct = state.answers.filter((ans, idx) => ans === questions[idx].correct).length;
  const percentage = Math.round((correct / questions.length) * 100);

  state.scores[level] = percentage;
  state.allAnswers[level] = [...state.answers];

  const passed = percentage >= PASS_THRESHOLD;
  const isLastLevel = state.currentLevel === LEVELS.length - 1;

  document.getElementById('result-icon').textContent = passed ? 'üéâ' : 'üìö';
  document.getElementById('result-title').textContent = passed ?
    `¬°Aprobaste el nivel ${level}!` : `Has encontrado tu nivel: ${level}`;

  const scoreText = document.getElementById('score-percentage');
  const circle = document.getElementById('score-progress');
  const circumference = 2 * Math.PI * 54;

  circle.style.strokeDashoffset = circumference;
  circle.style.stroke = passed ? '#10b981' : '#f59e0b';
  scoreText.textContent = '0';

  setTimeout(() => {
    let current = 0;
    const increment = percentage / 30;
    const timer = setInterval(() => {
      current += increment;
      if (current >= percentage) {
        current = percentage;
        clearInterval(timer);
      }
      scoreText.textContent = Math.round(current);
      const offset = circumference - (current / 100) * circumference;
      circle.style.strokeDashoffset = offset;
    }, 20);
  }, 100);

  document.getElementById('result-message').textContent = passed ?
    `¬°Obtuviste ${percentage}%! ${isLastLevel ? '¬°Incre√≠ble trabajo completando todos los niveles!' : '¬øListo para el siguiente nivel?'}` :
    `Obtuviste ${percentage}%. Esto indica que tu nivel actual es ${level}. ¬°Sigue practicando y mejorar√°s!`;

  const continueBtn = document.getElementById('continue-btn');
  const abandonBtn = document.getElementById('abandon-btn');

  if (passed && !isLastLevel) {
    continueBtn.textContent = `Continuar a ${LEVELS[state.currentLevel + 1]}`;
    continueBtn.style.display = 'inline-block';
    abandonBtn.style.display = 'inline-block';
    abandonBtn.textContent = 'Abandonar';
  } else {
    continueBtn.style.display = 'none';
    abandonBtn.style.display = 'none';
  }

  if (!passed || isLastLevel) {
    determineFinalLevel();
    setTimeout(() => {
      showFinalResults();
    }, 1500);
  } else {
    showScreen('level-result-screen');
  }
}

function continueToNextLevel() {
  state.currentLevel++;
  state.currentQuestion = 0;
  state.answers = [];
  loadQuestion();
  showScreen('question-screen');
}

function determineFinalLevel() {
  let highestPassedIndex = -1;

  LEVELS.forEach((level, idx) => {
    if (state.scores[level] && state.scores[level] >= PASS_THRESHOLD) {
      highestPassedIndex = idx;
    }
  });

  if (highestPassedIndex >= 0) {
    state.finalLevel = LEVELS[highestPassedIndex];
  } else {
    const lowestTestedLevel = LEVELS.find(level => state.scores[level] !== undefined);
    if (lowestTestedLevel === 'A1' && state.scores['A1'] < PASS_THRESHOLD) {
      state.finalLevel = LEVEL_ZERO;
    } else {
      state.finalLevel = lowestTestedLevel || LEVELS[0];
    }
  }
}

function abandonTest() {
  determineFinalLevel();
  state.testCompleted = true;
  showFinalResults();
}

function showFinalResults() {
  if (!state.finalLevel) {
    determineFinalLevel();
  }

  state.testCompleted = true;
  document.getElementById('final-level-text').textContent = state.finalLevel;

  const descriptions = {
    A0: "Est√°s dando tus primeros pasos. Con pr√°ctica constante, pronto podr√°s comunicarte en situaciones b√°sicas.",
    A1: "Puedes comunicarte en situaciones cotidianas muy b√°sicas usando frases simples. Puedes presentarte, pedir informaci√≥n elemental y hablar sobre tu rutina diaria.",
    A2: "Puedes mantener conversaciones sobre temas familiares y personales. Puedes describir experiencias pasadas y hacer planes para el futuro.",
    B1: "Puedes desenvolverte con independencia. Puedes expresar opiniones, narrar experiencias y entender las ideas principales de textos y discursos.",
    B2: "Puedes interactuar con fluidez y naturalidad con hablantes nativos. Puedes leer textos complejos, dar argumentos detallados y captar significados impl√≠citos.",
    C1: "Puedes usar el idioma con precisi√≥n y sofisticaci√≥n. Puedes expresarte espont√°neamente, captar sutilezas y comunicarte efectivamente en entornos acad√©micos y profesionales."
  };

  document.getElementById('final-level-description').textContent = descriptions[state.finalLevel];

  const scoresList = document.getElementById('scores-list');
  scoresList.innerHTML = '';

  Object.entries(state.scores).forEach(([level, score]) => {
    const item = document.createElement('div');
    item.className = 'score-item';
    item.innerHTML = `
      <span class="score-item-level">Nivel ${level}</span>
      <span class="score-item-score">${score}%</span>
    `;
    scoresList.appendChild(item);
  });

  // Show/hide certificate button based on level
  const certificateBtn = document.getElementById('certificate-btn');
  const noCertificateMsg = document.getElementById('no-certificate-msg');
  if (state.finalLevel === 'A0') {
    certificateBtn.style.display = 'none';
    noCertificateMsg.style.display = 'block';
  } else {
    certificateBtn.style.display = 'inline-flex';
    noCertificateMsg.style.display = 'none';
  }

  showScreen('final-result-screen');
}

function showLevelReview() {
  state.returnScreen = 'level-result-screen';
  const currentLevel = LEVELS[state.currentLevel];
  showReviewForLevels([currentLevel]);
}

function showReview() {
  state.returnScreen = 'final-result-screen';
  const completedLevels = Object.keys(state.scores);
  showReviewForLevels(completedLevels);
}

function showReviewForLevels(levels) {
  const tabsContainer = document.getElementById('review-tabs');

  tabsContainer.innerHTML = '';

  if (levels.length > 1) {
    levels.forEach((level, idx) => {
      const tab = document.createElement('button');
      tab.className = 'review-tab' + (idx === 0 ? ' active' : '');
      tab.textContent = `Nivel ${level}`;
      tab.onclick = () => switchReviewTab(level);
      tabsContainer.appendChild(tab);
    });
    tabsContainer.style.display = 'flex';
  } else {
    tabsContainer.style.display = 'none';
  }

  displayReviewLevel(levels[0]);
  showScreen('review-screen');
}

function switchReviewTab(level) {
  document.querySelectorAll('.review-tab').forEach(tab => {
    tab.classList.toggle('active', tab.textContent === `Nivel ${level}`);
  });
  displayReviewLevel(level);
}

function displayReviewLevel(level) {
  const container = document.getElementById('review-container');
  container.innerHTML = '';

  const questions = getShuffledQuestions(level);
  const levelAnswers = state.allAnswers[level];

  questions.forEach((q, idx) => {
    const userAnswer = levelAnswers[idx];
    const isCorrect = userAnswer === q.correct;

    const questionHTML = q.q.replace(/<blank><\/blank>/g, '<span class="question-blank"></span>');

    const div = document.createElement('div');
    div.className = 'review-question';
    div.innerHTML = `
      <div class="review-question-header">
        <span class="review-level-badge">${level}</span>
        <span class="review-question-number">Pregunta ${idx + 1}</span>
      </div>
      <div class="review-question-text">${questionHTML}</div>
      ${q.options.map((opt, i) => {
        let classes = 'review-option';
        if (i === q.correct) classes += ' correct-answer';
        if (i === userAnswer && !isCorrect) classes += ' wrong';
        if (i === userAnswer) classes += ' user-answer';

        let label = opt;
        if (i === q.correct) label += ' ‚úì';
        if (i === userAnswer && !isCorrect) label += ' ‚úó';

        return `<div class="${classes}">${label}</div>`;
      }).join('')}
    `;
    container.appendChild(div);
  });
}

function backFromReview() {
  const returnTo = state.returnScreen || 'final-result-screen';
  showScreen(returnTo);
}

function restartTest() {
  state = {
    currentLevel: 0,
    currentQuestion: 0,
    answers: [],
    scores: {},
    finalLevel: null,
    shuffledQuestions: {},
    allAnswers: {},
    returnScreen: null
  };
  showScreen('intro-screen');
}

function showNameModal() {
  document.getElementById('name-modal').classList.add('active');
  const input = document.getElementById('student-name-input');
  input.focus();
  input.addEventListener('keypress', handleNameInputKeypress);
}

function handleNameInputKeypress(e) {
  if (e.key === 'Enter') {
    confirmDownload();
  }
}

function closeNameModal() {
  document.getElementById('name-modal').classList.remove('active');
  const input = document.getElementById('student-name-input');
  input.value = '';
  input.removeEventListener('keypress', handleNameInputKeypress);
}

function confirmDownload() {
  const studentName = document.getElementById('student-name-input').value.trim();
  if (!studentName) {
    alert('Por favor, ingresa tu nombre completo.');
    return;
  }
  closeNameModal();
  downloadCertificate(studentName);
}

function loadImageAsDataURL(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      resolve({
        dataURL: canvas.toDataURL('image/png'),
        width: img.naturalWidth,
        height: img.naturalHeight
      });
    };
    img.onerror = () => reject(new Error(`Failed to load image: ${src}`));
    img.src = src;
  });
}

async function downloadCertificate(studentName) {
  const { jsPDF } = window.jspdf;
  const level = state.finalLevel;

  // Create PDF - A4 Landscape
  const doc = new jsPDF({
    orientation: 'landscape',
    unit: 'mm',
    format: 'a4'
  });

  const pageWidth = 297;
  const pageHeight = 210;
  const centerX = pageWidth / 2;

  try {
    // Load background image first
    const bgImage = await loadImageAsDataURL('../../assets/backgrounds/certificate.png');
    doc.addImage(bgImage.dataURL, 'PNG', 0, 0, pageWidth, pageHeight);

    // Load logos
    let logoLoaded = false;
    let cefrLoaded = false;

    try {
      const logoImage = await loadImageAsDataURL('../../assets/logo/logo.png');
      const logoHeight = 12;
      const logoWidth = (logoImage.width / logoImage.height) * logoHeight;
      doc.addImage(logoImage.dataURL, 'PNG', 34, 21, logoWidth, logoHeight);
      logoLoaded = true;
    } catch (e) {
      console.warn('Logo not loaded:', e);
    }

    try {
      const cefrImage = await loadImageAsDataURL('../../assets/logo/cefr.png');
      const cefrHeight = 22;
      const cefrWidth = (cefrImage.width / cefrImage.height) * cefrHeight;
      doc.addImage(cefrImage.dataURL, 'PNG', pageWidth - cefrWidth - 38, 20, cefrWidth, cefrHeight);
      cefrLoaded = true;
    } catch (e) {
      console.warn('CEFR logo not loaded:', e);
    }

    // Fallback text for logos if not loaded
    if (!logoLoaded) {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.setTextColor(10, 30, 66);
      doc.text('ENBREAK', 22, 20);
    }

    if (!cefrLoaded) {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.setTextColor(10, 30, 66);
      doc.text('CEFR', pageWidth - 35, 20);
    }

    // "Se certifica que"
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(12);
    doc.setTextColor(80, 80, 80);
    doc.text('Por medio del presente se certifica que', centerX, 34, { align: 'center' });

    // Student name
    doc.setFont('times', 'bold');
    doc.setFontSize(28);
    doc.setTextColor(10, 30, 66);
    doc.text(studentName, centerX, 47, { align: 'center' });

    // "ha alcanzado el nivel"
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(12);
    doc.setTextColor(80, 80, 80);
    doc.text('ha alcanzado el nivel', centerX, 61, { align: 'center' });

    // Level (only A1, A2, etc - without "Nivel")
    doc.setFont('times', 'bold');
    doc.setFontSize(34);
    doc.setTextColor(10, 30, 66);
    doc.text(level, centerX, 78, { align: 'center' });

    // "en el Test de Nivel Enbreak"
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(12);
    doc.setTextColor(80, 80, 80);
    doc.text('en el Test de Nivel de Enbreak conforme al Marco Com√∫n Europeo de Referencia', centerX, 90, { align: 'center' });

    // Competencies data
    const competencies = {
      A1: [
        'Comprende y utiliza expresiones cotidianas y frases b√°sicas',
        'Puede presentarse y proporcionar informaci√≥n personal b√°sica',
        'Interact√∫a de forma sencilla con interlocutores pacientes'
      ],
      A2: [
        'Comunica tareas simples sobre temas familiares y cotidianos',
        'Describe aspectos de su entorno y necesidades inmediatas',
        'Comprende frases y vocabulario de uso frecuente'
      ],
      B1: [
        'Se desenvuelve en situaciones cotidianas con independencia',
        'Produce textos coherentes sobre temas conocidos o de inter√©s',
        'Describe experiencias, eventos, deseos y aspiraciones'
      ],
      B2: [
        'Interact√∫a con fluidez y espontaneidad con hablantes nativos',
        'Produce textos claros y detallados sobre diversos temas',
        'Comprende ideas principales de textos complejos'
      ],
      C1: [
        'Se expresa con fluidez y precisi√≥n en cualquier contexto',
        'Comprende textos extensos con significados impl√≠citos',
        'Usa el idioma de manera flexible y efectiva'
      ]
    };

    // Competencias section
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.setTextColor(10, 30, 66);
    doc.text('Competencias:', 70, 108);

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.setTextColor(60, 60, 60);
    const levelCompetencies = competencies[level] || competencies['A1'];
    let yPos = 120;
    levelCompetencies.forEach(comp => {
      doc.text('‚Ä¢ ' + comp, 38, yPos);
      yPos += 8;
    });

    // Resultados section - 2x3 Grid
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.setTextColor(10, 30, 66);
    const resultsHeaderX = 210;
    doc.text('Resultados Obtenidos:', resultsHeaderX, 108, { align: 'center' });

    doc.setTextColor(60, 60, 60);

    const gridStartX = 158;
    const gridStartY = 120;
    const colWidth = 30;
    const rowHeight = 10;

    const allLevels = ['A1', 'A2', 'B1', 'B2', 'C1'];
    const row1 = ['A1', 'B1', 'C1'];
    const row2 = ['A2', 'B2'];

    row1.forEach((lvl, idx) => {
      const score = state.scores[lvl];
      const xPos = gridStartX + (idx * colWidth);

      // Level name in bold
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.text(`${lvl}:`, xPos, gridStartY);

      // Score in normal
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      const scoreText = score !== undefined ? `${score}%` : '-';
      doc.text(scoreText, xPos + 8, gridStartY);
    });

    row2.forEach((lvl, idx) => {
      const score = state.scores[lvl];
      const xPos = gridStartX + (idx * colWidth);

      // Level name in bold
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.text(`${lvl}:`, xPos, gridStartY + rowHeight);

      // Score in normal
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      const scoreText = score !== undefined ? `${score}%` : '-';
      doc.text(scoreText, xPos + 8, gridStartY + rowHeight);
    });

    // Date
    const today = new Date();
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
    const formattedDate = today.toLocaleDateString('es-ES', dateOptions);

    const dateX = 70;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text('Fecha de emisi√≥n:', dateX, 165, { align: 'center' });
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(10, 30, 66);
    doc.text(formattedDate, dateX, 171, { align: 'center' });

    // Website
    const websiteX = pageWidth - 70;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text('Sitio web:', websiteX, 165, { align: 'center' });
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(10, 30, 66);
    doc.text('www.enbreak.net', websiteX, 171, { align: 'center' });

    // Disclaimer
    doc.setFont('helvetica', 'italic');
    doc.setFontSize(7);
    doc.setTextColor(120, 120, 120);
    doc.text('Este es un resultado orientativo del test diagn√≥stico de Enbreak y no constituye una certificaci√≥n oficial.', centerX, 190, { align: 'center' });

    // Save
    const sanitizedName = studentName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-');
    doc.save(`Certificado-Enbreak-${level}-${sanitizedName}.pdf`);

  } catch (error) {
    console.error('Error generating certificate:', error);
    alert('Hubo un error al generar el certificado. Por favor, intenta de nuevo.');
  }
}
</script>

</body>
</html>

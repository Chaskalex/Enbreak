<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Clase - ENBREAK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Rubik:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
    <!-- Page Loader -->
    <div id="page-loader">
        <div class="loader-content">
            <img src="../../assets/logo/loading.png" alt="Loading" class="loader-logo">
            <svg class="circular" role="img" aria-label="Cargando">
                <circle class="path-bg" cx="90" cy="90" r="80" fill="none" stroke-width="6"/>
                <circle class="path" cx="90" cy="90" r="80" fill="none" stroke-width="6" stroke-miterlimit="10"/>
            </svg>
        </div>
    </div>

    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Your page content goes here -->
<style>

.booking-banner-section {
    width: 100%;
    height: 320px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0px;
    overflow: hidden;
}

.booking-banner-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('/assets/backgrounds/bg4.jpg') center/cover no-repeat;
    filter: blur(5px);
    z-index: 0;
}

.booking-banner-section::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, rgba(13, 27, 62, 0.85) 0%, rgba(13, 27, 62, 0.65) 40%, rgba(13, 27, 62, 0.45) 70%, rgba(13, 27, 62, 0.25) 100%);
    z-index: 1;
}

.booking-banner-section .banner-content {
    text-align: center;
    z-index: 2;
    max-width: 1200px;
    padding: 0 20px;
}

.booking-banner-section .breadcrumb {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.booking-banner-section .breadcrumb a {
    color: #fff;
    text-decoration: none;
    transition: color 0.2s ease;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.booking-banner-section .breadcrumb a:hover {
    color: #ff6600;
    border-bottom-color: #ff6600;
}

.booking-banner-section .breadcrumb-separator {
    margin: 0 10px;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 400;
}

.booking-banner-section .breadcrumb-current {
    color: #fff;
}

.booking-banner-section h1 {
    font-size: 50px;
    color: #fff;
    font-weight: 600;
    margin: 0;
    text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.5);
}

@media (max-width: 767.98px) {
    .booking-banner-section {
        height: 250px;
    }
    .booking-banner-section h1 {
        font-size: 36px;
    }
}

@keyframes slide-in {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slide-out {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

@keyframes fade-in {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

.animate-slide-in {
    animation: slide-in 0.3s ease-out;
}

.animate-fade-in {
    animation: fade-in 0.2s ease-out;
}

#booking-system-container {
    font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    line-height: 1.6;
}

#booking-system-container *,
#booking-system-container *::before,
#booking-system-container *::after {
    box-sizing: border-box;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

#booking-system-container {
    --color-primary: #3b82f6;
    --color-secondary: #4f46e5;
    --color-success: #10b981;
    --color-warning: #f97316;
    --color-danger: #ef4444;
    --color-gray-100: #f3f4f6;
    --color-gray-200: #d1d5db;
    --color-gray-300: #9ca3af;
    --color-gray-600: #4b5563;
    --color-gray-700: #374151;
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.12);
    --shadow-xl: 0 20px 35px rgba(0, 0, 0, 0.15);
    --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

#booking-system-container input:not([type="checkbox"]):not([type="radio"]),
#booking-system-container select,
#booking-system-container button {
    outline: none;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

#booking-system-container button[class*="bg-gradient-to-r"] {
    position: relative;
    overflow: hidden;
    z-index: 1;
    border: none;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
}

#booking-system-container button[class*="bg-gradient-to-r"]:hover {
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.6);
}

#booking-system-container input:focus,
#booking-system-container select:focus {
    border-color: var(--color-primary) !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

#step-3-content input:focus,
#step-3-content select:focus {
    background-color: #ffffff !important;
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    color: #374151 !important;
    outline: none !important;
}

#booking-notification {
    box-shadow: var(--shadow-xl);
}

#booking-system-container .w-10.h-10.rounded-full.flex.items-center.justify-center.font-bold.text-lg.bg-blue-500.text-white {
    background-color: var(--color-primary) !important;
    color: white !important;
    border-color: var(--color-primary) !important;
}

#booking-system-container .w-10.h-10.rounded-full.flex.items-center.justify-center.font-bold.text-lg:not(.bg-blue-500):not(.text-white) {
    background-color: var(--color-gray-200) !important;
    color: var(--color-gray-700) !important;
    border-color: var(--color-gray-300) !important;
}

#booking-system-container .grid > div[onclick*="selectPlan"] {
    background-color: #ffffff !important;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--color-gray-200);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

#booking-system-container .grid > div[onclick*="selectPlan"]:hover {
    box-shadow: var(--shadow-lg);
    border-color: rgba(59, 130, 246, 0.5);
    transform: translateY(-2px);
}

#booking-system-container .grid > div[class*="scale-102"][class*="border-blue-500"] {
    border-color: var(--color-primary);
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2);
    transform: scale(1.02) translateY(-2px);
}

#booking-system-container .grid > div.border-orange-500 {
    border-color: var(--color-warning) !important;
    border-width: 2px !important;
}

#booking-system-container .grid > div.border-purple-500 {
    border-color: #a855f7 !important;
    border-width: 2px !important;
}

#booking-system-container .popular-badge {
    background: linear-gradient(to right, #f97316, #ef4444);
    padding: 4px 12px;
}

#booking-system-container .bg-clip-text {
    background-clip: text;
    -webkit-background-clip: text;
    color: transparent;
    background-image: linear-gradient(to right, #2563eb, #4f46e5);
}

#booking-system-container .flex { display: flex; }
#booking-system-container .inline-flex { display: inline-flex; }
#booking-system-container .grid { display: grid; }
#booking-system-container .inline-block { display: inline-block; }
#booking-system-container .block { display: block; }
#booking-system-container .hidden { display: none; }
#booking-system-container .items-center { align-items: center; }
#booking-system-container .items-start { align-items: flex-start; }
#booking-system-container .justify-center { justify-content: center; }
#booking-system-container .justify-between { justify-content: space-between; }
#booking-system-container .flex-1 { flex: 1 1 0%; }
#booking-system-container .flex-shrink-0 { flex-shrink: 0; }
#booking-system-container .space-y-4 > * + * { margin-top: 1rem; }
#booking-system-container .space-y-6 > * + * { margin-top: 1.5rem; }
#booking-system-container .space-y-8 > * + * { margin-top: 2rem; }
#booking-system-container .gap-1 { gap: 0.25rem; }
#booking-system-container .gap-2 { gap: 0.5rem; }
#booking-system-container .gap-3 { gap: 0.75rem; }
#booking-system-container .gap-4 { gap: 1rem; }
#booking-system-container .gap-6 { gap: 1.5rem; }
#booking-system-container .gap-8 { gap: 2rem; }
#booking-system-container .gap-16 { gap: 4rem; }
#booking-system-container .gap-1\.5 { gap: 0.375rem; }
#booking-system-container .grid-cols-7 { grid-template-columns: repeat(7, minmax(0, 1fr)); }
#booking-system-container .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }

@media (min-width: 768px) {
    #booking-system-container .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    #booking-system-container .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
}

@media (min-width: 1024px) {
    #booking-system-container .lg\:grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
}

#booking-system-container .m-0 { margin: 0; }
#booking-system-container .mb-1 { margin-bottom: 0.25rem; }
#booking-system-container .mb-2 { margin-bottom: 0.5rem; }
#booking-system-container .mb-3 { margin-bottom: 0.75rem; }
#booking-system-container .mb-4 { margin-bottom: 1rem; }
#booking-system-container .mb-6 { margin-bottom: 1.5rem; }
#booking-system-container .mb-8 { margin-bottom: 2rem; }
#booking-system-container .mb-12 { margin-bottom: 3rem; }
#booking-system-container .mt-1 { margin-top: 0.25rem; }
#booking-system-container .mt-2 { margin-top: 0.5rem; }
#booking-system-container .mt-4 { margin-top: 1rem; }
#booking-system-container .mt-6 { margin-top: 1.5rem; }
#booking-system-container .mt-8 { margin-top: 2rem; }
#booking-system-container .ml-auto { margin-left: auto; }
#booking-system-container .mr-1 { margin-right: 0.25rem; }
#booking-system-container .mr-2 { margin-right: 0.5rem; }
#booking-system-container .mr-3 { margin-right: 0.75rem; }
#booking-system-container .mx-2 { margin-left: 0.5rem; margin-right: 0.5rem; }
#booking-system-container .mx-auto { margin-left: auto; margin-right: auto; }
#booking-system-container .p-3 { padding: 0.75rem; }
#booking-system-container .p-4 { padding: 1rem; }
#booking-system-container .p-6 { padding: 1.5rem; }
#booking-system-container .p-8 { padding: 2rem; }
#booking-system-container .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
#booking-system-container .px-4 { padding-left: 1rem; padding-right: 1rem; }
#booking-system-container .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
#booking-system-container .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
#booking-system-container .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
#booking-system-container .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
#booking-system-container .py-12 { padding-top: 3rem; padding-bottom: 3rem; }
#booking-system-container .pt-3 { padding-top: 0.75rem; }
#booking-system-container .pb-2 { padding-bottom: 0.5rem; }
#booking-system-container .pb-4 { padding-bottom: 1rem; }
#booking-system-container .pb-10 { padding-bottom: 2.5rem; }
#booking-system-container .w-6 { width: 1.5rem; }
#booking-system-container .w-10 { width: 2.5rem; }
#booking-system-container .w-16 { width: 4rem; }
#booking-system-container .w-32 { width: 8rem; }
#booking-system-container .w-72 { width: 18rem; }
#booking-system-container .w-full { width: 100%; }
#booking-system-container .h-1 { height: 0.25rem; }
#booking-system-container .h-2 { height: 0.5rem; }
#booking-system-container .h-6 { height: 1.5rem; }
#booking-system-container .h-8 { height: 2rem; }
#booking-system-container .h-10 { height: 2.5rem; }
#booking-system-container .min-h-screen { min-height: 100vh; }
#booking-system-container .max-w-6xl { max-width: 72rem; }
#booking-system-container .max-w-md { max-width: 28rem; }
#booking-system-container .max-w-4xl { max-width: 56rem; }
#booking-system-container .relative { position: relative; }
#booking-system-container .fixed { position: fixed; }
#booking-system-container .top-4 { top: 1rem; }
#booking-system-container .right-4 { right: 1rem; }
#booking-system-container .z-50 { z-index: 50; }
#booking-system-container .bg-white { background-color: #ffffff; }
#booking-system-container .bg-gray-50 { background-color: #f9fafb; }
#booking-system-container .bg-gray-100 { background-color: #f3f4f6; }
#booking-system-container .bg-gray-200 { background-color: var(--color-gray-200); }
#booking-system-container .bg-gray-300 { background-color: var(--color-gray-300); }
#booking-system-container .bg-blue-400 { background-color: #3b82f6; }
#booking-system-container .bg-red-400 { background-color: #ef8b8b; }
#booking-system-container .bg-green-500 { background-color: #22c55e; }
#booking-system-container .bg-blue-50 { background-color: #eff6ff; }
#booking-system-container .bg-blue-500 { background-color: #3b82f6; }
#booking-system-container .bg-green-50 { background-color: #f0fdf4; }
#booking-system-container .bg-green-100 { background-color: #dcfce7; }
#booking-system-container .bg-red-50 { background-color: #fef2f2; }
#booking-system-container .bg-red-500 { background-color: #ef4444; }
#booking-system-container .bg-emerald-50 { background-color: #ecfdf5; }
#booking-system-container .bg-gradient-to-br { background-image: linear-gradient(to bottom right, #f8fafc, #eff6ff, #eef2ff); }
#booking-system-container .bg-gradient-to-r { background-image: linear-gradient(to right, var(--gradient-from), var(--gradient-to)); }
#booking-system-container .from-blue-500 { --gradient-from: #3b82f6; }
#booking-system-container .to-indigo-600 { --gradient-to: #4f46e5; }
#booking-system-container .from-blue-600 { --gradient-from: #2563eb; }
#booking-system-container .to-indigo-700 { --gradient-to: #4338ca; }
#booking-system-container .from-green-500 { --gradient-from: #22c55e; }
#booking-system-container .to-emerald-600 { --gradient-to: #059669; }
#booking-system-container .from-orange-500 { --gradient-from: #f97316; }
#booking-system-container .to-orange-600 { --gradient-to: #ea580c; }
#booking-system-container .from-purple-500 { --gradient-from: #a855f7; }
#booking-system-container .to-pink-500 { --gradient-to: #ec4899; }
#booking-system-container .from-purple-600 { --gradient-from: #9333ea; }
#booking-system-container .to-pink-600 { --gradient-to: #db2777; }
#booking-system-container .text-white { color: #ffffff; }
#booking-system-container .text-gray-400 { color: var(--color-gray-300); }
#booking-system-container .text-gray-500 { color: #6b7280; }
#booking-system-container .text-gray-600 { color: var(--color-gray-600); }
#booking-system-container .text-gray-700 { color: var(--color-gray-700); }
#booking-system-container .text-gray-800 { color: #1f2937; }
#booking-system-container .text-blue-500 { color: #3b82f6; }
#booking-system-container .text-blue-600 { color: #2563eb; }
#booking-system-container .text-blue-800 { color: #1e40af; }
#booking-system-container .text-green-700 { color: #15803d; }
#booking-system-container .text-emerald-600 { color: #059669; }
#booking-system-container .text-red-500 { color: #ef4444; }
#booking-system-container .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
#booking-system-container .text-xs { font-size: 0.8125rem; line-height: 1.125rem; }
#booking-system-container .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
#booking-system-container .text-2xl { font-size: 1.5rem; line-height: 2rem; }
#booking-system-container .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
#booking-system-container .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
#booking-system-container .font-medium { font-weight: 500; }
#booking-system-container .font-semibold { font-weight: 600; }
#booking-system-container .font-bold { font-weight: 700; }
#booking-system-container .text-center { text-align: center; }
#booking-system-container .text-left { text-align: left; }
#booking-system-container .line-through { text-decoration: line-through; }
#booking-system-container .capitalize { text-transform: capitalize; }
#booking-system-container .border { border-width: 1px; }
#booking-system-container .border-2 { border-width: 2px; }
#booking-system-container .border-gray-200 { border-color: var(--color-gray-200); }
#booking-system-container .border-gray-300 { border-color: #d1d5db; }
#booking-system-container .border-blue-300 { border-color: #93c5fd; }
#booking-system-container .border-blue-500 { border-color: #3b82f6; }
#booking-system-container .border-emerald-400 { border-color: #4ade80; }
#booking-system-container .border-orange-500 { border-color: #f97316; }
#booking-system-container .border-red-400 { border-color: #f87171; }
#booking-system-container .border-red-500 { border-color: #ef4444; }
#booking-system-container .border-green-600 { border-color: #16a34a; }
#booking-system-container .border-gray-400 { border-color: #9ca3af; }
#booking-system-container .rounded-lg { border-radius: 0.5rem; }
#booking-system-container .rounded-xl { border-radius: 0.75rem; }
#booking-system-container .rounded-2xl { border-radius: 1rem; }
#booking-system-container .rounded-full { border-radius: 9999px; }
#booking-system-container .shadow-md { box-shadow: var(--shadow-md); }
#booking-system-container .shadow-lg { box-shadow: var(--shadow-lg); }
#booking-system-container .shadow-xl { box-shadow: var(--shadow-xl); }
#booking-system-container .shadow-2xl { box-shadow: var(--shadow-2xl); }
#booking-system-container .ring-2 { box-shadow: 0 0 0 2px currentColor; }
#booking-system-container .ring-4 { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5); }
#booking-system-container .ring-offset-2 { box-shadow: 0 0 0 2px var(--color-gray-50), 0 0 0 4px currentColor; }
#booking-system-container .ring-blue-300 { box-shadow: 0 0 0 4px rgba(147, 197, 253, 0.5); }
#booking-system-container .ring-green-300 { box-shadow: 0 0 0 4px rgba(110, 231, 183, 0.5); }
#booking-system-container .ring-orange-400 { box-shadow: 0 0 0 4px rgba(251, 146, 60, 0.5); }
#booking-system-container .transition-all { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
#booking-system-container .duration-300 { transition-duration: 0.3s; }
#booking-system-container .scale-102 { transform: scale(1.02); }
#booking-system-container .hover\:scale-102:hover { transform: scale(1.02); }
#booking-system-container .hover\:shadow-2xl:hover { box-shadow: var(--shadow-2xl); }
#booking-system-container .hover\:border-blue-300:hover { border-color: #93c5fd; }
#booking-system-container .hover\:from-blue-600:hover { --gradient-from: #2563eb; }
#booking-system-container .hover\:to-indigo-700:hover { --gradient-to: #4338ca; }
#booking-system-container .cursor-pointer { cursor: pointer; }
#booking-system-container .cursor-not-allowed { cursor: not-allowed; }
#booking-system-container .hover\:bg-blue-500:hover { background-color: #3b82f6; }
#booking-system-container .hover\:bg-blue-50:hover { background-color: #eff6ff; }
#booking-system-container .hover\:bg-blue-600:hover { background-color: #2563eb; }
#booking-system-container .hover\:border-blue-400:hover { border-color: #60a5fa; }
#booking-system-container .hover\:shadow-sm:hover { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }

#booking-system-content {
    min-height: 400px;
}

input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus {
    -webkit-box-shadow: 0 0 0 1000px #ffffff inset !important;
    box-shadow: 0 0 0 1000px #ffffff inset !important;
    -webkit-text-fill-color: #000 !important;
    transition: background-color 9999s ease-in-out 0s;
}
</style>

<main style="padding: 0; margin: 0;">
    <section class="booking-banner-section">
        <div class="banner-content">
            <nav class="breadcrumb">
                <a href="/enbreak/index.php">Home</a>
                <span class="breadcrumb-separator">></span>
                <span class="breadcrumb-current">Agenda tu Clase</span>
            </nav>
            <h1>Agenda tu Clase</h1>
        </div>
    </section>

    <div id="booking-system-container"></div>
</main>

<script>
// =================================================================
// 1. STATE & CONSTANTS
// =================================================================
let currentStep = 1;
let selectedPlan = null;
let bookings = [];
let studentName = '', studentEmail = '', studentEmailConfirm = '', studentRut = '', studentPhone = '', wantsReminder = false;
let discountCode = '';
let appliedDiscount = null;
let fieldErrors = {};
let calendarMonth = new Date();
let activeCalendar = null;
let notificationTimeout = null;

const plans = [
    { id: 1, classes: 1, price: 14990, savings: 0, popular: false, bestPrice: false },
    { id: 2, classes: 2, price: 28481, savings: 5, popular: false, bestPrice: false },
    { id: 3, classes: 4, price: 52765, savings: 12, popular: true, bestPrice: false },
    { id: 4, classes: 6, price: 73751, savings: 18, popular: false, bestPrice: false },
    { id: 5, classes: 8, price: 89940, savings: 25, popular: false, bestPrice: true }
];

const timeSlots = {
    weekday: ['09:00-10:00', '10:30-11:30', '12:00-13:00', '15:00-16:00', '16:30-17:30', '18:00-19:00', '21:00-22:00'],
    saturday: ['09:00-10:00', '10:30-11:30', '12:00-13:00'],
};

const chileanHolidays = ['01-01', '04-03', '04-04', '05-01', '05-21', '06-20', '08-15', '09-18', '09-19', '10-12', '10-31', '11-01', '12-08', '12-25'];

const discountCodes = {
    'PROMO10': { percent: 10, description: '10% de descuento' },
    'PRIMERA20': { percent: 20, description: '20% descuento primera clase' },
    'VERANO15': { percent: 15, description: '15% descuento de verano' },
};

// =================================================================
// 2. UTILITY FUNCTIONS (Currency and Calculations)
// =================================================================

const formatCurrency = (amount) => {
    return new Intl.NumberFormat('es-CL', { 
        style: 'currency', 
        currency: 'CLP', 
        minimumFractionDigits: 0, 
    }).format(amount);
};

const calculateOriginalPrice = (plan) => {
    if (plan.savings === 0) {
        return plan.price;
    }
    return Math.round(plan.price / (1 - (plan.savings / 100)));
};
const calculateFinalPrice = () => {
    if (!selectedPlan) return 0;
    let price = selectedPlan.price;
    if (appliedDiscount) {
        price = price * (1 - (appliedDiscount.percent / 100));
    }
    return Math.round(price);
};
const formatRUT = (value) => {
    const clean = value.replace(/[^0-9kK]/g, '');
    if (clean.length === 0) return '';
    if (clean.length > 9) return studentRut;  
    const body = clean.slice(0, -1);
    const verifier = clean.slice(-1).toUpperCase();
    const formattedBody = body.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return body.length > 0 ? `${formattedBody}-${verifier}` : verifier;
};
const validateField = (field) => {
    let isValid = true;
    let value = '';

    switch (field) {
        case 'name':
    value = studentName.trim();
    const words = value.split(/\s+/).filter(word => word.length > 0);
    isValid = words.length >= 2 && value.length >= 3;
    break;
        case 'email':
            value = studentEmail.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            isValid = emailRegex.test(value);
            break;
        case 'emailConfirm':
            value = studentEmailConfirm.trim();
            isValid = value === studentEmail.trim() && studentEmail.trim().length > 0;
            break;
        case 'rut':
            value = studentRut.trim();
            const cleanRut = value.replace(/[.-]/g, '');
            isValid = cleanRut.length >= 8 && cleanRut.length <= 9;
            break;
        case 'phone':
    value = studentPhone.trim();
    const cleanPhone = value.replace(/\s/g, '');
    const phoneRegex = /^\+?\d+$/;
    const hasValidCharacters = phoneRegex.test(cleanPhone);
    
    if (!hasValidCharacters) {
        isValid = false;
    } else {
        const digitCount = cleanPhone.replace(/\+/g, '').length;
        isValid = digitCount >= 8 && digitCount <= 12;
    }
    break;
    }

    if (!isValid) {
        fieldErrors = { ...fieldErrors, [field]: true };
    } else {
        delete fieldErrors[field];
    }
    return isValid;
};

const validateAllFields = () => {
    const fields = ['name', 'email', 'emailConfirm', 'rut', 'phone'];
    let allValid = true;
    fields.forEach(field => {
        if (!validateField(field)) {
            allValid = false;
        }
    });
    return allValid;
};

const isDateAvailable = (date, currentIndex = null) => {
    const d = new Date(date + 'T12:00:00');
    const day = d.getDay();
    
    const now = new Date();
    const chileTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Santiago' }));
    
    const startOfToday = new Date(chileTime);
    startOfToday.setHours(0, 0, 0, 0);
    
    const startOfSelectedDay = new Date(date + 'T00:00:00');

    const monthDay = `${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    if (chileanHolidays.includes(monthDay)) return { available: false, reason: 'holiday' };
    
    if (day === 0) return { available: false, reason: 'sunday' };
    
    if (startOfSelectedDay < startOfToday) return { available: false, reason: 'past' };

    const availableSlots = getAvailableSlots(date, currentIndex);
    if (availableSlots.length === 0) return { available: false, reason: 'no_slots' };

    return { available: true, reason: null };
};

const getAvailableSlots = (dateStr, currentIndex) => {
    if (!dateStr) return [];
    const d = new Date(dateStr + 'T12:00:00');
    const day = d.getDay();
    const slots = day === 6 ? timeSlots.saturday : timeSlots.weekday;
    const now = new Date();

    return slots.filter(slot => {

        const isBooked = bookings.some((b, idx) => idx !== currentIndex && b?.date === dateStr && b?.time === slot);
        if (isBooked) return false;

        const [startTime] = slot.split('-');
        const [hours, minutes] = startTime.split(':');
        const slotDateTime = new Date(dateStr + `T${hours}:${minutes}:00`);
        const twelveHoursLater = new Date(now.getTime() + 12 * 60 * 60 * 1000);
        
        return slotDateTime >= twelveHoursLater;
    });
};

const isBookingComplete = () => {
    const isScheduleComplete = bookings.every(b => b?.date && b?.time);
    return isScheduleComplete && validateAllFields();
};

const selectPlan = (planId) => {
    selectedPlan = plans.find(p => p.id === planId);
    if (selectedPlan) {
        bookings = new Array(selectedPlan.classes).fill(null).map(() => ({ date: null, time: null }));
        goToNextStep(); 
        showNotification(`Plan de ${selectedPlan.classes} ${selectedPlan.classes === 1 ? 'clase' : 'clases'} seleccionado`, 'success');
    }
};

const applyDiscount = (code) => {
    if (!selectedPlan) {
        showNotification('Debes seleccionar un plan primero.', 'error');
        return;
    }
    const upperCode = code.toUpperCase();
    if (discountCodes[upperCode]) {
        appliedDiscount = discountCodes[upperCode];
        showNotification(`Descuento "${upperCode}" aplicado: ${appliedDiscount.description}`, 'success');
    } else {
        appliedDiscount = null;
        showNotification('Código de descuento inválido o expirado.', 'error');
    }
    renderStep(3); 
};

const handleConfirmPayment = () => {
    if (!validateAllFields()) {
        showNotification('Completa todos los campos requeridos antes de continuar', 'error');
        renderStep(3); // Re-render to show errors without animation
        return;
    }

    const originalPlanPrice = calculateOriginalPrice(selectedPlan);
    const finalPrice = calculateFinalPrice();

    const bookingData = {
        plan: {
            id: selectedPlan.id,
            classes: selectedPlan.classes,
            originalPrice: originalPlanPrice,
            finalPrice: finalPrice,
        },
        student: {
            name: studentName,
            email: studentEmail,
            age: studentAge,
            id: studentId,
            phone: studentPhone,
        },
        schedule: bookings,
        discount: appliedDiscount,
        timestamp: new Date().toISOString()
    };
    
    console.log('Booking Data:', bookingData);
    showNotification('¡Reserva confirmada exitosamente!', 'success');

    setTimeout(() => {
        alert('Demo: Redirigiendo a Pasarela de Pago con un total de ' + formatCurrency(finalPrice) + '...');
    }, 1500);
};

const toggleCalendar = (index) => {
    const isOpening = activeCalendar !== index;
    
    if (activeCalendar === index) {
        activeCalendar = null;
    } else {
        activeCalendar = index;
    }
    renderStep(2); 

    if (isOpening && activeCalendar === index) {
        scrollToCalendar();
    }
};

function handleCalendarClickOutside(event) {
    const calendar = document.querySelector('.calendar-popup');
    if (!calendar) {
        document.removeEventListener('click', handleCalendarClickOutside);
        return;
    }
    
    const clickedInsideCalendar = calendar.contains(event.target);
    const clickedDateButton = event.target.closest('button[onclick*="toggleCalendar"]');
    
    if (!clickedInsideCalendar && !clickedDateButton) {
        activeCalendar = null;
        document.removeEventListener('click', handleCalendarClickOutside);
        renderStep(2); 
    }
}

const selectDate = (dateStr, index) => {
    bookings[index] = { ...bookings[index], date: dateStr, time: null }; 
    activeCalendar = null;
    document.removeEventListener('click', handleCalendarClickOutside);
    renderStep(2); 
};

const selectTimeSlot = (slot, index) => {
    bookings[index] = { ...bookings[index], time: slot };

    if (bookings[index].date && bookings[index].time) {
        const formattedDate = new Date(bookings[index].date + 'T12:00:00').toLocaleDateString('es-CL', { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long' 
        });
        const formattedTime = slot.split('-')[0];
        showNotification(`Clase ${index + 1}: ${formattedDate}, ${formattedTime}`, 'success');
    }
    
    renderStep(2); 
};
const goToNextStep = () => {
    const prevStep = currentStep; 
    if (currentStep === 1 && selectedPlan) {
        currentStep = 2;
    } else if (currentStep === 2) {

        if (bookings.every(b => b?.date && b?.time)) {
            currentStep = 3;
        } else {
            showNotification('Debes completar toda la información antes de continuar.', 'error');
            renderStep(2); 
            return;
        }
    } else if (currentStep === 3 && isBookingComplete()) {

    } else {

        if (currentStep === 3) {
            showNotification('Completa toda la información del estudiante correctamente.', 'error');
        }
        return;
    }
    const shouldAnimate = currentStep !== prevStep;
    renderStep(currentStep, shouldAnimate);
};
const goToPrevStep = () => {
    const prevStep = currentStep; 
    currentStep = Math.max(1, currentStep - 1);
    const shouldAnimate = currentStep !== prevStep; 
    renderStep(currentStep, shouldAnimate);
};
const updateStudentInfo = (field, value) => {
    switch (field) {
        case 'name': 
            studentName = value; 
            break;
        case 'email': 
            studentEmail = value; 
            break;
        case 'emailConfirm': 
            studentEmailConfirm = value; 
            break;
        case 'rut': 
            const input = event.target;
            const cursorPosition = input.selectionStart;
            const oldValue = studentRut;
            const newValue = formatRUT(value);
            
            if (newValue !== oldValue || newValue.length <= oldValue.length) {
                studentRut = newValue; 
                setTimeout(() => {
                    input.value = studentRut;
                    const lengthDiff = studentRut.length - value.length;
                    const newCursorPos = cursorPosition + lengthDiff;
                    input.setSelectionRange(newCursorPos, newCursorPos);
                }, 0);
            }
            return;
        case 'phone': 
            studentPhone = value; 
            break;
        case 'reminder': 
    wantsReminder = value; 

    return;
    }

    if (fieldErrors[field]) {
        validateField(field);
    }
};

function updateFieldError(field) {
    const errorMessages = {
    name: 'Debes ingresar nombre y apellido',
    rut: 'RUT debe tener entre 8 y 9 dígitos',
    email: 'Correo inválido',
    emailConfirm: 'Los correos no coinciden',
    phone: 'Debes ingresar entre 8 y 12 dígitos'
};
    
    const inputs = document.querySelectorAll('input');
    let targetInput = null;
    for (let input of inputs) {
        const onInputAttr = input.getAttribute('oninput');
        if (onInputAttr && onInputAttr.includes(`'${field}'`)) {
            targetInput = input;
            break;
        }
    }
    if (!targetInput) return;

    const value = field === 'name' ? studentName : 
                 field === 'email' ? studentEmail :
                 field === 'emailConfirm' ? studentEmailConfirm :
                 field === 'rut' ? studentRut :
                 field === 'phone' ? studentPhone : '';
    
    const isFilled = value.trim().length > 0;
    const hasError = fieldErrors[field] && isFilled;
    const isValid = isFilled && !fieldErrors[field];
    
    if (hasError) {
        targetInput.style.borderColor = '#ef4444';
        targetInput.style.borderWidth = '1px';
    } else {
        targetInput.style.borderColor = '#6b7280';
        targetInput.style.borderWidth = '1px';
    }
    
    if (isValid || hasError) {
        targetInput.style.paddingRight = '2.5rem';
    } else {
        targetInput.style.paddingRight = '0.75rem';
    }

    const parentContainer = targetInput.closest('div[style*="margin-bottom: 0.5rem"]');
    if (parentContainer) {
        const errorDiv = parentContainer.querySelector('div[style*="position: absolute"][style*="height: 20px"]');
        
        if (errorDiv) {
            if (hasError) {
                errorDiv.innerHTML = `<p class="text-red-500 text-xs mt-1">${errorMessages[field]}</p>`;
            } else {
                errorDiv.innerHTML = '';
            }
        }
    }

    const inputWrapper = targetInput.parentElement;
    let icon = inputWrapper.querySelector('div[style*="pointer-events: none"]');
    
    if (isValid) {
        if (!icon) {
            icon = document.createElement('div');
            icon.style.cssText = 'position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none;';
            inputWrapper.appendChild(icon);
        }
        icon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#16a34a"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    } else if (hasError) {
        if (!icon) {
            icon = document.createElement('div');
            icon.style.cssText = 'position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none;';
            inputWrapper.appendChild(icon);
        }
        icon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#ef4444"/><path d="M12 8v4m0 4h.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    } else {
        if (icon) {
            icon.remove();
        }
    }
}

const handleBlur = (field) => {
    validateField(field);
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            renderStep(3);
        });
    });
};

const scrollToTop = () => {
    const container = document.getElementById('booking-system-container');
    if (container) {
        container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
};

const scrollToCalendar = () => {
    setTimeout(() => {
        const calendar = document.querySelector('.calendar-popup');
        if (calendar) {
            calendar.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
        }
    }, 100);
};

const showNotification = (message, type) => {
    const container = document.getElementById('booking-system-container');
    let notification = document.getElementById('booking-notification');

    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'booking-notification';
        notification.className = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl transition-all duration-300 animate-slide-in';
        container.appendChild(notification);
    }

    let bgColor, textColor, iconName;
    if (type === 'success') {
        bgColor = 'bg-green-500';
        textColor = 'text-white';
        iconName = 'check-circle';
    } else if (type === 'error') {
        bgColor = 'bg-red-500';
        textColor = 'text-white';
        iconName = 'x-octagon';
    } else { 
        bgColor = 'bg-blue-500';
        textColor = 'text-white';
        iconName = 'info';
    }

    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl transition-all duration-300 flex items-center gap-2 ${bgColor} ${textColor} animate-slide-in`;
    notification.innerHTML = `${icon(iconName, 20, 'flex-shrink-0')} <span class="text-sm font-semibold">${message}</span>`;

    lucide.createIcons(); 

    if (notificationTimeout) {
        clearTimeout(notificationTimeout);
    }

    notificationTimeout = setTimeout(() => {
        notification.classList.remove('animate-slide-in');
        notification.style.animation = 'slide-out 0.3s ease-in forwards';
        setTimeout(() => {
            notification.remove();
        }, 300); 
    }, 4000);
};

const icon = (name, size = 24, classes = '') => {
    return `<i data-lucide="${name}" class="${classes}" style="width: ${size}px; height: ${size}px;"></i>`;
};

const renderHeader = () => {
    return `
        <div class="px-6 pb-0" style="background-color: #fff; padding-top: 2rem; border-radius: 1rem 1rem 0 0;">
            ${renderProgressSteps()}
            <div class="w-full bg-gray-300 mt-6" style="height: 2px;"></div>
        </div>
    `;
};

const renderProgressSteps = () => {
    const steps = [1, 2, 3];
    const stepLabels = ['Plan', 'Horarios', 'Datos'];

    let circlesHtml = '<div class="flex justify-center items-center mb-2">';
    
    steps.forEach((step, index) => {
        const isCurrentOrPast = currentStep >= step;
        const isCurrent = currentStep === step;
        const isClickable = step < currentStep; 
        
        const stepClass = isCurrentOrPast 
            ? `bg-blue-500 text-white shadow-lg ${isCurrent ? 'ring-2 ring-blue-300' : ''}` 
            : 'bg-gray-200 text-gray-700';
            
        const lineClass = currentStep > step ? 'bg-blue-500' : 'bg-gray-200';

        const circleContent = `
            <div class="rounded-full flex items-center justify-center font-bold text-sm transition-all duration-300 ${stepClass} ${isClickable ? 'cursor-pointer hover:bg-blue-600' : ''}" 
                style="width: 32px; height: 32px; min-width: 32px; min-height: 32px;"
                ${isClickable ? `onclick="goToStep(${step})"` : ''}>
                ${currentStep > step ? icon('check', 14, '') : step}
            </div>
        `;
        
        circlesHtml += circleContent;
        
        if (step < 3) {
            circlesHtml += `<div class="h-1 rounded transition-all duration-300 ${lineClass}" style="width: 76px; margin: 0 8px;"></div>`;
        }
    });
    circlesHtml += '</div>';

    let labelsHtml = '<div class="flex justify-center items-center">';
    
    stepLabels.forEach((label, index) => {
        const isActive = currentStep >= index + 1;
        
        if (index === 0) {
            labelsHtml += `
                <div class="text-xs font-medium ${isActive ? 'text-blue-600 font-bold' : 'text-gray-400'}" style="width: 32px; text-align: center;">
                    ${label}
                </div>
                <div style="width: 92px;"></div>
            `;
        } else if (index === 1) {
            labelsHtml += `
                <div class="text-xs font-medium ${isActive ? 'text-blue-600 font-bold' : 'text-gray-400'}" style="width: 50px; text-align: center; margin-left: -9px;">
                    ${label}
                </div>
                <div style="width: 83px;"></div>
            `;
        } else {
            labelsHtml += `
                <div class="text-xs font-medium ${isActive ? 'text-blue-600 font-bold' : 'text-gray-400'}" style="width: 32px; text-align: center;">
                    ${label}
                </div>
            `;
        }
    });
    labelsHtml += '</div>';
    
    return circlesHtml + labelsHtml;
};

const goToStep = (step) => {
    if (step < currentStep) {
        currentStep = step;
        renderStep(currentStep, true);
    }
};

const renderStep1 = () => {
    if (!selectedPlan) {
        selectedPlan = plans.find(p => p.popular) || plans[0]; 
    }
    return `
        <div id="step-1-content" class="p-6" style="border-radius: 0 0 1rem 1rem; overflow: hidden;">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Selecciona tu Plan de Clases</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                ${plans.map(plan => {
    const originalPrice = calculateOriginalPrice(plan);
    const finalPrice = formatCurrency(plan.price);
    const originalPriceStr = formatCurrency(originalPrice);
    const cardClasses = plan.popular 
        ? 'border-2 border-orange-500 ring-2 ring-orange-400 ring-offset-2'
        : plan.bestPrice
            ? 'border-2 border-purple-500 ring-2 ring-purple-400 ring-offset-2'
            : selectedPlan?.id === plan.id 
                ? 'border-2 border-blue-500 shadow-2xl scale-102' 
                : 'border-2 border-gray-200 hover:border-blue-300';

    return `
        <div onclick="selectPlan(${plan.id})" 
            class="relative rounded-2xl p-6 cursor-pointer transition-all duration-300 hover:shadow-2xl hover:scale-102 ${cardClasses}" 
            style="position: relative; z-index: 1; background-color: #ffffff !important;" 
        >
            ${plan.popular ? `
                <div class="popular-badge" style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); color: white; font-size: 11px; font-weight: bold; border-radius: 9999px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10; white-space: nowrap;">
                    MÁS POPULAR
                </div>
            ` : ''}
            ${plan.bestPrice ? `
                <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: linear-gradient(to right, #a855f7, #ec4899); padding: 4px 12px; color: white; font-size: 11px; font-weight: bold; border-radius: 9999px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10; white-space: nowrap;">
                    MENOR PRECIO
                </div>
            ` : ''}
            <div class="text-center">
                <div class="text-4xl font-bold text-gray-800 mb-1">${plan.classes}</div>
                <div class="text-sm text-gray-600 mb-4">${plan.classes === 1 ? 'Clase' : 'Clases'}</div>
                
                <div class="text-3xl font-bold bg-clip-text">
                    ${finalPrice}
                </div>
                
                ${plan.savings > 0 ? `
                    <div class="text-sm text-gray-400 line-through">${originalPriceStr}</div>
                    <div class="text-xs font-semibold mt-1 bg-green-50 text-green-700 px-3 py-1 rounded-full inline-block">
                        Ahorras ${plan.savings}%
                    </div>
                ` : '<div class="h-8"></div>'}
            </div>
        </div>
    `;
}).join('')}
            </div>
            
            <div class="border border-blue-300 p-3 rounded-xl mt-4 mx-auto flex items-center gap-3" style="background-color: #c8e0ffff;">
    ${icon('info', 20, 'text-blue-600 flex-shrink-0')}
    <p class="text-sm text-blue-800 m-0" style="line-height: 1.4;">
        Todas las clases se realizan mediante la aplicación Zoom y tienen una duración de 60 minutos.
    </p>
</div>

        </div>
    `;
};

const renderStep2 = () => {
    if (!selectedPlan) {
        currentStep = 1;
        return renderStep1();
    }
    
    return `
    <div id="step-2-content" class="p-6" style="border-radius: 0 0 1rem 1rem;">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Selecciona tus Horarios</h2>
        
        <div class="border border-blue-300 p-3 rounded-xl mb-6 mx-auto flex items-center justify-center gap-3" style="background-color: #c8e0ffff;">
    ${icon('info', 20, 'text-blue-600 flex-shrink-0')}
    <p class="text-sm text-blue-800 m-0 text-center" style="line-height: 1.4;">
        Solo es posible seleccionar horarios con 12 horas de anticipación. La duración de cada clase es de 60 minutos.
    </p>
</div>
        
        <div class="space-y-4 mb-8">
            ${bookings.map((booking, index) => {
                    const availableSlots = getAvailableSlots(booking?.date, index);
                    const isComplete = booking?.date && booking?.time;
                    
                    return `
                        <div class="p-4 rounded-xl transition-all duration-300" style="background-color: #ffffffff !important; border: 1px solid #9ca3af;">
                            <div class="flex items-center gap-3 mb-3 pb-2 border-b border-gray-100">
    <h3 class="font-semibold text-sm text-blue-600">Clase ${index + 1} de ${selectedPlan.classes}</h3>
   ${isComplete ? `<span class="ml-auto text-sm font-semibold bg-green-50 text-green-700 px-3 py-1 rounded-full inline-flex items-center gap-1">${icon('check-circle', 16, '')} Listo</span>` : ''}
</div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div style="position: relative; max-width: 480px;">
                                    <label class="block text-sm font-medium text-gray-700 mb-1.5">
                                        ${icon('calendar', 16, 'inline mr-1')} Fecha
                                    </label>
                                   <button type="button" onclick="toggleCalendar(${index})" class="w-full p-3 border text-left text-sm font-medium transition-all duration-200 rounded-lg ${booking?.date ? 'bg-blue-500 text-white border-blue-500 font-bold shadow-md hover:bg-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-blue-50 hover:border-blue-400 hover:shadow-sm'}" style="transform-origin: center;" onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
    ${booking?.date ? new Date(booking.date + 'T12:00:00').toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long' }) : 'Selecciona un día'}
</button>
                                    ${activeCalendar === index ? `<div style="position: relative;">${renderCalendarGrid(index)}</div>` : ''}
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1.5">
                                        ${icon('clock', 16, 'inline mr-1')} Horario
                                    </label>
                                    <div class="grid ${booking?.date ? 'grid-cols-3' : 'grid-cols-1'} gap-2">
                                        ${booking?.date ? availableSlots.map(slot => `
                                            <button type="button" onclick="selectTimeSlot('${slot}', ${index})" 
                                                class="p-2 text-sm rounded-lg border transition-all ${booking.time === slot ? 'bg-blue-500 text-white font-bold border-blue-500 shadow-md' : 'bg-white text-gray-700 border-gray-300 hover:bg-blue-50 hover:border-blue-400'}"
                                                ${booking.date && availableSlots.length === 0 ? 'disabled' : ''}
                                            >
                                                ${slot.split('-')[0]}
                                            </button>
                                        `).join('') : `
                                            <span class="text-sm text-gray-500 p-2 text-center col-span-full">Selecciona una fecha primero</span>
                                        `}
                                        ${booking.date && availableSlots.length === 0 ? `
                                            <span class="text-xs text-red-500 p-2 text-center col-span-full font-semibold">No hay horarios disponibles para esta fecha.</span>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>

            <div class="flex justify-between mt-8">
    <button onclick="goToPrevStep()" class="text-gray-600 hover:text-gray-800 font-semibold transition-colors duration-200 flex items-center gap-1" style="border: none; background: none; padding: 0;">
        <span style="font-size: 20px; line-height: 1;">&lsaquo;</span> <span>Cambiar Plan</span>
    </button>
    <button onclick="goToNextStep()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold rounded-xl shadow-lg hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 flex items-center gap-1">
        <span>Continuar a Datos</span> <span style="font-size: 20px; line-height: 1;">&rsaquo;</span>
    </button>
</div>
    `;
};

const renderCalendarGrid = (index) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const firstDayOfMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth(), 1);
    const lastDayOfMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 0);
    const numDays = lastDayOfMonth.getDate();
    const startPadding = (firstDayOfMonth.getDay() + 6) % 7; 

    let daysHtml = '';
    const dayNames = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
    daysHtml += '<div class="grid grid-cols-7 gap-1.5 text-xs font-bold text-gray-600 mb-2">';
    daysHtml += dayNames.map(day => `<div class="text-center">${day}</div>`).join('');
    daysHtml += '</div>';
    daysHtml += '<div class="grid grid-cols-7 gap-1.5">';
    for (let i = 0; i < startPadding; i++) {
        daysHtml += '<div></div>';
    }

for (let day = 1; day <= numDays; day++) {
    const date = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth(), day);
    const dateStr = date.toISOString().split('T')[0];
    const { available, reason } = isDateAvailable(dateStr, index);
    const isSelected = bookings[index]?.date === dateStr;
    const isSunday = date.getDay() === 0;

    let style = '';
    let textClass = '';
    let hoverHandlers = '';
    let classes = 'w-full text-sm rounded-lg transition-all duration-200 font-semibold flex items-center justify-center';

if (isSelected) {
    style = 'height: 35px; background: #22c55e; border: 2px solid #16a34a;';
    textClass = 'text-white';
    classes += ' shadow-sm';
} else if (!available) {
    if (reason === 'holiday' || isSunday) {
    style = 'height: 35px; background: #ee7678; border: none;';
    textClass = 'text-white';
    classes += ' cursor-not-allowed';
}

 else {
    style = 'height: 35px; background: #d1d5db; border: none;';
    textClass = 'text-gray-600';
    classes += ' cursor-not-allowed';
}
} else {
    style = 'height: 35px; background: #3778f1; border: none;';
    textClass = 'text-white';
    hoverHandlers = `onmouseover="this.style.background='#2563eb'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='#3b82f6'; this.style.transform='scale(1)';"`;
}
    
    const disabled = available ? '' : 'disabled';
    daysHtml += `
        <button type="button" onclick="selectDate('${dateStr}', ${index}); event.stopPropagation();" ${disabled} class="${classes} ${textClass}" style="${style}" ${hoverHandlers}>
            ${day}
        </button>
    `;
}
    
    daysHtml += '</div>';
    const monthName = calendarMonth.toLocaleDateString('es-CL', { month: 'long' });
    const year = calendarMonth.getFullYear();

       return `
    <div class="calendar-popup rounded-xl shadow-2xl pt-3 px-4 pb-4 border border-gray-200 w-72 animate-fade-in" style="position: absolute; z-index: 1000; margin-top: 8px; left: 0; top: 100%; background-color: #ffffff !important;">
            <div class="flex items-center justify-between mb-3">
                <button type="button" onclick="prevMonth(${index}); event.stopPropagation();" class="p-2 hover:bg-gray-200 rounded-lg transition-colors" style="border: none; background: transparent;">
    ${icon('chevron-left', 18, '')}
</button>
                <div class="font-bold text-gray-800 capitalize text-sm">
                    ${monthName} ${year}
                </div>
                <button type="button" onclick="nextMonth(${index}); event.stopPropagation();" class="p-2 hover:bg-gray-200 rounded-lg transition-colors" style="border: none; background: transparent;">
    ${icon('chevron-right', 18, '')}
</button>
            </div>
            ${daysHtml}
        </div>
    `;
};

const prevMonth = (index) => {
    calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() - 1, 1);
    renderStep(2);
};

const nextMonth = (index) => {
    calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 1);
    renderStep(2);
};

const renderStep3 = () => {
    if (!selectedPlan) {
        currentStep = 1;
        return renderStep1();
    }
    
    const originalPlanPrice = calculateOriginalPrice(selectedPlan);
    const finalPrice = calculateFinalPrice();
    const discountAmount = originalPlanPrice - selectedPlan.price;
    const finalDiscountAmount = selectedPlan.price - finalPrice;
    const getFieldClass = (field) => {
    const value = field === 'name' ? studentName : 
                 field === 'email' ? studentEmail :
                 field === 'emailConfirm' ? studentEmailConfirm :
                 field === 'rut' ? studentRut :
                 field === 'phone' ? studentPhone : '';
    
    const isFilled = value.trim().length > 0;
    const hasError = fieldErrors[field] && isFilled;
    
    if (hasError) {
        return 'border-2 border-red-500 bg-white text-gray-800';
    } 
    else {
        return 'border-2 border-gray-300 bg-white text-gray-800';
    }
};

    return `
        <div id="step-3-content" class="p-6" style="background-color: #ffffff; border-radius: 0 0 1rem 1rem; overflow: hidden;">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="lg:col-span-1">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Datos del Estudiante</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6" style="row-gap: 2rem;">
                    <!-- Full Name -->
                    <div style="position: relative; margin-bottom: 0.5rem;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ${icon('user', 16, 'inline mr-1')} Nombre Completo <span class="text-red-500">*</span>
                        </label>
                        <div style="position: relative;">
                            <input 
    type="text"
    name="name"
    autocomplete="name"
    value="${studentName}" 
    oninput="updateStudentInfo('name', this.value)" 
    placeholder="Juan Pérez González"
    class="w-full p-3 rounded-lg ${getFieldClass('name')}"
    style="background-color: #ffffff !important; border: 1px solid #6b7280; transition: all 0.2s; padding-right: ${studentName.trim().length > 0 && !fieldErrors.name ? '2.5rem' : '0.75rem'};"
    onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
    onblur="this.style.borderColor='#6b7280'; this.style.boxShadow=''; validateField('name'); updateFieldError('name');"
/>

                            ${studentName.trim().length > 0 && !fieldErrors.name ? `<div style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#16a34a"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>` : ''}
                        </div>
                        <div style="position: absolute; height: 20px;">
                            ${fieldErrors.name && studentName.trim().length > 0 ? '<p class="text-red-500 text-xs mt-1">Debes ingresar nombre y apellido</p>' : ''}
                        </div>
                    </div>
                    
                    <!-- RUT -->
                    <div style="position: relative; margin-bottom: 0.5rem;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ${icon('credit-card', 16, 'inline mr-1')} RUT <span class="text-red-500">*</span>
                        </label>
                        <div style="position: relative;">
                            <input 
    type="text"
    name="rut"
    autocomplete="id-number"
    value="${studentRut}" 
    oninput="updateStudentInfo('rut', this.value)" 
    onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 107 || event.charCode === 75"
    placeholder="12.345.678-9"
    maxlength="12"
    class="w-full p-3 rounded-lg ${getFieldClass('rut')}"
    style="background-color: #ffffff !important; border: 1px solid #6b7280; transition: all 0.2s; padding-right: ${studentRut.trim().length > 0 && !fieldErrors.rut ? '2.5rem' : '0.75rem'};"
    onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
    onblur="this.style.borderColor='#6b7280'; this.style.boxShadow=''; validateField('rut'); updateFieldError('rut');"
/>

                            ${studentRut.trim().length > 0 && !fieldErrors.rut ? `<div style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#16a34a"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>` : ''}
                        </div>
                        <div style="position: absolute; height: 20px;">
                            ${fieldErrors.rut && studentRut.trim().length > 0 ? '<p class="text-red-500 text-xs mt-1">RUT debe tener entre 8 y 9 dígitos</p>' : ''}
                        </div>
                    </div>

                    <!-- Email -->
                    <div style="position: relative; margin-bottom: 0.5rem;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ${icon('mail', 16, 'inline mr-1')} Correo Electrónico <span class="text-red-500">*</span>
                        </label>
                        <div style="position: relative;">
                            <input 
                                type="email" 
                                value="${studentEmail}" 
                                oninput="updateStudentInfo('email', this.value)" 
                                placeholder="juan@ejemplo.com" 
                                class="w-full p-3 rounded-lg ${getFieldClass('email')}" 
                                style="background-color: #ffffff !important; border: 1px solid #6b7280; transition: all 0.2s; padding-right: ${studentEmail.trim().length > 0 && !fieldErrors.email ? '2.5rem' : '0.75rem'};"
                                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
                                onblur="this.style.borderColor='#6b7280'; this.style.boxShadow=''; validateField('email'); updateFieldError('email');"
                            />
                            ${studentEmail.trim().length > 0 && !fieldErrors.email ? `<div style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#16a34a"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>` : ''}
                        </div>
                        <div style="position: absolute; height: 20px;">
                            ${fieldErrors.email && studentEmail.trim().length > 0 ? '<p class="text-red-500 text-xs mt-1">Correo inválido</p>' : ''}
                        </div>
                    </div>
                    
                    <!-- Confirm Email -->
                    <div style="position: relative; margin-bottom: 0.5rem;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ${icon('mail-check', 16, 'inline mr-1')} Confirmar Correo <span class="text-red-500">*</span>
                        </label>
                        <div style="position: relative;">
                            <input 
                                type="email" 
                                value="${studentEmailConfirm}" 
                                oninput="updateStudentInfo('emailConfirm', this.value)" 
                                placeholder="juan@ejemplo.com" 
                                class="w-full p-3 rounded-lg ${getFieldClass('emailConfirm')}" 
                                style="background-color: #ffffff !important; border: 1px solid #6b7280; transition: all 0.2s; padding-right: ${studentEmailConfirm.trim().length > 0 && !fieldErrors.emailConfirm ? '2.5rem' : '0.75rem'};"
                                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
                                onblur="this.style.borderColor='#6b7280'; this.style.boxShadow=''; validateField('emailConfirm'); updateFieldError('emailConfirm');"
                            />
                            ${studentEmailConfirm.trim().length > 0 && !fieldErrors.emailConfirm ? `<div style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#16a34a"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>` : ''}
                        </div>
                        <div style="position: absolute; height: 20px;">
                            ${fieldErrors.emailConfirm && studentEmailConfirm.trim().length > 0 ? '<p class="text-red-500 text-xs mt-1">Los correos no coinciden</p>' : ''}
                        </div>
                    </div>

                    <!-- Phone -->
<div style="position: relative; margin-bottom: 0.5rem;">
    <label class="block text-sm font-medium text-gray-700 mb-2">
        ${icon('phone', 16, 'inline mr-1')} Teléfono <span class="text-red-500">*</span>
    </label>
    <div style="position: relative;">
        <input 
    <input 
    type="tel"
    name="phone"
    autocomplete="tel"
    value="${studentPhone}" 
    oninput="updateStudentInfo('phone', this.value)" 
    onkeypress="return event.charCode >= 48 && event.charCode <= 57 || event.charCode === 43"
    maxlength="13"
    placeholder="+56 9 1234 5678" 
    class="w-full p-3 rounded-lg ${getFieldClass('phone')}" 
    style="background-color: #ffffff !important; border: 1px solid #6b7280; 
           transition: all 0.2s; 
           padding-right: ${studentPhone.trim().length > 0 && !fieldErrors.phone ? '2.5rem' : '0.75rem'};"
    onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
    onblur="this.style.borderColor='#6b7280'; this.style.boxShadow=''; 
            validateField('phone'); updateFieldError('phone');"
/>

        ${studentPhone.trim().length > 0 && !fieldErrors.phone ? `<div style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#16a34a"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>` : ''}
    </div>
    <div style="position: absolute; height: 20px;">
        ${fieldErrors.phone && studentPhone.trim().length > 0 ? '<p class="text-red-500 text-xs mt-1">Entre 8 y 12 dígitos</p>' : ''}
    </div>
</div>
                    
                    <!-- Reminder Checkbox -->
<div>
    <label class="block text-sm font-medium text-gray-700 mb-2">
        ${icon('bell', 16, 'inline mr-1')} Recordatorio
    </label>
    <div class="w-full p-3 border border-gray-300 rounded-lg flex items-center gap-3 bg-gray-100" style="min-height: 52px;">
        <input 
            type="checkbox" 
            id="reminder-checkbox"
            ${wantsReminder ? 'checked' : ''} 
            onchange="updateStudentInfo('reminder', this.checked)" 
            class="w-5 h-5 text-blue-500 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer flex-shrink-0"
            style="margin: 0;"
        />
        <span class="text-sm font-medium text-gray-700 flex-1" style="margin: 0; line-height: 1.3;">
            ¿Deseas recibir un recordatorio antes de tu clase?
        </span>
    </div>
</div>
            </div>

            <div class="p-6 rounded-xl" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 2px solid #e2e8f0; width: 90%; margin: 0 auto;">
                <h3 class="text-lg font-bold text-gray-800 mb-4 pb-3 flex items-center" style="border-bottom: 2px solid #3b82f6;">
                    ${icon('clipboard-list', 20, 'mr-2 text-blue-600')} Resumen
                </h3>
                
                <div class="mb-4">
    <div style="overflow-x: auto; border-radius: 0.5rem; border: 1px solid #d1d5db;">
        <table style="width: 100%; border-collapse: collapse; background: white;">
            <thead>
                <tr style="background: #f3f4f6; border-bottom: 1px solid #d1d5db;">
                    <th style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.8125rem; color: #374151; width: 10%;">Clase</th>
                    <th style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.8125rem; color: #374151; width: 15%;">Día</th>
                    <th style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.8125rem; color: #374151; width: 30%;">Fecha</th>
                    <th style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.8125rem; color: #374151; width: 20%;">Horario</th>
                    <th style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.8125rem; color: #374151; width: 25%;">Profesor</th>
                </tr>
            </thead>
            <tbody>
                ${bookings
    .map((booking, originalIndex) => ({ booking, originalIndex }))
    .filter(item => item.booking.date)
    .sort((a, b) => {
        // Sort by date, then by time
        if (a.booking.date !== b.booking.date) {
            return new Date(a.booking.date) - new Date(b.booking.date);
        }
        // If same date, sort by time
        const timeA = a.booking.time ? a.booking.time.split('-')[0] : '00:00';
        const timeB = b.booking.time ? b.booking.time.split('-')[0] : '00:00';
        return timeA.localeCompare(timeB);
    })
    .map((item, sortedIndex) => {
        const booking = item.booking;
        const date = new Date(booking.date + 'T12:00:00');
        const dayName = date.toLocaleDateString('es-CL', { weekday: 'long' });
        const day = date.getDate();
        const month = date.toLocaleDateString('es-CL', { month: 'long' });
        const year = date.getFullYear();
        
        return `
        <tr style="background: ${sortedIndex % 2 === 0 ? '#ffffff' : '#fafaf9'}; border-bottom: 1px solid #e5e7eb; transition: background-color 0.15s;">
            <td style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 500; color: #374151; font-size: 0.8125rem;">${sortedIndex + 1}</td>
                        <td style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 500; color: #374151; font-size: 0.8125rem; text-transform: capitalize;">${dayName}</td>
                        <td style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 500; color: #374151; font-size: 0.8125rem;">${day} de ${month} de ${year}</td>
                        <td style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 500; color: #374151; font-size: 0.8125rem;">
                            <span style="display: inline-flex; align-items: center; gap: 0.375rem; justify-content: center;">
                                ${icon('clock', 14, 'text-amber-600')}
                                ${booking.time ? booking.time : 'Pendiente'}
                            </span>
                        </td>
                        <td style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 500; color: #374151; font-size: 0.8125rem;">
                            <span style="display: inline-flex; align-items: center; gap: 0.375rem; justify-content: center;">
                                ${icon('user', 14, 'text-amber-600')}
                                Alexis Inostroza Díaz
                            </span>
                        </td>
                    </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    </div>
    <p class="text-xs text-gray-500 mt-2 text-center" >
        Las clases se muestran ordenadas cronológicamente
    </p>
</div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        ${icon('ticket', 16, 'inline mr-1')} ¿Tienes un código de descuento?
                    </label>
                    <div class="flex gap-2">
    <input 
        type="text" 
        value="${discountCode}" 
        oninput="discountCode=this.value.toUpperCase();" 
        placeholder="PROMO10" 
        maxlength="10"
        class="p-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700" 
        style="width: 250px;"
    />
    <button 
        onclick="applyDiscount(discountCode)" 
        class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all shadow-md whitespace-nowrap text-sm"
    >
        Aplicar
    </button>
</div>
                    ${appliedDiscount ? `
                        <p class="text-xs text-emerald-600 mt-1.5 font-semibold flex items-center gap-1">
                            ${icon('check-circle', 14, '')} ${appliedDiscount.description} (${appliedDiscount.percent}%)
                        </p>
                    ` : ''}
                </div>

                <div class="space-y-2 text-sm">
                    <div class="flex justify-between py-1">
                        <span class="text-gray-600 font-medium">Plan seleccionado:</span>
                        <span class="font-semibold text-gray-800">${selectedPlan.classes} ${selectedPlan.classes === 1 ? 'clase' : 'clases'}</span>
                    </div>
                    
                    <div class="flex justify-between py-1">
                        <span class="text-gray-600 font-medium">Precio base:</span>
                        <span class="font-semibold text-gray-800">${formatCurrency(originalPlanPrice)}</span>
                    </div>

                    ${selectedPlan.savings > 0 ? `
                        <div class="flex justify-between py-2 px-3 rounded" style="background: linear-gradient(to right, #ecfdf5, #d1fae5);">
                            <span class="text-green-700 font-medium flex items-center gap-1">
                                ${icon('trending-down', 14, '')} Ahorro por Plan (${selectedPlan.savings}%):
                            </span>
                            <span class="text-green-700 font-bold">- ${formatCurrency(discountAmount)}</span>
                        </div>
                    ` : ''}

                    ${appliedDiscount ? `
                        <div class="flex justify-between py-2 px-3 rounded" style="background: linear-gradient(to right, #faf5ff, #f3e8ff);">
                            <span class="text-purple-700 font-medium flex items-center gap-1">
                                ${icon('ticket', 14, '')} Descuento aplicado (${appliedDiscount.percent}%):
                            </span>
                            <span class="text-purple-700 font-bold">- ${formatCurrency(finalDiscountAmount)}</span>
                        </div>
                    ` : ''}

                    <div class="flex justify-between py-3 mt-3" style="border-top: 3px solid #10b981; border-bottom: 3px solid #10b981;">
                        <span class="text-lg font-bold text-gray-900">TOTAL A PAGAR:</span>
                        <span class="text-xl font-bold text-green-600">${formatCurrency(finalPrice)}</span>
                    </div>
                </div>
           </div>
            
            <div class="flex justify-between mt-6 border-t pt-4">
                <button onclick="goToPrevStep()" class="text-gray-600 hover:text-gray-800 font-semibold transition-all duration-200 flex items-center gap-1" style="border: none; background: none; padding: 0;">
                    <span style="font-size: 20px; line-height: 1;">&lsaquo;</span> <span>Modificar Horarios</span>
                </button>
                <button onclick="handleConfirmPayment()" 
                    class="px-8 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl shadow-lg hover:from-green-600 hover:to-emerald-700 transition-all duration-300 flex items-center gap-1 ${Object.keys(fieldErrors).length === 0 ? '' : 'opacity-50 cursor-not-allowed'}"
                    ${Object.keys(fieldErrors).length === 0 ? '' : 'disabled'}
                >
                    <span>Continuar a Pagar</span> <span style="font-size: 20px; line-height: 1;">&rsaquo;</span>
                </button>
            </div>
        </div>
    `;
};

function handleCalendarClickOutside(event) {
    const calendar = document.querySelector('.calendar-popup');
    if (!calendar) {
        document.removeEventListener('click', handleCalendarClickOutside);
        return;
    }
    const clickedInsideCalendar = calendar.contains(event.target);
    const clickedDateButton = event.target.closest('button[onclick*="toggleCalendar"]');
    
    if (!clickedInsideCalendar && !clickedDateButton) {
        activeCalendar = null;
        document.removeEventListener('click', handleCalendarClickOutside);
        renderStep(2);
    }
}
const renderStep = (step, shouldAnimate = false) => {
    let content = '';
    document.removeEventListener('click', handleCalendarClickOutside);
    if (step === 1) {
        content = renderStep1();
    } else if (step === 2) {
        content = renderStep2();
    } else if (step === 3) {
        content = renderStep3();
    }
    const container = document.querySelector('#booking-system-container .max-w-6xl');
    if (container) {
        container.innerHTML = `${renderHeader()}<div id="booking-system-content">${content}</div>`;
    } else {

    document.getElementById('booking-system-container').innerHTML = `
        <div class="min-h-screen py-12 px-4"> 
            <div class="max-w-6xl mx-auto rounded-2xl shadow-xl" style="background-color: #fff;">
                ${renderHeader()}
                <div id="booking-system-content">${content}</div>
            </div>
        </div>
    `;
}
    if (shouldAnimate) {
        scrollToTop();
    }
    if (shouldAnimate) {
        const stepContentDiv = document.getElementById(`step-${step}-content`);
        if (stepContentDiv) {
            stepContentDiv.classList.remove('animate-fade-in'); 
            void stepContentDiv.offsetWidth; 
            stepContentDiv.classList.add('animate-fade-in'); 
        }
    }
    lucide.createIcons();
    if (step === 2 && activeCalendar !== null) {
        setTimeout(() => {
            document.addEventListener('click', handleCalendarClickOutside);
        }, 100);
    }
};
const renderApp = () => {
    const container = document.getElementById('booking-system-container');
    container.innerHTML = `
        <div class="min-h-screen py-12 px-4"> 
            <div class="max-w-6xl mx-auto rounded-2xl shadow-xl" style="background-color: #fff;">
                ${renderHeader()}
                <div id="booking-system-content"></div>
            </div>
        </div>
    `;
    renderStep(currentStep);
};
document.addEventListener('DOMContentLoaded', renderApp);

</script>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

<script src="../../js/layout.js"></script>
<script src="../../js/script.js" defer></script>

</body>
</html>

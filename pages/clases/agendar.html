<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enbreak | Agendar Clase</title>
    <link rel="icon" type="image/x-icon" href="../../favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="../../favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../favicon/apple-touch-icon.png">
    <link rel="manifest" href="../../favicon/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/css/flag-icons.min.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Rubik:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        [data-lucide] {
            display: inline-block;
            vertical-align: middle;
        }
        [data-lucide] svg {
            display: block;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Your page content goes here -->
<style>

.page-header {
    position: relative;
    width: 100%;
    background: #ffffff;
    border-bottom: 1px solid #d2d2d2;
}

.page-header::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 55%;
    height: 100%;
    background: url('../../assets/banners/banner2.jpg') left 50% / cover no-repeat;
    filter: contrast(1.05) brightness(1.15);
    opacity: 0.45;
    pointer-events: none;
    mask-image: linear-gradient(to left,
        rgba(0,0,0,1) 0%,
        rgba(0,0,0,0.9) 70%,
        rgba(0,0,0,0) 100%);
    -webkit-mask-image: linear-gradient(to left,
        rgba(0,0,0,1) 0%,
        rgba(0,0,0,0.9) 70%,
        rgba(0,0,0,0) 100%);
    animation: bannerImageSlideIn 1s ease-out;
}

.page-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 60%;
    height: 100%;
    background: linear-gradient(to left,
        transparent 0%,
        rgba(255, 255, 255, 0.05) 50%,
        rgba(255, 255, 255, 0.2) 100%);
    pointer-events: none;
    z-index: 1;
}

.page-header-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    min-height: 140px;
    position: relative;
    display: flex;
    align-items: center;
}

.page-header-content {
    padding: 30px 40px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 8px;
    position: relative;
    z-index: 1;
    max-width: 520px;
    animation: bannerTextSlideIn 1s ease-out;
}

.page-header-image {
    display: none;
}

.page-header-accent {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 60px;
    background: #ff6600;
    z-index: 2;
}

.page-header .breadcrumb {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
}

.page-header .breadcrumb a {
    color: #6b7280;
    text-decoration: none;
    transition: color 0.2s ease;
}

.page-header .breadcrumb a:hover {
    color: #ff6600;
}

.page-header .breadcrumb-separator {
    color: #d1d5db;
    font-size: 9px;
}

.page-header .breadcrumb-current {
    color: #374151;
    font-weight: 500;
}

.page-header h1 {
    font-family: 'Rubik', sans-serif;
    font-size: 32px;
    font-weight: 700;
    color: #0a1e42;
    margin: 0;
    line-height: 1.2;
}

/* Responsive */
@media (max-width: 768px) {
    .page-header {
        background: #ffffff;
    }

    .page-header::after {
        display: none;
    }

    .page-header-wrapper {
        min-height: auto;
    }

    .page-header-content {
        padding: 24px 20px;
    }

    .page-header h1 {
        font-size: 24px;
    }
}

/* Banner animations */
@keyframes bannerTextSlideIn {
    from {
        opacity: 0;
        transform: translateX(-60px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes bannerImageSlideIn {
    from {
        opacity: 0;
        transform: translateX(40px);
    }
    to {
        opacity: 0.45;
        transform: translateX(0);
    }
}

@keyframes slide-in {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slide-out {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

@keyframes fade-in {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

.animate-slide-in {
    animation: slide-in 0.3s ease-out;
}

.animate-fade-in {
    animation: fade-in 0.2s ease-out;
}

#booking-system-container {
    font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    line-height: 1.6;
}

#booking-system-container *,
#booking-system-container *::before,
#booking-system-container *::after {
    box-sizing: border-box;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

#booking-system-container {
    --color-primary: #3b82f6;
    --color-secondary: #4f46e5;
    --color-success: #10b981;
    --color-warning: #f97316;
    --color-danger: #ef4444;
    --color-gray-100: #f3f4f6;
    --color-gray-200: #d1d5db;
    --color-gray-300: #9ca3af;
    --color-gray-600: #4b5563;
    --color-gray-700: #374151;
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.12);
    --shadow-xl: 0 20px 35px rgba(0, 0, 0, 0.15);
    --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

#booking-system-container input:not([type="checkbox"]):not([type="radio"]),
#booking-system-container select,
#booking-system-container button {
    outline: none;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

#booking-system-container button[class*="bg-gradient-to-r"] {
    position: relative;
    overflow: hidden;
    z-index: 1;
    border: none;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
}

#booking-system-container button[class*="bg-gradient-to-r"]:hover {
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.6);
}

#booking-system-container input:focus,
#booking-system-container select:focus {
    border-color: var(--color-primary) !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

#step-3-content input:focus,
#step-3-content select:focus {
    background-color: #ffffff !important;
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    color: #374151 !important;
    outline: none !important;
}

#booking-notification {
    box-shadow: var(--shadow-xl);
}

#booking-system-container .w-10.h-10.rounded-full.flex.items-center.justify-center.font-bold.text-lg.bg-blue-500.text-white {
    background-color: var(--color-primary) !important;
    color: white !important;
    border-color: var(--color-primary) !important;
}

#booking-system-container .w-10.h-10.rounded-full.flex.items-center.justify-center.font-bold.text-lg:not(.bg-blue-500):not(.text-white) {
    background-color: var(--color-gray-200) !important;
    color: var(--color-gray-700) !important;
    border-color: var(--color-gray-300) !important;
}

#booking-system-container .grid > div[onclick*="selectPlan"] {
    background-color: #ffffff !important;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--color-gray-200);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

#booking-system-container .grid > div[onclick*="selectPlan"]:hover {
    box-shadow: var(--shadow-lg);
    border-color: rgba(59, 130, 246, 0.5);
    transform: translateY(-2px);
}

#booking-system-container .grid > div[class*="scale-102"][class*="border-blue-500"] {
    border-color: var(--color-primary);
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2);
    transform: scale(1.02) translateY(-2px);
}

#booking-system-container .grid > div.border-orange-500 {
    border-color: var(--color-warning) !important;
    border-width: 2px !important;
}

#booking-system-container .grid > div.border-purple-500 {
    border-color: #a855f7 !important;
    border-width: 2px !important;
}

#booking-system-container .popular-badge {
    background: linear-gradient(to right, #f97316, #ef4444);
    padding: 4px 12px;
}

#booking-system-container .bg-clip-text {
    background-clip: text;
    -webkit-background-clip: text;
    color: transparent;
    background-image: linear-gradient(to right, #2563eb, #4f46e5);
}

#booking-system-container .flex { display: flex; }
#booking-system-container .inline-flex { display: inline-flex; }
#booking-system-container .grid { display: grid; }
#booking-system-container .inline-block { display: inline-block; }
#booking-system-container .block { display: block; }
#booking-system-container .hidden { display: none; }
#booking-system-container .items-center { align-items: center; }
#booking-system-container .items-start { align-items: flex-start; }
#booking-system-container .justify-center { justify-content: center; }
#booking-system-container .justify-between { justify-content: space-between; }
#booking-system-container .flex-1 { flex: 1 1 0%; }
#booking-system-container .flex-shrink-0 { flex-shrink: 0; }
#booking-system-container .space-y-4 > * + * { margin-top: 1rem; }
#booking-system-container .space-y-6 > * + * { margin-top: 1.5rem; }
#booking-system-container .space-y-8 > * + * { margin-top: 2rem; }
#booking-system-container .gap-1 { gap: 0.25rem; }
#booking-system-container .gap-2 { gap: 0.5rem; }
#booking-system-container .gap-3 { gap: 0.75rem; }
#booking-system-container .gap-4 { gap: 1rem; }
#booking-system-container .gap-6 { gap: 1.5rem; }
#booking-system-container .gap-8 { gap: 2rem; }
#booking-system-container .gap-16 { gap: 4rem; }
#booking-system-container .gap-1\.5 { gap: 0.375rem; }
#booking-system-container .grid-cols-7 { grid-template-columns: repeat(7, minmax(0, 1fr)); }
#booking-system-container .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }

@media (min-width: 768px) {
    #booking-system-container .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    #booking-system-container .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
}

@media (min-width: 1024px) {
    #booking-system-container .lg\:grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
}

#booking-system-container .m-0 { margin: 0; }
#booking-system-container .mb-1 { margin-bottom: 0.25rem; }
#booking-system-container .mb-2 { margin-bottom: 0.5rem; }
#booking-system-container .mb-3 { margin-bottom: 0.75rem; }
#booking-system-container .mb-4 { margin-bottom: 1rem; }
#booking-system-container .mb-6 { margin-bottom: 1.5rem; }
#booking-system-container .mb-8 { margin-bottom: 2rem; }
#booking-system-container .mb-12 { margin-bottom: 3rem; }
#booking-system-container .mt-1 { margin-top: 0.25rem; }
#booking-system-container .mt-2 { margin-top: 0.5rem; }
#booking-system-container .mt-4 { margin-top: 1rem; }
#booking-system-container .mt-6 { margin-top: 1.5rem; }
#booking-system-container .mt-8 { margin-top: 2rem; }
#booking-system-container .ml-auto { margin-left: auto; }
#booking-system-container .mr-1 { margin-right: 0.25rem; }
#booking-system-container .mr-2 { margin-right: 0.5rem; }
#booking-system-container .mr-3 { margin-right: 0.75rem; }
#booking-system-container .mx-2 { margin-left: 0.5rem; margin-right: 0.5rem; }
#booking-system-container .mx-auto { margin-left: auto; margin-right: auto; }
#booking-system-container .p-3 { padding: 0.75rem; }
#booking-system-container .p-4 { padding: 1rem; }
#booking-system-container .p-6 { padding: 1.5rem; }
#booking-system-container .p-8 { padding: 2rem; }
#booking-system-container .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
#booking-system-container .px-4 { padding-left: 1rem; padding-right: 1rem; }
#booking-system-container .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
#booking-system-container .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
#booking-system-container .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
#booking-system-container .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
#booking-system-container .py-12 { padding-top: 0.75rem; padding-bottom: 3rem; }
#booking-system-container .pt-3 { padding-top: 0.75rem; }
#booking-system-container .pb-2 { padding-bottom: 0.5rem; }
#booking-system-container .pb-4 { padding-bottom: 1rem; }
#booking-system-container .pb-10 { padding-bottom: 2.5rem; }
#booking-system-container .w-6 { width: 1.5rem; }
#booking-system-container .w-10 { width: 2.5rem; }
#booking-system-container .w-16 { width: 4rem; }
#booking-system-container .w-32 { width: 8rem; }
#booking-system-container .w-72 { width: 18rem; }
#booking-system-container .w-full { width: 100%; }
#booking-system-container .h-1 { height: 0.25rem; }
#booking-system-container .h-2 { height: 0.5rem; }
#booking-system-container .h-6 { height: 1.5rem; }
#booking-system-container .h-8 { height: 2rem; }
#booking-system-container .h-10 { height: 2.5rem; }
#booking-system-container .min-h-screen { min-height: 100vh; }
#booking-system-container .max-w-6xl { max-width: 72rem; }
#booking-system-container .max-w-md { max-width: 28rem; }
#booking-system-container .max-w-4xl { max-width: 56rem; }
#booking-system-container .relative { position: relative; }
#booking-system-container .fixed { position: fixed; }
#booking-system-container .top-4 { top: 1rem; }
#booking-system-container .right-4 { right: 1rem; }
#booking-system-container .z-50 { z-index: 50; }
#booking-system-container .bg-white { background-color: #ffffff; }
#booking-system-container .bg-gray-50 { background-color: #f9fafb; }
#booking-system-container .bg-gray-100 { background-color: #f3f4f6; }
#booking-system-container .bg-gray-200 { background-color: var(--color-gray-200); }
#booking-system-container .bg-gray-300 { background-color: var(--color-gray-300); }
#booking-system-container .bg-blue-400 { background-color: #3b82f6; }
#booking-system-container .bg-red-400 { background-color: #ef8b8b; }
#booking-system-container .bg-green-500 { background-color: #22c55e; }
#booking-system-container .bg-blue-50 { background-color: #eff6ff; }
#booking-system-container .bg-blue-500 { background-color: #3b82f6; }
#booking-system-container .bg-green-50 { background-color: #f0fdf4; }
#booking-system-container .bg-green-100 { background-color: #dcfce7; }
#booking-system-container .bg-red-50 { background-color: #fef2f2; }
#booking-system-container .bg-red-500 { background-color: #ef4444; }
#booking-system-container .bg-emerald-50 { background-color: #ecfdf5; }
#booking-system-container .bg-gradient-to-br { background-image: linear-gradient(to bottom right, #f8fafc, #eff6ff, #eef2ff); }
#booking-system-container .bg-gradient-to-r { background-image: linear-gradient(to right, var(--gradient-from), var(--gradient-to)); }
#booking-system-container .from-blue-500 { --gradient-from: #3b82f6; }
#booking-system-container .to-indigo-600 { --gradient-to: #4f46e5; }
#booking-system-container .from-blue-600 { --gradient-from: #2563eb; }
#booking-system-container .to-indigo-700 { --gradient-to: #4338ca; }
#booking-system-container .from-green-500 { --gradient-from: #22c55e; }
#booking-system-container .to-emerald-600 { --gradient-to: #059669; }
#booking-system-container .from-orange-500 { --gradient-from: #f97316; }
#booking-system-container .to-orange-600 { --gradient-to: #ea580c; }
#booking-system-container .from-purple-500 { --gradient-from: #a855f7; }
#booking-system-container .to-pink-500 { --gradient-to: #ec4899; }
#booking-system-container .from-purple-600 { --gradient-from: #9333ea; }
#booking-system-container .to-pink-600 { --gradient-to: #db2777; }
#booking-system-container .text-white { color: #ffffff; }
#booking-system-container .text-gray-400 { color: var(--color-gray-300); }
#booking-system-container .text-gray-500 { color: #6b7280; }
#booking-system-container .text-gray-600 { color: var(--color-gray-600); }
#booking-system-container .text-gray-700 { color: var(--color-gray-700); }
#booking-system-container .text-gray-800 { color: #1f2937; }
#booking-system-container .text-blue-500 { color: #3b82f6; }
#booking-system-container .text-blue-600 { color: #2563eb; }
#booking-system-container .text-blue-800 { color: #1e40af; }
#booking-system-container .text-green-700 { color: #15803d; }
#booking-system-container .text-emerald-600 { color: #059669; }
#booking-system-container .text-red-500 { color: #ef4444; }
#booking-system-container .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
#booking-system-container .text-xs { font-size: 0.8125rem; line-height: 1.125rem; }
#booking-system-container .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
#booking-system-container .text-2xl { font-size: 1.5rem; line-height: 2rem; }
#booking-system-container .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
#booking-system-container .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
#booking-system-container .font-medium { font-weight: 500; }
#booking-system-container .font-semibold { font-weight: 600; }
#booking-system-container .font-bold { font-weight: 700; }
#booking-system-container .text-center { text-align: center; }
#booking-system-container .text-left { text-align: left; }
#booking-system-container .line-through { text-decoration: line-through; }
#booking-system-container .capitalize { text-transform: capitalize; }
#booking-system-container .border { border-width: 1px; }
#booking-system-container .border-2 { border-width: 2px; }
#booking-system-container .border-gray-200 { border-color: var(--color-gray-200); }
#booking-system-container .border-gray-300 { border-color: #d1d5db; }
#booking-system-container .border-blue-300 { border-color: #93c5fd; }
#booking-system-container .border-blue-500 { border-color: #3b82f6; }
#booking-system-container .border-emerald-400 { border-color: #4ade80; }
#booking-system-container .border-orange-500 { border-color: #f97316; }
#booking-system-container .border-red-400 { border-color: #f87171; }
#booking-system-container .border-red-500 { border-color: #ef4444; }
#booking-system-container .border-green-600 { border-color: #16a34a; }
#booking-system-container .border-gray-400 { border-color: #9ca3af; }
#booking-system-container .rounded-lg { border-radius: 0.5rem; }
#booking-system-container .rounded-xl { border-radius: 0.75rem; }
#booking-system-container .rounded-2xl { border-radius: 1rem; }
#booking-system-container .rounded-full { border-radius: 9999px; }
#booking-system-container .shadow-md { box-shadow: var(--shadow-md); }
#booking-system-container .shadow-lg { box-shadow: var(--shadow-lg); }
#booking-system-container .shadow-xl { box-shadow: var(--shadow-xl); }
#booking-system-container .shadow-2xl { box-shadow: var(--shadow-2xl); }
#booking-system-container .ring-2 { box-shadow: 0 0 0 2px currentColor; }
#booking-system-container .ring-4 { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5); }
#booking-system-container .ring-offset-2 { box-shadow: 0 0 0 2px var(--color-gray-50), 0 0 0 4px currentColor; }
#booking-system-container .ring-blue-300 { box-shadow: 0 0 0 4px rgba(147, 197, 253, 0.5); }
#booking-system-container .ring-green-300 { box-shadow: 0 0 0 4px rgba(110, 231, 183, 0.5); }
#booking-system-container .ring-orange-400 { box-shadow: 0 0 0 4px rgba(251, 146, 60, 0.5); }
#booking-system-container .transition-all { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
#booking-system-container .duration-300 { transition-duration: 0.3s; }
#booking-system-container .scale-102 { transform: scale(1.02); }
#booking-system-container .hover\:scale-102:hover { transform: scale(1.02); }
#booking-system-container .hover\:shadow-2xl:hover { box-shadow: var(--shadow-2xl); }
#booking-system-container .hover\:border-blue-300:hover { border-color: #93c5fd; }
#booking-system-container .hover\:from-blue-600:hover { --gradient-from: #2563eb; }
#booking-system-container .hover\:to-indigo-700:hover { --gradient-to: #4338ca; }
#booking-system-container .cursor-pointer { cursor: pointer; }
#booking-system-container .cursor-not-allowed { cursor: not-allowed; }
#booking-system-container .hover\:bg-blue-500:hover { background-color: #3b82f6; }
#booking-system-container .hover\:bg-blue-50:hover { background-color: #eff6ff; }
#booking-system-container .hover\:bg-blue-600:hover { background-color: #2563eb; }
#booking-system-container .hover\:border-blue-400:hover { border-color: #60a5fa; }
#booking-system-container .hover\:shadow-sm:hover { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }

#booking-system-content {
    min-height: 400px;
}

input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus {
    -webkit-box-shadow: 0 0 0 1000px #ffffff inset !important;
    box-shadow: 0 0 0 1000px #ffffff inset !important;
    -webkit-text-fill-color: #000 !important;
    transition: background-color 9999s ease-in-out 0s;
}

.select-plan-btn,
.select-plan-btn:active,
.select-plan-btn:visited {
    width: 100%;
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    background: #ff6600 !important;
    background-color: #ff6600 !important;
    color: white !important;
    border: none !important;
    cursor: pointer !important;
    box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3) !important;
    transform: translateY(0) !important;
    transition: background 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease !important;
}

.select-plan-btn:hover {
    background: linear-gradient(135deg, #ff6600 0%, #ff8533 100%) !important;
    background-color: #ff6600 !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 16px rgba(255, 102, 0, 0.4) !important;
    color: white !important;
}

.select-plan-btn:focus,
.select-plan-btn:focus-visible {
    outline: none !important;
    background: #ff6600 !important;
    background-color: #ff6600 !important;
    color: white !important;
}

/* ===== SEMANTIC COMPONENT STYLES ===== */

/* Step Progress Indicator */
.step-progress-container {
    padding: 0 1.5rem;
    padding-bottom: 0;
}

.step-progress-wrapper {
    width: 100%;
    margin-top: 1.5rem;
}

.step-indicators {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 0.5rem;
}

.step-indicator {
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
    transition: all 0.3s;
}

.step-indicator.clickable {
    cursor: pointer;
}

.step-indicator.clickable:hover {
    background-color: #2563eb;
}

.step-tooltip {
    position: relative;
}

.step-tooltip::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%) scale(0);
    background: #1f2937;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s ease;
    z-index: 1000;
}

.step-tooltip::before {
    content: '';
    position: absolute;
    bottom: calc(100% + 2px);
    left: 50%;
    transform: translateX(-50%) scale(0);
    border: 6px solid transparent;
    border-top-color: #1f2937;
    opacity: 0;
    transition: all 0.2s ease;
    z-index: 1000;
}

.step-tooltip:hover::after,
.step-tooltip:hover::before {
    transform: translateX(-50%) scale(1);
    opacity: 1;
}

.step-line {
    height: 0.25rem;
    border-radius: 0.25rem;
    transition: all 0.3s;
}

.step-labels {
    display: flex;
    justify-content: center;
    align-items: center;
}

.step-label {
    font-size: 0.75rem;
    font-weight: 500;
}

/* Plan Grid */
.plan-grid {
    display: grid;
    grid-template-columns: repeat(1, minmax(0, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
    margin-top: 2rem;
}

@media (min-width: 768px) {
    .plan-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
    }
}

@media (min-width: 1024px) {
    .plan-grid {
        grid-template-columns: repeat(5, minmax(0, 1fr));
    }
}

/* Plan Card */
.plan-card {
    position: relative;
    border-radius: 1rem;
    padding: 2rem;
    background-color: #ffffff;
    min-height: 220px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: all 0.3s ease;
    z-index: 1;
    transform: scale(1);
    box-shadow: none;
}

.plan-card:hover {
    transform: scale(1.03) !important;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15) !important;
    z-index: 10 !important;
}

.plan-card-content {
    text-align: center;
}

.plan-classes-count {
    font-size: 2.25rem;
    line-height: 2.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.plan-classes-label {
    font-size: 0.875rem;
    line-height: 1.25rem;
    color: #4b5563;
    margin-bottom: 1rem;
}

.plan-price {
    font-size: 1.875rem;
    line-height: 2.25rem;
    font-weight: 700;
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.plan-price-label {
    font-size: 0.75rem;
    line-height: 1rem;
    color: #6b7280;
    margin-top: 0.25rem;
    margin-bottom: 0.5rem;
}

.plan-savings-badge {
    font-size: 0.75rem;
    line-height: 1rem;
    font-weight: 600;
    background-color: #f0fdf4;
    color: #15803d;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    display: inline-block;
}

.plan-total-price {
    font-size: 0.875rem;
    line-height: 1.25rem;
    color: #4b5563;
    margin-top: 0.5rem;
}

/* Disclaimer Box */
.disclaimer-box {
    border: 1px solid #81C7D4;
    padding: 1rem;
    border-radius: 0.75rem;
    margin-top: 1rem;
    margin-left: auto;
    margin-right: auto;
    background-color: #E0F5F7;
    max-width: 600px;
}

.disclaimer-content {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

.disclaimer-icon {
    color: #3B8A9D;
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    min-width: 20px;
    margin-top: 2px;
}

.disclaimer-text {
    font-size: 0.875rem;
    line-height: 1.25rem;
    color: #3B8A9D;
    line-height: 1.6;
}

.disclaimer-list {
    margin: 8px 0 0 0;
    padding-left: 20px;
    list-style-type: disc;
}

/* Section Headers */
.section-header {
    font-size: 1.5rem;
    line-height: 2rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 2.5rem;
    text-align: center;
    animation: none !important;
    transition: none !important;
}

/* Step Content Container */
.step-content {
    padding: 1.5rem;
    border-radius: 0 0 1rem 1rem;
    overflow: visible;
    animation: none !important;
    transition: none !important;
}

/* Date Grid */
.date-grid {
    display: grid;
    grid-template-columns: repeat(1, minmax(0, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
    position: relative;
}

@media (min-width: 768px) {
    .date-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        overflow: visible !important;
    }
}

/* Date Button */
.date-button {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid;
    text-align: left;
    font-size: 0.875rem;
    line-height: 1.25rem;
    font-weight: 500;
    transition: all 0.2s;
    border-radius: 0.5rem;
    cursor: pointer;
}

.date-button.selected {
    background-color: #3b82f6;
    color: white;
    border-color: #3b82f6;
    font-weight: 700;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.date-button.selected:hover {
    background-color: #2563eb;
}

.date-button:not(.selected) {
    background-color: white;
    color: #374151;
    border-color: #d1d5db;
}

.date-button:not(.selected):hover {
    background-color: #eff6ff;
    border-color: #60a5fa;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

/* Time Slot Button */
.time-slot-button {
    padding: 0.5rem;
    font-size: 0.875rem;
    line-height: 1.25rem;
    border-radius: 0.5rem;
    border: 1px solid;
    transition: all 0.2s;
    cursor: pointer;
}

.time-slot-button.selected {
    background-color: #3b82f6;
    color: white;
    font-weight: 700;
    border-color: #3b82f6;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.time-slot-button:not(.selected) {
    background-color: #eff6ff;
    color: #374151;
    border-color: #bfdbfe;
}

.time-slot-button:not(.selected):hover {
    background-color: #dbeafe;
    border-color: #60a5fa;
}

/* Calendar Popup */
.calendar-popup {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 1rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    padding: 1rem;
    width: 320px;
    max-width: 90vw;
}

.calendar-popup .calendar-nav-btn {
    background: transparent;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    border-radius: 0.5rem;
    transition: background-color 0.2s;
    color: #374151;
    font-size: 18px;
}

.calendar-popup .calendar-nav-btn:hover {
    background-color: #f3f4f6;
}

/* Booking Summary */
.booking-summary-container {
    margin-bottom: 2rem;
    overflow: visible;
}

.booking-summary-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    overflow: visible;
}

/* Step 2 - New Unified Calendar System */
.step2-main-content {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    min-height: 600px;
    gap: 0;
}

.step2-calendar-section {
    padding: 1.5rem;
    border-right: 1px solid #e5e7eb;
    background: white;
}

.step2-calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding: 0 0.5rem;
}

.step2-month-display {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    text-transform: capitalize;
    text-align: center;
}

.step2-month-nav {
    display: flex;
    gap: 0.5rem;
}

.step2-nav-btn {
    width: 36px;
    height: 36px;
    border: 2px solid #e2e8f0;
    background: white;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: #64748b;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    flex-shrink: 0;
}

.step2-nav-btn:hover {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
}

.step2-calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
    padding: 0.5rem;
}

.step2-day-name {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
    padding: 0.5rem 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.step2-day-cell {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    border: 1.5px solid transparent;
}

.step2-day-cell.empty {
    cursor: default;
}

.step2-day-cell.available {
    background: #dbeafe;
    color: #2563eb;
    border-color: #3b82f6;
}

.step2-day-cell.available:hover {
    background: #bfdbfe;
    color: #1e40af;
    border-color: #2563eb;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
}

.step2-day-cell.disabled {
    background: #f9fafb;
    color: #d1d5db;
    cursor: not-allowed;
    border-color: #e5e7eb;
}

.step2-day-cell.holiday {
    background: #fef2f2;
    color: #ef4444;
    cursor: not-allowed;
    border-color: #fecaca;
}

.step2-day-cell.booked {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.step2-day-cell.booked:hover {
    background: #2563eb;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
}

.step2-day-cell.selected {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
}

.step2-badge {
    position: absolute;
    top: 2px;
    right: 2px;
    background: white;
    color: #3b82f6;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 0.65rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.step2-sidebar {
    background: white;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
}

.step2-locked-classes {
    margin-bottom: 0.75rem;
}

.step2-locked-classes h3 {
    font-size: 0.75rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 1rem;
    font-weight: 600;
}

#step2LockedClassesList {
    height: calc((4 * (3.25rem + 0.75rem)) - 0.75rem);
    overflow-y: scroll;
    overflow-x: hidden;
    padding-right: 0.5rem;
    margin-top: 1rem;
}

#step2LockedClassesList::-webkit-scrollbar {
    width: 6px;
}

#step2LockedClassesList::-webkit-scrollbar-track {
    background: #f3f4f6;
    border-radius: 3px;
}

#step2LockedClassesList::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 3px;
}

#step2LockedClassesList::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
}

.step2-locked-class {
    background: white;
    border: 1px solid #3b82f6;
    border-radius: 10px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.step2-class-number {
    width: 24px;
    height: 24px;
    background: #3b82f6;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.70rem;
    flex-shrink: 0;
}

.step2-class-info {
    flex: 1;
    display: flex;
    align-items: center;
}

.step2-class-date {
    font-size: 0.78rem;
    color: #1f2937;
    font-weight: 600;
}

.step2-class-time {
    font-size: 0.8rem;
    color: #6b7280;
}

.step2-class-actions {
    display: flex;
    gap: 0.5rem;
}

.step2-action-btn {
    padding: 0.375rem 0.625rem;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: white;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
}

.step2-action-btn.modify {
    color: #3b82f6;
    border-color: #bfdbfe;
}

.step2-action-btn.modify:hover {
    background: #eff6ff;
    border-color: #bfdbfe;
}

.step2-action-btn.delete {
    color: #ef4444;
    border-color: #fecaca;
}

.step2-action-btn.delete:hover {
    background: #fef2f2;
    border-color: #fecaca;
}

.step2-current-selection {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    border: 2px solid #3b82f6;
    margin-top: 0.5rem;
}

.step2-selection-header {
    font-size: 0.875rem;
    color: #3b82f6;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.step2-selection-date {
    font-size: 0.875rem;
    color: #1f2937;
    font-weight: 600;
    margin-bottom: 1rem;
}

.step2-time-slots {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
}

.step2-time-slot {
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    background: white;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.75rem;
    font-weight: 500;
}

.step2-time-slot:hover:not(.unavailable) {
    background: #eff6ff;
    border-color: #3b82f6;
}

.step2-time-slot.selected {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.step2-time-slot.selected:hover {
    background: #2563eb;
    color: white;
}

.step2-time-slot.unavailable {
    background: #f9fafb;
    color: #d1d5db;
    cursor: not-allowed;
}

.step2-empty-state {
    text-align: center;
    padding: 2rem 1rem;
    color: #9ca3af;
}

.step2-empty-state-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.step2-empty-state-text {
    font-size: 0.875rem;
}

.step2-progress {
    background: #e5e7eb;
    height: 6px;
    border-radius: 3px;
    margin-top: 1rem;
    overflow: hidden;
}

.step2-progress-fill {
    background: #3b82f6;
    height: 100%;
    transition: width 0.3s ease;
    border-radius: 3px;
}

@media (max-width: 968px) {
    .step2-main-content {
        grid-template-columns: 1fr;
    }

    .step2-calendar-section {
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
    }

    .step2-time-slots {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 640px) {
    .step2-calendar-section, .step2-sidebar {
        padding: 1.25rem;
    }

    .step2-time-slots {
        grid-template-columns: repeat(2, 1fr);
    }
}

.booking-item {
    padding: 1rem;
    border-radius: 0.75rem;
    transition: all 0.3s;
    overflow: visible;
}

.booking-item-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #f3f4f6;
}

.booking-item-title {
    font-weight: 600;
    font-size: 0.875rem;
    line-height: 1.25rem;
    color: #2563eb;
}

.booking-savings-badge {
    margin-left: auto;
    font-size: 0.875rem;
    line-height: 1.25rem;
    font-weight: 600;
    background-color: #f0fdf4;
    color: #15803d;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

/* Form Elements */
.form-grid {
    display: grid;
    grid-template-columns: repeat(1, minmax(0, 1fr));
    gap: 1.5rem;
    max-width: 90%;
    margin-left: auto;
    margin-right: auto;
}

@media (min-width: 768px) {
    .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 1rem;
    }
}

@media (min-width: 1024px) {
    .form-grid.summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .form-grid.summary-grid .summary-column {
        grid-column: span 1;
    }
}

.form-label {
    display: block;
    font-size: 0.875rem;
    line-height: 1.25rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
}

.form-input {
    max-width: 450px;
    width: 100%;
    padding: 0.75rem;
    border-radius: 0.5rem;
    background-color: #ffffff !important;
    border: 1px solid #6b7280;
    transition: all 0.2s;
}

.form-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}

.section-subtitle {
    font-size: 1.5rem;
    line-height: 2rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 0.75rem;
}

/* Navigation Buttons */
.nav-button-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem 1rem 1.5rem;
}

.nav-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    transition: all 0.2s;
    cursor: pointer;
    line-height: 1.2;
}

.nav-button.back {
    color: #4b5563;
    line-height: 1;
}

.nav-button.back:hover {
    color: #1f2937;
}

.nav-button.next {
    padding: 0.875rem 1.25rem;
    background: #3b82f6;
    color: white;
    font-weight: 600;
    border-radius: 0.5rem;
    border: none;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: all 0.2s;
    font-size: 0.9375rem;
}

.nav-button.next:hover {
    background: #2563eb;
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.nav-button.discount {
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
    color: white;
    font-weight: 600;
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    transition: all 0.3s;
    white-space: nowrap;
    font-size: 0.875rem;
    line-height: 1.25rem;
}

.nav-button.discount:hover {
    background: linear-gradient(135deg, #9333ea 0%, #db2777 100%);
}

.nav-button.submit {
    padding: 0.75rem 2rem;
    background: linear-gradient(135deg, #22c55e 0%, #059669 100%);
    color: white;
    font-weight: 700;
    border-radius: 0.75rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    transition: all 0.3s;
}

.nav-button.submit:hover {
    background: linear-gradient(135deg, #16a34a 0%, #047857 100%);
}

.nav-button.submit.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Info Box */
.info-box {
    border: 1px solid #81C7D4;
    padding: 1rem;
    border-radius: 0.75rem;
    margin-bottom: 1.5rem;
    margin-left: auto;
    margin-right: auto;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    background-color: #E0F5F7;
}

.info-box-text {
    font-size: 0.875rem;
    line-height: 1.25rem;
    color: #3B8A9D;
    margin: 0;
    text-align: left;
}

/* Delete Button */
.delete-button {
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: background-color 0.2s;
}

.delete-button:hover {
    background-color: #e5e7eb;
}

/* Checkbox Container */
.checkbox-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.checkbox-input {
    width: 1.25rem;
    height: 1.25rem;
    color: #3b82f6;
    border-radius: 0.25rem;
    cursor: pointer;
    flex-shrink: 0;
}

.checkbox-input:focus {
    box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.5);
}

/* Error Message */
.error-message {
    color: #ef4444;
    font-size: 0.75rem;
    line-height: 1rem;
    margin-top: 0.25rem;
}

/* Field Validation Classes */
.field-error {
    border-color: #ef4444 !important;
}

.field-success {
    border-color: #22c55e !important;
}

/* Hidden utility */
.hidden {
    display: none;
}

/* Booking Container Background - Light Theme */
#booking-system-container-wrapper {
    position: relative;
    background: linear-gradient(135deg, #f8f9fa 0%, #f0f2f5 50%, #e8ecf0 100%);
    overflow: hidden;
    min-height: 100vh;
    padding: 60px 0 100px;
}

.booking-shapes {
    position: absolute;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
}

.booking-shape {
    position: absolute;
    background: rgba(0, 172, 193, 0.15);
    animation: floatShape 20s infinite ease-in-out;
}

.booking-shape-1 {
    width: 500px;
    height: 500px;
    top: -150px;
    right: -100px;
    clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
    animation-delay: 0s;
}

.booking-shape-2 {
    width: 600px;
    height: 600px;
    bottom: -200px;
    right: -150px;
    background: rgba(0, 150, 200, 0.12);
    clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
    animation-delay: 5s;
}

.booking-shape-3 {
    width: 450px;
    height: 450px;
    top: 30%;
    left: -100px;
    background: rgba(0, 172, 193, 0.18);
    transform: rotate(45deg);
    animation-delay: 10s;
}

@keyframes floatShape {
    0%, 100% {
        transform: translate(0, 0) rotate(0deg);
    }
    25% {
        transform: translate(30px, 40px) rotate(5deg);
    }
    50% {
        transform: translate(-20px, 60px) rotate(-3deg);
    }
    75% {
        transform: translate(40px, 20px) rotate(4deg);
    }
}

.booking-corner-dots {
    position: absolute;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    z-index: 2;
    pointer-events: none;
}

.booking-corner-dots-top {
    top: 40px;
    right: 40px;
}

.booking-corner-dots-bottom {
    bottom: 40px;
    left: 40px;
}

.booking-corner-dot {
    width: 8px;
    height: 8px;
    background: rgba(0, 172, 193, 0.4);
    border-radius: 50%;
    animation: pulse 3s infinite ease-in-out;
}

.booking-corner-dot:nth-child(1) { animation-delay: 0s; }
.booking-corner-dot:nth-child(2) { animation-delay: 0.1s; }
.booking-corner-dot:nth-child(3) { animation-delay: 0.2s; }
.booking-corner-dot:nth-child(4) { animation-delay: 0.3s; }
.booking-corner-dot:nth-child(5) { animation-delay: 0.4s; }
.booking-corner-dot:nth-child(6) { animation-delay: 0.5s; }
.booking-corner-dot:nth-child(7) { animation-delay: 0.6s; }
.booking-corner-dot:nth-child(8) { animation-delay: 0.7s; }
.booking-corner-dot:nth-child(9) { animation-delay: 0.8s; }

@keyframes pulse {
    0%, 100% {
        opacity: 0.3;
        transform: scale(1);
    }
    50% {
        opacity: 0.8;
        transform: scale(1.15);
    }
}

#booking-system-container {
    position: relative;
    z-index: 3;
}
</style>

<main style="padding: 0; margin: 0;">
    <header class="page-header">
        <div class="page-header-wrapper">
            <div class="page-header-content">
                <div class="page-header-accent"></div>
                <nav class="breadcrumb">
                    <a href="/">Inicio</a>
                    <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
                    <span class="breadcrumb-current">Agendar</span>
                </nav>
                <h1>Agenda tu Clase</h1>
            </div>
            <div class="page-header-image"></div>
        </div>
    </header>

    <div id="booking-system-container-wrapper">
        <div class="booking-shapes">
            <div class="booking-shape booking-shape-1"></div>
            <div class="booking-shape booking-shape-2"></div>
            <div class="booking-shape booking-shape-3"></div>
        </div>

        <div class="booking-corner-dots booking-corner-dots-top">
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
        </div>

        <div class="booking-corner-dots booking-corner-dots-bottom">
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
            <div class="booking-corner-dot"></div>
        </div>

        <div id="booking-system-container"></div>
    </div>
</main>

<script>
// =================================================================
// 1. STATE & CONSTANTS
// =================================================================
let currentStep = 1;
let selectedPlan = null;
let bookings = [];
let currentClassIndex = 0;
let selectedDate = null;
let selectedTime = null;
let modifyingIndex = null;
let studentName = '', studentEmail = '', studentRut = '', studentPhone = '+56 ', wantsReminder = false;
let paymentMethod = 'webpay';
let fieldErrors = {};
let calendarMonth = new Date();
let activeCalendar = null;
let notificationTimeout = null;

const plans = [
    { id: 1, classes: 1, price: 14990, savings: 0, popular: false, bestPrice: false },
    { id: 2, classes: 2, price: 27980, savings: 7, popular: false, bestPrice: false },
    { id: 3, classes: 4, price: 51960, savings: 13, popular: true, bestPrice: false },
    { id: 4, classes: 6, price: 71940, savings: 20, popular: false, bestPrice: false },
    { id: 5, classes: 8, price: 87920, savings: 27, popular: false, bestPrice: true }
];

const timeSlots = {
    weekday: ['09:00-10:00', '10:30-11:30', '12:00-13:00', '16:30-17:30', '18:00-19:00', '21:00-22:00'],
    saturday: ['09:00-10:00', '10:30-11:30', '12:00-13:00'],
    saturdayUnavailable: ['16:30-17:30', '18:00-19:00', '21:00-22:00'],
};

const chileanHolidays = ['01-01', '04-03', '04-04', '05-01', '05-21', '06-20', '08-15', '09-18', '09-19', '10-12', '10-31', '11-01', '12-08', '12-25'];

// =================================================================
// 2. UTILITY FUNCTIONS (Currency and Calculations)
// =================================================================

const formatCurrency = (amount) => {
    return new Intl.NumberFormat('es-CL', { 
        style: 'currency', 
        currency: 'CLP', 
        minimumFractionDigits: 0, 
    }).format(amount);
};

const calculateOriginalPrice = (plan) => {
    const basePrice = 14990;
    return basePrice * plan.classes;
};
const calculateFinalPrice = () => {
    if (!selectedPlan) return 0;
    return selectedPlan.price;
};
const formatRUT = (value) => {
    const clean = value.replace(/[^0-9kK]/g, '');
    if (clean.length === 0) return '';
    if (clean.length > 9) return studentRut;  
    const body = clean.slice(0, -1);
    const verifier = clean.slice(-1).toUpperCase();
    const formattedBody = body.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return body.length > 0 ? `${formattedBody}-${verifier}` : verifier;
};
const validateField = (field) => {
    let isValid = true;
    let value = '';

    switch (field) {
        case 'name':
    value = studentName.trim();
    const words = value.split(/\s+/).filter(word => word.length > 0);
    isValid = words.length >= 2 && value.length >= 3;
    break;
        case 'email':
            value = studentEmail.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            isValid = emailRegex.test(value);
            break;
        case 'rut':
            value = studentRut.trim();
            const cleanRut = value.replace(/[.-]/g, '');
            isValid = cleanRut.length >= 8 && cleanRut.length <= 9;
            break;
        case 'phone':
    value = studentPhone.trim();
    const cleanPhone = value.replace(/\+56\s?/g, '').replace(/\s/g, '');
    if (cleanPhone.length === 0) {
        delete fieldErrors[field];
        return false;
    }
    isValid = /^9\d{8}$/.test(cleanPhone);
    break;
    }

    if (!isValid) {
        fieldErrors = { ...fieldErrors, [field]: true };
    } else {
        delete fieldErrors[field];
    }
    return isValid;
};

const validateAllFields = () => {
    const fields = ['name', 'email', 'rut', 'phone'];
    let allValid = true;
    fields.forEach(field => {
        if (!validateField(field)) {
            allValid = false;
        }
    });
    return allValid;
};

const isDateAvailable = (date, currentIndex = null) => {
    const d = new Date(date + 'T12:00:00');
    const day = d.getDay();
    
    const now = new Date();
    const chileTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Santiago' }));
    
    const startOfToday = new Date(chileTime);
    startOfToday.setHours(0, 0, 0, 0);
    
    const startOfSelectedDay = new Date(date + 'T00:00:00');

    const monthDay = `${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    if (chileanHolidays.includes(monthDay)) return { available: false, reason: 'holiday' };
    
    if (day === 0) return { available: false, reason: 'sunday' };
    
    if (startOfSelectedDay < startOfToday) return { available: false, reason: 'past' };

    const availableSlots = getAvailableSlots(date, currentIndex);
    if (availableSlots.length === 0) return { available: false, reason: 'no_slots' };

    return { available: true, reason: null };
};

const getAvailableSlots = (dateStr, currentIndex) => {
    if (!dateStr) return [];
    const d = new Date(dateStr + 'T12:00:00');
    const day = d.getDay();
    const slots = day === 6 ? timeSlots.saturday : timeSlots.weekday;
    const now = new Date();

    return slots.filter(slot => {

        const isBooked = bookings.some((b, idx) => idx !== currentIndex && b?.date === dateStr && b?.time === slot);
        if (isBooked) return false;

        const [startTime] = slot.split('-');
        const [hours, minutes] = startTime.split(':');
        const slotDateTime = new Date(dateStr + `T${hours}:${minutes}:00`);
        const twelveHoursLater = new Date(now.getTime() + 12 * 60 * 60 * 1000);
        
        return slotDateTime >= twelveHoursLater;
    });
};

const isBookingComplete = () => {
    const isScheduleComplete = bookings.length === selectedPlan?.classes && bookings.every(b => b.date && b.time);
    return isScheduleComplete && validateAllFields();
};

const selectPlan = (planId) => {
    selectedPlan = plans.find(p => p.id === planId);
    if (selectedPlan) {
        bookings = [];
        currentClassIndex = 0;
        selectedDate = null;
        selectedTime = null;
        goToNextStep();
    }
};

const selectPaymentMethod = (method) => {
    paymentMethod = method;
    renderStep(currentStep);
};

const handleConfirmPayment = () => {
    if (!validateAllFields()) {
        renderStep(3);
        return;
    }

    const originalPlanPrice = calculateOriginalPrice(selectedPlan);
    const finalPrice = calculateFinalPrice();

    const bookingData = {
        plan: {
            id: selectedPlan.id,
            classes: selectedPlan.classes,
            originalPrice: originalPlanPrice,
            finalPrice: finalPrice,
        },
        student: {
            name: studentName,
            email: studentEmail,
            age: studentAge,
            id: studentId,
            phone: studentPhone,
        },
        schedule: bookings,
        discount: appliedDiscount,
        timestamp: new Date().toISOString()
    };

    console.log('Booking Data:', bookingData);

    setTimeout(() => {
        alert('Demo: Redirigiendo a Pasarela de Pago con un total de ' + formatCurrency(finalPrice) + '...');
    }, 1500);
};

// --- Replace the popup-based toggle with inline toggle behavior ---
const updateStep2Content = () => {
    const bookingList = document.querySelector('.booking-summary-list');
    if (bookingList && currentStep === 2) {
        bookingList.innerHTML = bookings.map((booking, index) => {
            const availableSlots = getAvailableSlots(booking?.date, index);
            const isComplete = booking?.date && booking?.time;

            return `
                <div class="booking-item" style="background-color: #ffffffff !important; border: 1px solid #9ca3af;">
                    <div class="booking-item-header">
                        <h3 class="booking-item-title">Clase ${index + 1} de ${selectedPlan.classes}</h3>
                        ${isComplete ? `<span class="booking-savings-badge">${icon('check-circle', 16, '')} Listo</span>` : ''}
                    </div>

                    <div class="date-grid">
                        <div style="max-width: 480px;">
                            <label class="form-label">
                                ${icon('calendar', 16, 'inline mr-1')} Fecha
                            </label>
                            <div style="position: relative;">
                                <button type="button" onclick="event.stopPropagation(); toggleCalendar(${index})" class="date-button ${booking?.date ? 'selected' : ''}" style="transform-origin: center;" onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
                                    ${booking?.date ? new Date(booking.date + 'T12:00:00').toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long' }) : 'Selecciona un da'}
                                </button>
                                ${activeCalendar === index ? `
                                    <div class="calendar-popup" style="position: absolute; left: 0; top: 100%; margin-top: 0.5rem; z-index: 1000;">
                                        ${renderCalendarGrid(index)}
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <div>
                            <label class="form-label">
                                ${icon('clock', 16, 'inline mr-1')} Horario
                            </label>
                            <div style="display: grid; grid-template-columns: ${booking?.date ? 'repeat(3, 1fr)' : '1fr'}; gap: 0.5rem;">
                                ${booking?.date ? availableSlots.map(slot => `
                                    <button type="button" onclick="selectTimeSlot('${slot}', ${index})"
                                        class="time-slot-button ${booking.time === slot ? 'selected' : ''}"
                                        ${booking.date && availableSlots.length === 0 ? 'disabled' : ''}
                                    >
                                        ${slot.split('-')[0]}
                                    </button>
                                `).join('') : `
                                    <span style="font-size: 0.875rem; color: #6b7280; padding: 0.5rem; text-align: center; grid-column: span 1;">Selecciona una fecha primero</span>
                                `}
                                ${booking.date && availableSlots.length === 0 ? `
                                    <span class="error-message" style="padding: 0.5rem; text-align: center; grid-column: span 3; font-weight: 600;">No hay horarios disponibles para esta fecha.</span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                if (window.lucide) {
                    lucide.createIcons();
                }

                if (activeCalendar !== null) {
                    const calendar = document.querySelector('.calendar-popup');
                    if (calendar) {
                        calendar.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
            });
        });

        if (activeCalendar !== null) {
            setTimeout(() => {
                document.addEventListener('click', handleCalendarClickOutside);
            }, 10);
        }
    }
};

const toggleCalendar = (index) => {
    const isOpening = activeCalendar !== index;
    activeCalendar = isOpening ? index : null;
    updateStep2Content();
};

function removeCalendarPopup() {
    activeCalendar = null;
    document.removeEventListener('click', handleCalendarClickOutside);
    updateStep2Content();
}


function handleCalendarClickOutside(event) {
    const calendar = document.querySelector('.calendar-popup');
    if (!calendar) {
        document.removeEventListener('click', handleCalendarClickOutside);
        return;
    }

    if (calendar.contains(event.target)) {
        return;
    }

    const clickedButton = event.target.closest('.date-button');
    if (clickedButton) {
        return;
    }

    activeCalendar = null;
    document.removeEventListener('click', handleCalendarClickOutside);
    updateStep2Content();
}


const selectDate = (dateStr, index) => {
    bookings[index] = { ...bookings[index], date: dateStr, time: null };
    activeCalendar = null;
    document.removeEventListener('click', handleCalendarClickOutside);
    updateStep2Content();
};

const selectTimeSlot = (slot, index) => {
    bookings[index] = { ...bookings[index], time: slot };

    if (bookings[index].date && bookings[index].time) {
        const formattedDate = new Date(bookings[index].date + 'T12:00:00').toLocaleDateString('es-CL', {
            weekday: 'long',
            day: 'numeric',
            month: 'long'
        });
        const formattedTime = slot.split('-')[0];
    }

    updateStep2Content();
};
const goToNextStep = () => {
    const prevStep = currentStep;
    if (currentStep === 1 && selectedPlan) {
        currentStep = 2;
    } else if (currentStep === 2) {

        if (bookings.length === selectedPlan.classes && bookings.every(b => b.date && b.time)) {
            currentStep = 3;
        } else {
            renderStep(2);
            return;
        }
    } else if (currentStep === 3) {
        if (isBookingComplete()) {
            currentStep = 4;
        } else {
            return;
        }
    } else if (currentStep === 4 && isBookingComplete()) {

    } else {
        if (currentStep === 4) {
        }
        return;
    }
    const shouldAnimate = currentStep !== prevStep;
    renderStep(currentStep, shouldAnimate);
};
const goToPrevStep = () => {
    const prevStep = currentStep; 
    currentStep = Math.max(1, currentStep - 1);
    const shouldAnimate = currentStep !== prevStep;
    renderStep(currentStep, shouldAnimate);
};

const handlePhoneKeydown = (event, input) => {
    const selectionStart = input.selectionStart;
    const selectionEnd = input.selectionEnd;

    if ((event.key === 'Backspace' || event.key === 'Delete') && selectionStart < 4 && selectionEnd <= 4) {
        event.preventDefault();
        return;
    }

    if (event.key === 'Backspace' && selectionStart === selectionEnd && selectionStart === 4) {
        event.preventDefault();
        return;
    }
};

const handlePhoneSelect = (event, input) => {
    const start = input.selectionStart;
    const end = input.selectionEnd;
    const length = input.value.length;

    if (end === length && start === 4) {
        return;
    }

    if (start < 4 || end < 4) {
        if (start < 4 && end > 4) {
            setTimeout(() => input.setSelectionRange(4, end), 0);
        } else if (start < 4 && end === 4) {
            setTimeout(() => input.setSelectionRange(4, 4), 0);
        }
    }
};

const handlePhoneClick = (event, input) => {
    if (input.selectionStart < 4) {
        setTimeout(() => input.setSelectionRange(4, 4), 0);
    }
};

const updateStudentInfo = (field, value) => {
    switch (field) {
        case 'name': 
            studentName = value; 
            break;
        case 'email':
            studentEmail = value;
            break;
        case 'rut':
            const input = event.target;
            const cursorPosition = input.selectionStart;
            const oldValue = studentRut;
            const newValue = formatRUT(value);

            if (newValue !== oldValue || newValue.length <= oldValue.length) {
                studentRut = newValue;
                setTimeout(() => {
                    input.value = studentRut;
                    const lengthDiff = studentRut.length - value.length;
                    const newCursorPos = cursorPosition + lengthDiff;
                    input.setSelectionRange(newCursorPos, newCursorPos);
                    validateField('rut');
                    updateStep3Button();
                }, 0);
            } else {
                validateField('rut');
                updateStep3Button();
            }
            return;
        case 'phone':
            const phoneInput = document.querySelector('input[name="phone"]');

            let rawValue = value;
            if (rawValue.length < 4) {
                rawValue = '+56 ';
            }

            let digits = rawValue.replace(/\D/g, '');
            if (digits.startsWith('56')) {
                digits = digits.slice(2);
            }
            digits = digits.slice(0, 9);

            const oldPhoneValue = studentPhone;
            const oldCursorPos = phoneInput ? phoneInput.selectionStart : 0;

            if (digits.length === 0) {
                studentPhone = '+56 ';
            } else if (digits.length === 1) {
                studentPhone = '+56 ' + digits;
            } else if (digits.length <= 5) {
                studentPhone = '+56 ' + digits[0] + ' ' + digits.slice(1);
            } else {
                studentPhone = '+56 ' + digits[0] + ' ' + digits.slice(1, 5) + ' ' + digits.slice(5);
            }

            validateField('phone');
            updateStep3Button();

            if (phoneInput) {
                setTimeout(() => {
                    phoneInput.value = studentPhone;
                    let newCursorPos = oldCursorPos;
                    if (studentPhone.length < oldPhoneValue.length) {
                        newCursorPos = Math.max(4, oldCursorPos);
                    } else {
                        newCursorPos = oldCursorPos + (studentPhone.length - oldPhoneValue.length);
                    }
                    phoneInput.setSelectionRange(newCursorPos, newCursorPos);
                }, 0);
            }
            return;
        case 'reminder':
            wantsReminder = value;
            return;
    }

    validateField(field);
    updateStep3Button();
};

const updateStep3Button = () => {
    const continueBtn = document.getElementById('step3ContinueBtn');
    if (continueBtn) {
        const phoneDigits = studentPhone.replace(/\+56\s?/g, '').replace(/\s/g, '');
        const allFieldsFilled = studentName.trim() &&
                                studentEmail.trim() &&
                                studentRut.trim() &&
                                phoneDigits.length === 9;
        const noErrors = Object.keys(fieldErrors).length === 0;

        if (allFieldsFilled && noErrors) {
            continueBtn.disabled = false;
            continueBtn.style.opacity = '1';
            continueBtn.style.cursor = 'pointer';
        } else {
            continueBtn.disabled = true;
            continueBtn.style.opacity = '0.5';
            continueBtn.style.cursor = 'not-allowed';
        }
    }
};

function updateFieldError(field) {
    const errorMessages = {
    name: 'Debes ingresar nombre y apellido',
    rut: 'RUT debe tener entre 8 y 9 dgitos',
    email: 'Correo invlido',
    phone: 'Debes ingresar un nmero de 9 dgitos'
};
    
    const inputs = document.querySelectorAll('input');
    let targetInput = null;
    for (let input of inputs) {
        const onInputAttr = input.getAttribute('oninput');
        if (onInputAttr && onInputAttr.includes(`'${field}'`)) {
            targetInput = input;
            break;
        }
    }
    if (!targetInput) return;

    const value = field === 'name' ? studentName :
                 field === 'email' ? studentEmail :
                 field === 'rut' ? studentRut :
                 field === 'phone' ? studentPhone : '';

    let isFilled;
    if (field === 'phone') {
        isFilled = value.length > 4;
    } else {
        isFilled = value.trim().length > 0;
    }

    const hasError = fieldErrors[field] && isFilled;

    let isValid;
    if (field === 'phone') {
        const cleanPhone = value.replace(/\+56\s?/g, '').replace(/\s/g, '');
        isValid = /^9\d{8}$/.test(cleanPhone) && !fieldErrors[field];
    } else {
        isValid = isFilled && !fieldErrors[field];
    }
    
    if (hasError) {
        targetInput.style.borderColor = '#ef4444';
        targetInput.style.borderWidth = '1px';
    } else {
        targetInput.style.borderColor = '#6b7280';
        targetInput.style.borderWidth = '1px';
    }
    
    if (isValid || hasError) {
        targetInput.style.paddingRight = '2.5rem';
    } else {
        targetInput.style.paddingRight = '0.75rem';
    }

    const parentContainer = targetInput.closest('div[style*="margin-bottom: 0.5rem"]');
    if (parentContainer) {
        const errorDiv = parentContainer.querySelector('div[style*="position: absolute"][style*="height: 20px"]');
        
        if (errorDiv) {
            if (hasError) {
                errorDiv.innerHTML = `<p class="text-red-500 text-xs mt-1">${errorMessages[field]}</p>`;
            } else {
                errorDiv.innerHTML = '';
            }
        }
    }

    const inputWrapper = targetInput.parentElement;
    let icon = inputWrapper.querySelector('div[style*="pointer-events: none"]');
    
    if (isValid) {
        if (!icon) {
            icon = document.createElement('div');
            inputWrapper.appendChild(icon);
        }
        icon.style.cssText = 'position: absolute; right: 0.75rem; top: 0; bottom: 0; display: flex; align-items: center; pointer-events: none;';
        icon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#16a34a"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    } else if (hasError) {
        if (!icon) {
            icon = document.createElement('div');
            inputWrapper.appendChild(icon);
        }
        icon.style.cssText = 'position: absolute; right: 0.75rem; top: 0; bottom: 0; display: flex; align-items: center; pointer-events: none;';
        icon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#ef4444"/><path d="M12 8v4m0 4h.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    } else {
        if (icon) {
            icon.remove();
        }
    }
}

const handleBlur = (field) => {
    validateField(field);
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            renderStep(3);
        });
    });
};

const scrollToTop = () => {
    const pageHeader = document.querySelector('.page-header');
    if (pageHeader) {
        const headerBottom = pageHeader.getBoundingClientRect().bottom + window.scrollY;
        window.scrollTo({
            top: headerBottom - 70,
            behavior: 'smooth'
        });
    } else {
        const container = document.getElementById('booking-system-container');
        if (container) {
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
};

const scrollToCalendar = () => {
    setTimeout(() => {
        const calendar = document.querySelector('.calendar-popup');
        if (calendar) {
            calendar.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
        }
    }, 100);
};

const showNotification = (message, type) => {
    let notification = document.getElementById('booking-notification');

    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'booking-notification';
        document.body.appendChild(notification);
    }

    let bgColor, iconName;
    if (type === 'success') {
        bgColor = '#22c55e';
        iconName = 'check-circle';
    } else if (type === 'error') {
        bgColor = '#ef4444';
        iconName = 'x-octagon';
    } else {
        bgColor = '#3b82f6';
        iconName = 'info';
    }

    notification.style.cssText = `
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 99999;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        background-color: ${bgColor};
        color: white;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        max-width: 400px;
        min-width: 320px;
        animation: none;
    `;
    notification.innerHTML = `${icon(iconName, 20, 'flex-shrink-0')} <span style="font-size: 0.875rem; font-weight: 600; flex: 1;">${message}</span>`;

    if (window.lucide) {
        lucide.createIcons();
    }

    requestAnimationFrame(() => {
        notification.style.animation = 'slide-in 0.3s ease-out';
    });

    if (notificationTimeout) {
        clearTimeout(notificationTimeout);
    }

    notificationTimeout = setTimeout(() => {
        notification.style.animation = 'slide-out 0.3s ease-in forwards';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 4000);
};

const icon = (name, size = 24, classes = '') => {
    return `<i data-lucide="${name}" class="${classes}" style="width: ${size}px; height: ${size}px;"></i>`;
};

const renderHeader = () => {
    return `
        <div class="px-6 pb-0" style="background-color: #fff; padding-top: 2rem; border-radius: 1rem 1rem 0 0;">
            ${renderProgressSteps()}
            <div class="w-full mt-6" style="height: 1px; background-color: #e0e0e0;"></div>
        </div>
    `;
};

const renderProgressSteps = () => {
    const steps = [1, 2, 3, 4];
    const stepLabels = ['Plan', 'Horarios', 'Datos', 'Pago'];
    const tooltipLabels = ['Volver a Plan', 'Volver a Horarios', 'Volver a Datos'];

    let circlesHtml = '<div class="flex justify-center items-center mb-2">';

    steps.forEach((step, index) => {
        const isCurrentOrPast = currentStep >= step;
        const isCurrent = currentStep === step;
        const isClickable = step < currentStep;

        const stepClass = isCurrentOrPast
            ? `bg-blue-500 text-white shadow-lg ${isCurrent ? 'ring-2 ring-blue-300' : ''}`
            : 'bg-gray-200 text-gray-700';

        const lineClass = currentStep > step ? 'bg-blue-500' : 'bg-gray-200';

        const circleContent = `
            <div class="rounded-full flex items-center justify-center font-bold text-sm ${stepClass} ${isClickable ? 'cursor-pointer hover:bg-blue-600 step-tooltip' : ''}"
                style="width: 32px; height: 32px; min-width: 32px; min-height: 32px;"
                ${isClickable ? `onclick="goToStep(${step})" data-tooltip="${tooltipLabels[index]}"` : ''}>
                ${currentStep > step ? '<i class="fas fa-check" style="font-size: 14px;"></i>' : step}
            </div>
        `;

        circlesHtml += circleContent;

        if (step < 4) {
            circlesHtml += `<div class="h-1 rounded ${lineClass}" style="width: 76px; margin: 0 8px;"></div>`;
        }
    });
    circlesHtml += '</div>';

    let labelsHtml = '<div class="flex justify-center items-center">';
    
    stepLabels.forEach((label, index) => {
        const isActive = currentStep >= index + 1;

        if (index === 0) {
            labelsHtml += `
                <div class="text-xs font-medium ${isActive ? 'text-blue-600 font-bold' : 'text-gray-400'}" style="width: 32px; text-align: center;">
                    ${label}
                </div>
                <div style="width: 92px;"></div>
            `;
        } else if (index === 1) {
            labelsHtml += `
                <div class="text-xs font-medium ${isActive ? 'text-blue-600 font-bold' : 'text-gray-400'}" style="width: 50px; text-align: center; margin-left: -9px;">
                    ${label}
                </div>
                <div style="width: 83px;"></div>
            `;
        } else if (index === 2) {
            labelsHtml += `
                <div class="text-xs font-medium ${isActive ? 'text-blue-600 font-bold' : 'text-gray-400'}" style="width: 32px; text-align: center;">
                    ${label}
                </div>
                <div style="width: 92px;"></div>
            `;
        } else {
            labelsHtml += `
                <div class="text-xs font-medium ${isActive ? 'text-blue-600 font-bold' : 'text-gray-400'}" style="width: 32px; text-align: center;">
                    ${label}
                </div>
            `;
        }
    });
    labelsHtml += '</div>';
    
    return circlesHtml + labelsHtml;
};

const goToStep = (step) => {
    if (step < currentStep) {
        currentStep = step;
        renderStep(currentStep, true);
    }
};

const renderStep1 = () => {
    return `
        <div id="step-1-content" class="step-content">
            <h2 class="section-header">Selecciona tu Plan de Clases</h2>
            <div class="plan-grid">
                ${plans.map(plan => {
    const originalPrice = calculateOriginalPrice(plan);
    const finalPrice = formatCurrency(plan.price);
    const originalPriceStr = formatCurrency(originalPrice);
    const borderStyle = plan.popular
        ? 'border: 2px solid #ff6600;'
        : plan.bestPrice
            ? 'border: 2px solid #a855f7;'
            : 'border: 2px solid #d1d5db;';

    return `
        <div class="plan-card" style="${borderStyle}">
            ${plan.popular ? `
                <div class="popular-badge" style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); color: white; font-size: 11px; font-weight: bold; border-radius: 9999px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10; white-space: nowrap;">
                    MS POPULAR
                </div>
            ` : ''}
            ${plan.bestPrice ? `
                <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: linear-gradient(to right, #a855f7, #ec4899); padding: 4px 12px; color: white; font-size: 11px; font-weight: bold; border-radius: 9999px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10; white-space: nowrap;">
                    MENOR PRECIO
                </div>
            ` : ''}
            <div class="plan-card-content">
                <div class="plan-classes-count">${plan.classes}</div>
                <div class="plan-classes-label">${plan.classes === 1 ? 'Clase' : 'Clases'}</div>

                <div class="plan-price">
                    ${formatCurrency(Math.round(plan.price / plan.classes))}
                </div>
                <div class="plan-price-label">por clase</div>

                <div style="min-height: 28px; display: flex; justify-content: center; align-items: center; margin-top: 8px;">
                    ${plan.savings > 0 ? `
                        <div class="plan-savings-badge">
                            Pagas: ${finalPrice}
                        </div>
                    ` : ''}
                </div>

                <div style="min-height: 24px; margin-top: 8px;">
                    ${plan.savings > 0 ? `
                        <div class="plan-total-price">
                            Antes: <span style="text-decoration: line-through;">${originalPriceStr}</span>
                        </div>
                    ` : ''}
                </div>
            </div>

            <button onclick="selectPlan(${plan.id})" class="select-plan-btn">
                Seleccionar
            </button>
        </div>
    `;
}).join('')}
            </div>

            <div class="disclaimer-box">
                <div class="disclaimer-content">
                    ${icon('info', 20, 'disclaimer-icon')}
                    <div class="disclaimer-text">
                        <strong>Todas las clases:</strong>
                        <ul class="disclaimer-list">
                            <li>Se realizan mediante la plataforma Zoom. <a href="https://zoom.us/download" target="_blank" rel="noopener noreferrer" style="color: #1d4ed8; text-decoration: underline;">Descargarla aqu.</a></li>
                            <li>Tienen una duracin de 60 minutos.</li>
                            <li>Son realizadas por el profesor Alexis Inostroza Daz.</li>
                            <li>Pueden ser recalendarizadas hasta con 4 horas de anticipacin.</li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    `;
};

const renderStep2 = () => {
    if (!selectedPlan) {
        currentStep = 1;
        return renderStep1();
    }

    // Initialize calendar rendering
    setTimeout(() => {
        initStep2Calendar();
        updateStep2Sidebar();
        updateStep2Header();
        updateStep2Progress();
    }, 0);

    return `
    <div id="step-2-content" class="step-content">
        <h2 class="section-header" style="margin-bottom: 1rem;">Selecciona tus Horarios</h2>

        <div class="info-box" style="width: 90%; max-width: none;">
            ${icon('info', 20, 'disclaimer-icon')}
            <p class="info-box-text" style="line-height: 1.4;">
                Solo es posible seleccionar horarios con 12 horas de anticipacin.
            </p>
        </div>

        <div class="p-6 rounded-xl" style="background: #ffffff; border: 2px solid #e2e8f0; width: 90%; margin: 0 auto 2rem auto;">
            <div class="step2-main-content">
                <div class="step2-calendar-section">
                <div class="step2-calendar-header">
                    <button class="step2-nav-btn" onclick="step2PrevMonth()"></button>
                    <div class="step2-month-display" id="step2MonthDisplay"></div>
                    <button class="step2-nav-btn" onclick="step2NextMonth()"></button>
                </div>

                <div class="step2-calendar-grid">
                    <div class="step2-day-name">L</div>
                    <div class="step2-day-name">M</div>
                    <div class="step2-day-name">M</div>
                    <div class="step2-day-name">J</div>
                    <div class="step2-day-name">V</div>
                    <div class="step2-day-name">S</div>
                    <div class="step2-day-name">D</div>
                </div>

                <div class="step2-calendar-grid" id="step2CalendarDays"></div>

                <div style="display: flex; gap: 1.5rem; justify-content: center; margin-top: 2.5rem; font-size: 0.75rem; color: #6b7280;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 18px; height: 18px; background: #dbeafe; border: 1.5px solid #3b82f6; border-radius: 4px;"></div>
                        <span>Disponible</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 18px; height: 18px; background: #e5e7eb; border: 1.5px solid #9ca3af; border-radius: 4px;"></div>
                        <span>No disponible</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 18px; height: 18px; background: #fecaca; border: 1.5px solid #f87171; border-radius: 4px;"></div>
                        <span>Domingos y festivos</span>
                    </div>
                </div>
            </div>

            <div class="step2-sidebar">
                <div class="step2-locked-classes" id="step2LockedClasses">
                    <h3><span id="step2ProgressCount">${bookings.length}/${selectedPlan.classes}</span> Clases Confirmadas</h3>
                    <div class="step2-progress" style="margin-top: 0.5rem; margin-bottom: 2.5rem;">
                        <div class="step2-progress-fill" id="step2ProgressBar" style="width: ${(bookings.length / selectedPlan.classes) * 100}%"></div>
                    </div>
                    <div id="step2LockedClassesList"></div>
                </div>

                <div id="step2CurrentSelection"></div>
            </div>
            </div>
        </div>

        <div class="nav-button-container">
            <button onclick="goToPrevStep()" class="nav-button back" style="border: none; background: none; padding: 0;">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="margin-bottom: 1px;"><path d="M10 2L4 8l6 6V2z"/></svg> <span>Cambiar Plan</span>
            </button>
            <button onclick="goToNextStep()" class="nav-button next" id="step2ContinueBtn">
                <span>Continuar a Datos</span> <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="margin-bottom: 1px;"><path d="M6 2l6 6-6 6V2z"/></svg>
            </button>
        </div>
    </div>
    `;
};

const renderCalendarGrid = (index) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const firstDayOfMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth(), 1);
    const lastDayOfMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 0);
    const numDays = lastDayOfMonth.getDate();
    const startPadding = (firstDayOfMonth.getDay() + 6) % 7; 

    let daysHtml = '';
    const dayNames = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
    daysHtml += '<div class="grid grid-cols-7 gap-1.5 text-xs font-bold text-gray-600 mb-2">';
    daysHtml += dayNames.map(day => `<div class="text-center">${day}</div>`).join('');
    daysHtml += '</div>';
    daysHtml += '<div class="grid grid-cols-7 gap-1.5">';
    for (let i = 0; i < startPadding; i++) {
        daysHtml += '<div></div>';
    }

for (let day = 1; day <= numDays; day++) {
    const date = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth(), day);
    const dateStr = date.toISOString().split('T')[0];
    const { available, reason } = isDateAvailable(dateStr, index);
    const isSelected = bookings[index]?.date === dateStr;
    const isSunday = date.getDay() === 0;

    let style = '';
    let textClass = '';
    let hoverHandlers = '';
    let classes = 'w-full text-sm rounded-lg transition-all duration-200 font-semibold flex items-center justify-center';

if (isSelected) {
    style = 'height: 35px; background: #22c55e; border: 2px solid #16a34a; cursor: pointer;';
    textClass = 'text-white';
    classes += ' shadow-sm';
} else if (!available) {
    if (reason === 'holiday' || isSunday) {
    style = 'height: 35px; background: #ee7678; border: none;';
    textClass = 'text-white';
    classes += ' cursor-not-allowed';
}

 else {
    style = 'height: 35px; background: #d1d5db; border: none;';
    textClass = 'text-gray-600';
    classes += ' cursor-not-allowed';
}
} else {
    style = 'height: 35px; background: #3778f1; border: none; cursor: pointer;';
    textClass = 'text-white';
    hoverHandlers = `onmouseover="this.style.background='#2563eb'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='#3b82f6'; this.style.transform='scale(1)';"`;
}
    
    const disabled = available ? '' : 'disabled';
    daysHtml += `
        <button type="button" onclick="selectDate('${dateStr}', ${index}); event.stopPropagation();" ${disabled} class="${classes} ${textClass}" style="${style}" ${hoverHandlers}>
            ${day}
        </button>
    `;
}
    
    daysHtml += '</div>';
    const monthName = calendarMonth.toLocaleDateString('es-CL', { month: 'long' });
    const year = calendarMonth.getFullYear();

    return `
    <div class="flex items-center justify-between mb-3">
        <button type="button" onclick="prevMonth(${index}); event.stopPropagation();" class="calendar-nav-btn">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="font-bold text-gray-800 capitalize text-sm">
            ${monthName} ${year}
        </div>
        <button type="button" onclick="nextMonth(${index}); event.stopPropagation();" class="calendar-nav-btn">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    ${daysHtml}
    `;
};

const prevMonth = (index) => {
    calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() - 1, 1);
    updateStep2Content();
};

const nextMonth = (index) => {
    calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 1);
    updateStep2Content();
};

// =================================================================
// NEW STEP 2 CALENDAR SYSTEM
// =================================================================

const initStep2Calendar = () => {
    renderStep2Calendar();
};

const renderStep2Calendar = () => {
    const monthDisplay = document.getElementById('step2MonthDisplay');
    if (!monthDisplay) return;

    const monthName = calendarMonth.toLocaleDateString('es-ES', { month: 'long' });
    const year = calendarMonth.getFullYear();
    monthDisplay.textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}`;

    const daysGrid = document.getElementById('step2CalendarDays');
    if (!daysGrid) return;

    daysGrid.innerHTML = '';

    const firstDay = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth(), 1);
    const lastDay = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 0);
    const startPadding = (firstDay.getDay() + 6) % 7;

    // Empty cells before first day
    for (let i = 0; i < startPadding; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'step2-day-cell empty';
        daysGrid.appendChild(emptyCell);
    }

    // Render each day
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth(), day);
        const dateStr = date.toISOString().split('T')[0];
        const dayOfWeek = date.getDay();

        const cell = document.createElement('div');
        cell.className = 'step2-day-cell';

        // Check if date has booked classes (exclude the class being modified)
        const classesOnDate = bookings.filter((b, idx) => b.date === dateStr && idx !== modifyingIndex);
        const hasMaxClasses = classesOnDate.length >= 2;

        // Check availability
        const { available, reason } = isDateAvailable(dateStr, currentClassIndex);
        const isSunday = dayOfWeek === 0;

        if (!available || date < today || isSunday) {
            if (reason === 'holiday' || isSunday) {
                cell.className += ' holiday';
            } else {
                cell.className += ' disabled';
            }
        } else if (hasMaxClasses) {
            // Date has 2 classes - keep blue/booked style but make unclickable
            cell.className += ' booked';
        } else {
            cell.className += ' available';
            cell.onclick = () => step2SelectDate(dateStr);
        }

        if (classesOnDate.length > 0) {
            if (!cell.className.includes('disabled') && !hasMaxClasses) {
                cell.className = cell.className.replace('available', 'booked');
                cell.onclick = () => step2SelectDate(dateStr);
            }
            const badge = document.createElement('div');
            badge.className = 'step2-badge';
            badge.textContent = classesOnDate.map((b, i) => bookings.indexOf(b) + 1).join(',');
            cell.appendChild(badge);
        }

        // Highlight selected date
        if (selectedDate === dateStr) {
            cell.className = cell.className.replace('available', 'selected').replace('booked', 'selected');

            // If modifying a class, show badge on the newly selected date
            if (modifyingIndex !== null) {
                if (!cell.querySelector('.step2-badge')) {
                    const badge = document.createElement('div');
                    badge.className = 'step2-badge';
                    // Show the current index + 1 (will be updated after time selection and sort)
                    badge.textContent = modifyingIndex + 1;
                    cell.appendChild(badge);
                }
            }
        }

        const dayNumber = document.createElement('span');
        dayNumber.textContent = day;
        cell.appendChild(dayNumber);

        daysGrid.appendChild(cell);
    }
};

const step2SelectDate = (dateStr) => {
    if (currentClassIndex >= selectedPlan.classes && modifyingIndex === null) return;

    selectedDate = dateStr;
    selectedTime = null;
    renderStep2Calendar();
    updateStep2Sidebar();
};

const step2SelectTime = (time) => {
    if (currentClassIndex >= selectedPlan.classes && modifyingIndex === null) return;

    selectedTime = time;

    // Check if we're modifying an existing class
    if (modifyingIndex !== null) {
        // Update the existing booking
        bookings[modifyingIndex].date = selectedDate;
        bookings[modifyingIndex].time = time;
        modifyingIndex = null;
    } else {
        // Lock in a new class
        bookings.push({
            date: selectedDate,
            time: time
        });
        currentClassIndex++;
    }

    // Sort bookings chronologically
    bookings.sort((a, b) => {
        const dateCompare = a.date.localeCompare(b.date);
        if (dateCompare !== 0) return dateCompare;
        return a.time.localeCompare(b.time);
    });

    // Reset selection
    selectedDate = null;
    selectedTime = null;

    renderStep2Calendar();
    updateStep2Sidebar();
    updateStep2Header();
    updateStep2Progress();
};

const step2ModifyClass = (index) => {
    // If clicking the same class being modified, toggle it closed
    if (modifyingIndex === index) {
        selectedDate = null;
        selectedTime = null;
        modifyingIndex = null;

        renderStep2Calendar();
        updateStep2Sidebar();
        updateStep2Header();
        updateStep2Progress();
        return;
    }

    // If user is currently modifying another class, the previous modification is automatically saved
    // because the booking data is still in the bookings array with its original values
    // No need to save anything - just switch to the new one

    const classToModify = bookings[index];

    // Set current selection with previous time displayed
    selectedDate = classToModify.date;
    selectedTime = classToModify.time;
    modifyingIndex = index;

    renderStep2Calendar();
    updateStep2Sidebar();
    updateStep2Header();
    updateStep2Progress();
};

const step2DeleteClass = (index) => {
    bookings.splice(index, 1);

    currentClassIndex = bookings.length;
    selectedDate = null;
    selectedTime = null;
    modifyingIndex = null;

    renderStep2Calendar();
    updateStep2Sidebar();
    updateStep2Header();
    updateStep2Progress();
};

const updateStep2Sidebar = () => {
    const lockedList = document.getElementById('step2LockedClassesList');
    if (!lockedList) return;

    if (bookings.length === 0) {
        lockedList.innerHTML = '<div class="step2-empty-state" style="padding: 1rem;"><div style="font-size: 0.875rem; color: #9ca3af;">Ninguna clase confirmada an</div></div>';
    } else {
        lockedList.innerHTML = bookings
            .map((booking, index) => {
                const date = new Date(booking.date + 'T12:00:00');
                const dayNames = ['Dom', 'Lun', 'Mar', 'Mi', 'Jue', 'Vie', 'Sb'];
                const monthNames = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
                const dayName = dayNames[date.getDay()].toLowerCase();
                const day = date.getDate();
                const month = monthNames[date.getMonth()];
                const timeFormatted = booking.time.replace('-', ' - ');
                const isModifying = modifyingIndex === index;
                const cardStyle = isModifying ? 'background: #eff6ff; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);' : '';

                return `
                    <div class="step2-locked-class" style="${cardStyle}">
                        <div class="step2-class-number">${index + 1}</div>
                        <div class="step2-class-info">
                            <div class="step2-class-date">${dayName} ${day} ${month}, ${timeFormatted}</div>
                        </div>
                        <div class="step2-class-actions">
                            <button class="step2-action-btn modify" onclick="step2ModifyClass(${index})">Modificar</button>
                            <button class="step2-action-btn delete" onclick="step2DeleteClass(${index})"></button>
                        </div>
                    </div>
                `;
            }).join('');

        // Scroll to the last item to keep it visible
        setTimeout(() => {
            if (lockedList.scrollHeight > lockedList.clientHeight) {
                lockedList.scrollTop = lockedList.scrollHeight;
            }
        }, 0);
    }

    // Update current selection area
    const currentSelection = document.getElementById('step2CurrentSelection');
    if (!currentSelection) return;

    if (currentClassIndex >= selectedPlan.classes && modifyingIndex === null) {
        currentSelection.innerHTML = `
            <div class="step2-empty-state">
                <div class="step2-empty-state-icon"></div>
                <div class="step2-empty-state-text">Todas las clases programadas!</div>
            </div>
        `;
        return;
    }

    if (!selectedDate) {
        currentSelection.innerHTML = `
            <div class="step2-empty-state">
                <div class="step2-empty-state-icon">${icon('calendar', 48, '')}</div>
                <div class="step2-empty-state-text">Selecciona un da en el calendario</div>
            </div>
        `;

        // Re-render lucide icons
        setTimeout(() => {
            if (window.lucide) {
                lucide.createIcons();
            }
        }, 0);
    } else {
        const date = new Date(selectedDate + 'T12:00:00');
        const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mircoles', 'Jueves', 'Viernes', 'Sbado'];
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const dayName = dayNames[date.getDay()];
        const day = date.getDate();
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear();
        const monthLower = month.toLowerCase();
        const dateStr = `${dayName} ${day} de ${monthLower}, ${year}`;

        const dayOfWeek = date.getDay();
        const slots = dayOfWeek === 6 ? timeSlots.saturday : timeSlots.weekday;
        const isSaturday = dayOfWeek === 6;

        // Get unavailable slots for this date (excluding the one being modified)
        const bookedSlotsOnDate = bookings
            .filter((b, idx) => b.date === selectedDate && idx !== modifyingIndex)
            .map(b => b.time);

        currentSelection.innerHTML = `
            <div class="step2-current-selection">
                <div class="step2-selection-date">${dateStr}</div>
                <div class="step2-time-slots">
                    ${slots.map(slot => {
                        const isBooked = bookedSlotsOnDate.includes(slot);
                        const isSelected = selectedTime === slot;
                        return `
                            <div class="step2-time-slot ${isBooked ? 'unavailable' : ''} ${isSelected ? 'selected' : ''}"
                                 onclick="${isBooked ? '' : `step2SelectTime('${slot}')`}">
                                ${slot.replace('-', ' - ')}
                            </div>
                        `;
                    }).join('')}
                    ${isSaturday ? timeSlots.saturdayUnavailable.map(slot => `
                        <div class="step2-time-slot unavailable" style="opacity: 0.5;">
                            ${slot.replace('-', ' - ')}
                        </div>
                    `).join('') : ''}
                </div>
            </div>
        `;

        // Re-render lucide icons
        setTimeout(() => {
            if (window.lucide) {
                lucide.createIcons();
            }
        }, 0);
    }
};

const updateStep2Header = () => {
    const header = document.getElementById('step2HeaderTitle');
    if (!header) return;

    if (currentClassIndex >= selectedPlan.classes) {
        header.textContent = 'Todas las Clases Programadas!';
    } else {
        header.textContent = `Selecciona Fecha y Hora para Clase ${currentClassIndex + 1}`;
    }
};

const updateStep2Progress = () => {
    const progressBar = document.getElementById('step2ProgressBar');
    if (progressBar) {
        const progress = (bookings.length / selectedPlan.classes) * 100;
        progressBar.style.width = progress + '%';
    }

    const progressCount = document.getElementById('step2ProgressCount');
    if (progressCount) {
        progressCount.textContent = `${bookings.length}/${selectedPlan.classes}`;
    }

    const continueBtn = document.getElementById('step2ContinueBtn');
    if (continueBtn) {
        const allBookingsComplete = bookings.length === selectedPlan.classes &&
                                    bookings.every(b => b.date && b.time);
        if (allBookingsComplete) {
            continueBtn.disabled = false;
            continueBtn.style.opacity = '1';
            continueBtn.style.cursor = 'pointer';
        } else {
            continueBtn.disabled = true;
            continueBtn.style.opacity = '0.5';
            continueBtn.style.cursor = 'not-allowed';
        }
    }
};

const step2PrevMonth = () => {
    calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() - 1, 1);
    renderStep2Calendar();
};

const step2NextMonth = () => {
    calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 1);
    renderStep2Calendar();
};

// =================================================================
// END NEW STEP 2 CALENDAR SYSTEM
// =================================================================

const renderStep3 = () => {
    if (!selectedPlan) {
        currentStep = 1;
        return renderStep1();
    }
    
    const originalPlanPrice = calculateOriginalPrice(selectedPlan);
    const finalPrice = calculateFinalPrice();
    const discountAmount = originalPlanPrice - selectedPlan.price;
    const getFieldClass = (field) => {
    const value = field === 'name' ? studentName :
                 field === 'email' ? studentEmail :
                 field === 'rut' ? studentRut :
                 field === 'phone' ? studentPhone : '';

    let isFilled;
    if (field === 'phone') {
        isFilled = value.length > 4;
    } else {
        isFilled = value.trim().length > 0;
    }

    const hasError = fieldErrors[field] && isFilled;

    if (hasError) {
        return 'border-2 border-red-500 bg-white text-gray-800';
    }
    else {
        return 'border-2 border-gray-300 bg-white text-gray-800';
    }
};

    return `
        <div id="step-3-content" class="step-content" style="background-color: #ffffff;">
            <h2 class="section-header">Datos del Estudiante</h2>

            <div>
                <div class="form-grid" style="row-gap: 2rem; margin-bottom: 2rem;">
                    <!-- Full Name -->
                    <div style="position: relative; margin-bottom: 0.5rem;">
                        <label class="form-label">
                            ${icon('user', 16, 'inline mr-1')} Nombre Completo <span class="text-red-500">*</span>
                        </label>
                        <div style="position: relative; max-width: 450px;">
                            <input
    type="text"
    name="name"
    autocomplete="name"
    value="${studentName}"
    oninput="updateStudentInfo('name', this.value)"
    placeholder="Juan Prez Gonzlez"
    class="form-input ${getFieldClass('name')}"
    style="padding-right: ${studentName.trim().length > 0 && !fieldErrors.name ? '2.5rem' : '0.75rem'}; max-width: 100%;"
    onblur="validateField('name'); updateFieldError('name');"
/>
                            ${studentName.trim().length > 0 && !fieldErrors.name ? `<div style="position: absolute; right: 0.75rem; top: 0; bottom: 0; display: flex; align-items: center; pointer-events: none;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#16a34a"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>` : ''}
                        </div>
                        <div style="position: absolute; height: 20px;">
                            ${fieldErrors.name && studentName.trim().length > 0 ? '<p class="text-red-500 text-xs mt-1">Debes ingresar nombre y apellido</p>' : ''}
                        </div>
                    </div>
                    
                    <!-- RUT -->
                    <div style="position: relative; margin-bottom: 0.5rem;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ${icon('credit-card', 16, 'inline mr-1')} RUT <span class="text-red-500">*</span>
                        </label>
                        <div style="position: relative; max-width: 450px;">
                            <input
    type="text"
    name="rut"
    autocomplete="id-number"
    value="${studentRut}"
    oninput="updateStudentInfo('rut', this.value)"
    onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 107 || event.charCode === 75"
    placeholder="12.345.678-9"
    maxlength="12"
    class="form-input ${getFieldClass('rut')}"
    style="padding-right: ${studentRut.trim().length > 0 && !fieldErrors.rut ? '2.5rem' : '0.75rem'}; max-width: 100%;"
    onblur="validateField('rut'); updateFieldError('rut');"
/>
                            ${studentRut.trim().length > 0 && !fieldErrors.rut ? `<div style="position: absolute; right: 0.75rem; top: 0; bottom: 0; display: flex; align-items: center; pointer-events: none;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#16a34a"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>` : ''}
                        </div>
                        <div style="position: absolute; height: 20px;">
                            ${fieldErrors.rut && studentRut.trim().length > 0 ? '<p class="text-red-500 text-xs mt-1">RUT debe tener entre 8 y 9 dgitos</p>' : ''}
                        </div>
                    </div>

                    <!-- Email -->
                    <div style="position: relative; margin-bottom: 0.5rem;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ${icon('mail', 16, 'inline mr-1')} Correo Electrnico <span class="text-red-500">*</span>
                        </label>
                        <div style="position: relative; max-width: 450px;">
                            <input
                                type="email"
                                value="${studentEmail}"
                                oninput="updateStudentInfo('email', this.value)"
                                placeholder="juan@ejemplo.com"
                                class="form-input ${getFieldClass('email')}"
                                style="padding-right: ${studentEmail.trim().length > 0 && !fieldErrors.email ? '2.5rem' : '0.75rem'}; max-width: 100%;"
                                onblur="validateField('email'); updateFieldError('email');"
                            />
                            ${studentEmail.trim().length > 0 && !fieldErrors.email ? `<div style="position: absolute; right: 0.75rem; top: 0; bottom: 0; display: flex; align-items: center; pointer-events: none;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#16a34a"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>` : ''}
                        </div>
                        <div style="position: absolute; height: 20px;">
                            ${fieldErrors.email && studentEmail.trim().length > 0 ? '<p class="text-red-500 text-xs mt-1">Correo invlido</p>' : ''}
                        </div>
                    </div>

                    <!-- Phone -->
<div style="position: relative; margin-bottom: 0.5rem;">
    <label class="block text-sm font-medium text-gray-700 mb-2">
        ${icon('phone', 16, 'inline mr-1')} Telfono <span class="text-red-500">*</span>
    </label>
    <div style="position: relative; max-width: 450px;">
        <input
    type="tel"
    name="phone"
    autocomplete="tel"
    value="${studentPhone}"
    oninput="updateStudentInfo('phone', this.value)"
    onkeydown="handlePhoneKeydown(event, this)"
    onselect="handlePhoneSelect(event, this)"
    onclick="handlePhoneClick(event, this)"
    maxlength="15"
    placeholder="+56 9 1234 5678"
    class="form-input ${getFieldClass('phone')}"
    style="padding-right: ${(() => { const cp = studentPhone.replace(/\+56\s?/g, '').replace(/\s/g, ''); return /^9\d{8}$/.test(cp) && !fieldErrors.phone ? '2.5rem' : '0.75rem'; })()}; max-width: 100%;"
    onblur="validateField('phone'); updateFieldError('phone');"
/>
        ${(() => { const cp = studentPhone.replace(/\+56\s?/g, '').replace(/\s/g, ''); return /^9\d{8}$/.test(cp) && !fieldErrors.phone ? `<div style="position: absolute; right: 0.75rem; top: 0; bottom: 0; display: flex; align-items: center; pointer-events: none;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#16a34a"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>` : ''; })()}
    </div>
    <div style="position: absolute; height: 20px;">
        ${fieldErrors.phone && studentPhone.length > 4 ? '<p class="text-red-500 text-xs mt-1">Debe tener exactamente 9 dgitos</p>' : ''}
    </div>
</div>
                    
                    <!-- Reminder Checkbox -->
<div style="max-width: 450px;">
    <label class="block text-sm font-medium text-gray-700 mb-2">
        ${icon('bell', 16, 'inline mr-1')} Recordatorio
    </label>
    <div class="w-full p-3 rounded-lg flex items-center gap-3 bg-gray-100" style="min-height: 52px; border: 2px solid #d1d5db;">
        <input
            type="checkbox"
            id="reminder-checkbox"
            ${wantsReminder ? 'checked' : ''}
            onchange="updateStudentInfo('reminder', this.checked)"
            class="w-5 h-5 text-blue-500 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer flex-shrink-0"
            style="margin: 0;"
        />
        <span class="text-sm font-medium text-gray-700 flex-1" style="margin: 0; line-height: 1.3;">
            Deseas recibir un recordatorio antes de tu clase?
        </span>
    </div>
</div>
            </div>

            <div class="nav-button-container" style="margin-top: 2rem;">
                <button onclick="goToPrevStep()" class="nav-button back" style="border: none; background: none; padding: 0;">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="margin-bottom: 1px;"><path d="M10 2L4 8l6 6V2z"/></svg> <span>Modificar Horarios</span>
                </button>
                <button onclick="goToNextStep()" class="nav-button next" id="step3ContinueBtn">
                    <span>Continuar a Pago</span> <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="margin-bottom: 1px;"><path d="M6 2l6 6-6 6V2z"/></svg>
                </button>
            </div>
        </div>
    `;
};

const renderStep4 = () => {
    if (!selectedPlan) {
        currentStep = 1;
        return renderStep1();
    }

    const originalPlanPrice = calculateOriginalPrice(selectedPlan);
    const finalPrice = calculateFinalPrice();
    const discountAmount = originalPlanPrice - selectedPlan.price;

    return `
        <div id="step-4-content" class="step-content" style="background-color: #ffffff;">
            <h2 class="section-header">Resumen y Pago</h2>

            <div class="p-6 rounded-xl" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 2px solid #e2e8f0; width: 90%; margin: 0 auto;">
                <div style="border-radius: 0.5rem; border: 1px solid #d1d5db; overflow: hidden; margin-bottom: 2rem;">
                    <div style="background: #f3f4f6; padding: 0.75rem 1rem; border-bottom: 2px solid #3b82f6;">
                        <h4 style="margin: 0; font-size: 0.875rem; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                            ${icon('clipboard-list', 16, 'text-blue-600')}
                            <span>Resumen de tu Reserva</span>
                        </h4>
                    </div>
                    <div style="overflow-x: auto; background: white;">
        <table style="width: 100%; border-collapse: collapse; background: white;">
            <thead>
                <tr style="background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                    <th style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.8125rem; color: #374151; width: 10%;">Clase</th>
                    <th style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.8125rem; color: #374151; width: 15%;">Da</th>
                    <th style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.8125rem; color: #374151; width: 30%;">Fecha</th>
                    <th style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.8125rem; color: #374151; width: 20%;">Horario</th>
                    <th style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 600; font-size: 0.8125rem; color: #374151; width: 25%;">Profesor</th>
                </tr>
            </thead>
            <tbody>
                ${bookings
    .map((booking, originalIndex) => ({ booking, originalIndex }))
    .filter(item => item.booking.date)
    .sort((a, b) => {
        // Sort by date, then by time
        if (a.booking.date !== b.booking.date) {
            return new Date(a.booking.date) - new Date(b.booking.date);
        }
        // If same date, sort by time
        const timeA = a.booking.time ? a.booking.time.split('-')[0] : '00:00';
        const timeB = b.booking.time ? b.booking.time.split('-')[0] : '00:00';
        return timeA.localeCompare(timeB);
    })
    .map((item, sortedIndex) => {
        const booking = item.booking;
        const date = new Date(booking.date + 'T12:00:00');
        const dayName = date.toLocaleDateString('es-CL', { weekday: 'long' });
        const day = date.getDate();
        const month = date.toLocaleDateString('es-CL', { month: 'long' });
        const year = date.getFullYear();

        return `
        <tr style="background: #ffffff; border-bottom: 1px solid #e5e7eb; transition: background-color 0.15s;">
            <td style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 500; color: #374151; font-size: 0.8125rem;">${sortedIndex + 1}</td>
                        <td style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 500; color: #374151; font-size: 0.8125rem; text-transform: capitalize;">${dayName}</td>
                        <td style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 500; color: #374151; font-size: 0.8125rem;">${day} de ${month} de ${year}</td>
                        <td style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 500; color: #374151; font-size: 0.8125rem;">
                            <span style="display: inline-flex; align-items: center; gap: 0.375rem; justify-content: center;">
                                ${icon('clock', 14, 'text-amber-600')}
                                ${booking.time ? booking.time : 'Pendiente'}
                            </span>
                        </td>
                        <td style="padding: 0.625rem 0.75rem; text-align: center; font-weight: 500; color: #374151; font-size: 0.8125rem;">
                            <span style="display: inline-flex; align-items: center; gap: 0.375rem; justify-content: center;">
                                ${icon('user', 14, 'text-amber-600')}
                                Alexis Inostroza Daz
                            </span>
                        </td>
                    </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    </div>
                </div>

                <div style="border-radius: 0.5rem; border: 1px solid #d1d5db; overflow: hidden; margin-bottom: 2rem;">
                    <div style="background: #f3f4f6; padding: 0.75rem 1rem; border-bottom: 2px solid #3b82f6;">
                        <h4 style="margin: 0; font-size: 0.875rem; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                            ${icon('wallet', 16, 'text-blue-600')}
                            <span>Detalle de Pago</span>
                        </h4>
                    </div>

                    <div style="background: white;">
                        <div class="flex justify-between" style="padding: 0.625rem 0.75rem; border-bottom: 1px solid #e5e7eb;">
                            <span style="color: #6b7280; font-size: 0.8125rem; font-weight: 500;">Plan seleccionado</span>
                            <span style="font-weight: 500; color: #374151; font-size: 0.8125rem;">${selectedPlan.classes} ${selectedPlan.classes === 1 ? 'clase' : 'clases'}</span>
                        </div>

                        <div class="flex justify-between" style="padding: 0.625rem 0.75rem; border-bottom: 1px solid #e5e7eb;">
                            <span style="color: #6b7280; font-size: 0.8125rem; font-weight: 500;">Precio base</span>
                            <span style="font-weight: 500; color: #374151; font-size: 0.8125rem;">${formatCurrency(originalPlanPrice)}</span>
                        </div>

                        <div class="flex justify-between" style="padding: 0.625rem 0.75rem; border-bottom: 1px solid #e5e7eb;">
                            <span style="color: #6b7280; font-size: 0.8125rem; font-weight: 500;">Ahorro por plan</span>
                            <span style="font-weight: 500; color: ${selectedPlan.savings > 0 ? '#16a34a' : '#6b7280'}; font-size: 0.8125rem;">${selectedPlan.savings > 0 ? `- ${formatCurrency(discountAmount)}` : 'No aplica'}</span>
                        </div>

                        <div class="flex justify-between items-center" style="padding: 0.875rem 0.75rem; background: #fafaf9;">
                            <span style="font-size: 0.875rem; font-weight: 700; color: #111827;">Total a pagar</span>
                            <span style="font-size: 1rem; font-weight: 700; color: #111827;">${formatCurrency(finalPrice)}</span>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 0;">
                    <div style="background: #f3f4f6; padding: 0.75rem 1rem; border-radius: 0.5rem 0.5rem 0 0; border: 1px solid #d1d5db; border-bottom: 2px solid #3b82f6;">
                        <h4 style="margin: 0; font-size: 0.875rem; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                            ${icon('credit-card', 16, 'text-blue-600')}
                            <span>Mtodo de Pago</span>
                        </h4>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; padding: 1.25rem; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 0.5rem 0.5rem;">
                        <button
                            onclick="selectPaymentMethod('webpay')"
                            class="payment-method-btn ${paymentMethod === 'webpay' ? 'selected' : ''}"
                            style="position: relative; padding: 1.5rem 1rem; border: 2px solid ${paymentMethod === 'webpay' ? '#3b82f6' : '#d1d5db'}; border-radius: 0.5rem; background: ${paymentMethod === 'webpay' ? '#eff6ff' : 'white'}; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 110px; box-shadow: ${paymentMethod === 'webpay' ? '0 2px 8px rgba(59, 130, 246, 0.2)' : '0 1px 3px rgba(0,0,0,0.05)'};"
                            onmouseover="if('${paymentMethod}' !== 'webpay') this.style.borderColor='#9ca3af'; if('${paymentMethod}' !== 'webpay') this.style.boxShadow='0 2px 6px rgba(0,0,0,0.1)';"
                            onmouseout="if('${paymentMethod}' !== 'webpay') this.style.borderColor='#d1d5db'; if('${paymentMethod}' !== 'webpay') this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)';"
                        >
                            ${paymentMethod === 'webpay' ? `<div style="position: absolute; top: 0.5rem; right: 0.5rem; background: #3b82f6; color: white; border-radius: 9999px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div>` : ''}
                            <img src="/assets/logo/webpay.png" alt="Webpay" style="max-height: 50px; max-width: 100%; object-fit: contain; margin-bottom: 0.625rem;" />
                            <span style="font-size: 0.8125rem; font-weight: 600; color: ${paymentMethod === 'webpay' ? '#1e40af' : '#6b7280'};">Pago en Lnea</span>
                            <span style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">Dbito o Crdito</span>
                        </button>
                        <button
                            onclick="selectPaymentMethod('transferencia')"
                            class="payment-method-btn ${paymentMethod === 'transferencia' ? 'selected' : ''}"
                            style="position: relative; padding: 1.5rem 1rem; border: 2px solid ${paymentMethod === 'transferencia' ? '#3b82f6' : '#d1d5db'}; border-radius: 0.5rem; background: ${paymentMethod === 'transferencia' ? '#eff6ff' : 'white'}; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 110px; box-shadow: ${paymentMethod === 'transferencia' ? '0 2px 8px rgba(59, 130, 246, 0.2)' : '0 1px 3px rgba(0,0,0,0.05)'};"
                            onmouseover="if('${paymentMethod}' !== 'transferencia') this.style.borderColor='#9ca3af'; if('${paymentMethod}' !== 'transferencia') this.style.boxShadow='0 2px 6px rgba(0,0,0,0.1)';"
                            onmouseout="if('${paymentMethod}' !== 'transferencia') this.style.borderColor='#d1d5db'; if('${paymentMethod}' !== 'transferencia') this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)';"
                        >
                            ${paymentMethod === 'transferencia' ? `<div style="position: absolute; top: 0.5rem; right: 0.5rem; background: #3b82f6; color: white; border-radius: 9999px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div>` : ''}
                            <img src="/assets/logo/transferencia.png" alt="Transferencia Bancaria" style="max-height: 50px; max-width: 100%; object-fit: contain; margin-bottom: 0.625rem;" />
                            <span style="font-size: 0.8125rem; font-weight: 600; color: ${paymentMethod === 'transferencia' ? '#1e40af' : '#6b7280'};">Transferencia</span>
                            <span style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">Bancaria</span>
                        </button>
                    </div>
                </div>
            </div>

            <div style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border: 2px solid #facc15; border-radius: 0.75rem; padding: 1.25rem; margin-top: 2rem; width: 90%; margin-left: auto; margin-right: auto; box-shadow: 0 2px 4px rgba(250, 204, 21, 0.1);">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="flex-shrink: 0;">
                        ${icon('shield-check', 20, 'text-yellow-700')}
                    </div>
                    <p style="margin: 0; font-size: 0.875rem; line-height: 1.5; color: #713f12;">
                        Antes de continuar, asegrate de conocer las polticas de cancelacin y reagendamiento en los <a href="/pages/soporte/terms.html" target="_blank" rel="noopener noreferrer" style="text-decoration: underline; font-weight: 700; color: #854d0e;">trminos y condiciones</a>.
                    </p>
                </div>
            </div>

            <div class="nav-button-container" style="margin-top: 1.5rem;">
                <button onclick="goToPrevStep()" class="nav-button back" style="border: none; background: none; padding: 0;">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="margin-bottom: 1px;"><path d="M10 2L4 8l6 6V2z"/></svg> <span>Modificar Datos</span>
                </button>
                <button onclick="handleConfirmPayment()"
                    class="nav-button next"
                >
                    <span>Pagar ${formatCurrency(finalPrice)}</span> <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="margin-bottom: 1px;"><path d="M6 2l6 6-6 6V2z"/></svg>
                </button>
            </div>
        </div>
    `;
};

const renderStep = (step, shouldAnimate = false) => {
    let content = '';
    document.removeEventListener('click', handleCalendarClickOutside);
    if (step === 1) {
        content = renderStep1();
    } else if (step === 2) {
        content = renderStep2();
    } else if (step === 3) {
        content = renderStep3();
    } else if (step === 4) {
        content = renderStep4();
    }
    const container = document.querySelector('#booking-system-container .max-w-6xl');
    if (container) {
        container.innerHTML = `${renderHeader()}<div id="booking-system-content">${content}</div>`;
    } else {

    document.getElementById('booking-system-container').innerHTML = `
        <div class="min-h-screen py-12 px-4"> 
            <div class="max-w-6xl mx-auto rounded-2xl shadow-xl" style="background-color: #fff;">
                ${renderHeader()}
                <div id="booking-system-content">${content}</div>
            </div>
        </div>
    `;
}
    if (shouldAnimate) {
        scrollToTop();
    }
    lucide.createIcons();
    if (step === 2 && activeCalendar !== null) {
        setTimeout(() => {
            document.addEventListener('click', handleCalendarClickOutside);
        }, 100);
    }

    if (step === 3) {
        setTimeout(() => {
            updateStep3Button();
        }, 0);
    }

    // Ensure icons are rendered even if lucide hasn't fully initialized
    setTimeout(() => {
        if (window.lucide) {
            lucide.createIcons();
        }
    }, 100);
};
const renderApp = () => {
    const container = document.getElementById('booking-system-container');
    container.innerHTML = `
        <div class="min-h-screen py-12 px-4"> 
            <div class="max-w-6xl mx-auto rounded-2xl shadow-xl" style="background-color: #fff;">
                ${renderHeader()}
                <div id="booking-system-content"></div>
            </div>
        </div>
    `;
    renderStep(currentStep);
};
document.addEventListener('DOMContentLoaded', () => {
    renderApp();

    const initIcons = () => {
        if (window.lucide) {
            lucide.createIcons();
        }
    };

    if (window.lucide) {
        initIcons();
    } else {
        const checkLucide = setInterval(() => {
            if (window.lucide) {
                clearInterval(checkLucide);
                initIcons();
            }
        }, 50);

        setTimeout(() => clearInterval(checkLucide), 3000);
    }
});

</script>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

<script src="../../js/layout.js"></script>
<script src="../../js/script.js" defer></script>

</body>
</html>
